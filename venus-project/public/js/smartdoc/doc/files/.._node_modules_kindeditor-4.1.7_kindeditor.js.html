<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\node_modules\kindeditor-4.1.7\kindeditor.js - SmartDoc</title>
  
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-smart">
 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
               <a class="navbar-brand mainlogo" href="https://github.com/zhh77/smartdoc">
             
            <img alt="SmartDoc" src="../assets/css/logo.png" title="SmartDoc">
            
                SmartDoc
          </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                 <ul class="nav navbar-nav">
                    
                    <li><a href="https://github.com/zhh77/smartdoc">Home</a>
                    </li>
                    
                    <li><a href="/">Document</a>
                    </li>
                    
                    <li><a href="https://github.com/zhh77/smartdoc">About</a>
                    </li>
                    
                </ul>
               <div class="navbar-form navbar-right filterAPi" autocomplete="off">
                <input type="text" id='txtSearchAPI' class="form-control search-query" placeholder="Search for API" />
                 <ul id="filterList" class="filterItems dropdown-menu" role="menu"></ul>
                </div>
            </div>
        </div>
    </nav>
    <div id="sidebar">
    <h3>Modules/Classes</h3>
        <div id="api-tabview-filter">
            <input id='txtSearch' type="search" class="form-control" placeholder="Type to filter Modules/Classes">
        </div>
        <dl id="sidebar_list">
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/273.html">273</a>
                </dt>
                <dd>
                    <ul>
                   
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/alienjs.html">alienjs</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/window.require.html">window.require</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Countdown.html">Countdown</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/Date.html">Date</a>
                </dt>
                <dd>
                    <ul>
                   
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/jquery.html">jquery</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/jquery.transitionEnd.html">jquery.transitionEnd</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.support.transition.html">jquery.support.transition</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.animationEnd.html">jquery.animationEnd</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/jquery-ui.html">jquery-ui</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/jquery.ajaxPanel.html">jquery.ajaxPanel</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.dialog.html">jquery.dialog</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Array.html">Array</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.browserLowVersion.html">jquery.browserLowVersion</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.confirm.html">jquery.confirm</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/jquery.alert.html">jquery.alert</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/ng.html">ng</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/EventEmitter Manages event registering and emitting..html">EventEmitter Manages event registering and emitting.</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/ngMock.html">ngMock</a>
                </dt>
                <dd>
                    <ul>
                   
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/ngMockE2E.html">ngMockE2E</a>
                </dt>
                <dd>
                    <ul>
                   
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/ui.html">ui</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/AjaxPanel.html">AjaxPanel</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Date.Dialog.html">Date.Dialog</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/WebUploader.html">WebUploader</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/Base.html">Base</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Mediator.html">Mediator</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/options.Uploader.html">options.Uploader</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/File.File.html">File.File</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/File.Queue.html">File.Queue</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Uploader.html">Uploader</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/window.html">window</a>
                </dt>
                <dd>
                    <ul>
                   
                    </ul>
                </dd>
             
        </dl>
</div>
   
    <div class="stdoc-content">
        <!--     <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>

 -->
        <div class="apidocs">
            <div id="docs-main">
                <div class="content">
                    <div class="page-header">
    <h1>..\node_modules\kindeditor-4.1.7\kindeditor.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums" id='src_code'>
/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2013 kindsoft.net
*
* @author Roddy &lt;luolonghao@gmail.com&gt;
* @website http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
* @version 4.1.7 (2013-04-21)
*******************************************************************************/
(function (window, undefined) {
	if (window.KindEditor) {
		return;
	}
if (!window.console) {
	window.console = {};
}
if (!console.log) {
	console.log = function () {};
}
var _VERSION = &#x27;4.1.7 (2013-04-21)&#x27;,
	_ua = navigator.userAgent.toLowerCase(),
	_IE = _ua.indexOf(&#x27;msie&#x27;) &gt; -1 &amp;&amp; _ua.indexOf(&#x27;opera&#x27;) == -1,
	_GECKO = _ua.indexOf(&#x27;gecko&#x27;) &gt; -1 &amp;&amp; _ua.indexOf(&#x27;khtml&#x27;) == -1,
	_WEBKIT = _ua.indexOf(&#x27;applewebkit&#x27;) &gt; -1,
	_OPERA = _ua.indexOf(&#x27;opera&#x27;) &gt; -1,
	_MOBILE = _ua.indexOf(&#x27;mobile&#x27;) &gt; -1,
	_IOS = /ipad|iphone|ipod/.test(_ua),
	_QUIRKS = document.compatMode != &#x27;CSS1Compat&#x27;,
	_matches = /(?:msie|firefox|webkit|opera)[\/:\s](\d+)/.exec(_ua),
	_V = _matches ? _matches[1] : &#x27;0&#x27;,
	_TIME = new Date().getTime();
function _isArray(val) {
	if (!val) {
		return false;
	}
	return Object.prototype.toString.call(val) === &#x27;[object Array]&#x27;;
}
function _isFunction(val) {
	if (!val) {
		return false;
	}
	return Object.prototype.toString.call(val) === &#x27;[object Function]&#x27;;
}
function _inArray(val, arr) {
	for (var i = 0, len = arr.length; i &lt; len; i++) {
		if (val === arr[i]) {
			return i;
		}
	}
	return -1;
}
function _each(obj, fn) {
	if (_isArray(obj)) {
		for (var i = 0, len = obj.length; i &lt; len; i++) {
			if (fn.call(obj[i], i, obj[i]) === false) {
				break;
			}
		}
	} else {
		for (var key in obj) {
			if (obj.hasOwnProperty(key)) {
				if (fn.call(obj[key], key, obj[key]) === false) {
					break;
				}
			}
		}
	}
}
function _trim(str) {
	return str.replace(/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g, &#x27;&#x27;);
}
function _inString(val, str, delimiter) {
	delimiter = delimiter === undefined ? &#x27;,&#x27; : delimiter;
	return (delimiter + str + delimiter).indexOf(delimiter + val + delimiter) &gt;= 0;
}
function _addUnit(val, unit) {
	unit = unit || &#x27;px&#x27;;
	return val &amp;&amp; /^\d+$/.test(val) ? val + unit : val;
}
function _removeUnit(val) {
	var match;
	return val &amp;&amp; (match = /(\d+)/.exec(val)) ? parseInt(match[1], 10) : 0;
}
function _escape(val) {
	return val.replace(/&amp;/g, &#x27;&amp;amp;&#x27;).replace(/&lt;/g, &#x27;&amp;lt;&#x27;).replace(/&gt;/g, &#x27;&amp;gt;&#x27;).replace(/&quot;/g, &#x27;&amp;quot;&#x27;);
}
function _unescape(val) {
	return val.replace(/&amp;lt;/g, &#x27;&lt;&#x27;).replace(/&amp;gt;/g, &#x27;&gt;&#x27;).replace(/&amp;quot;/g, &#x27;&quot;&#x27;).replace(/&amp;amp;/g, &#x27;&amp;&#x27;);
}
function _toCamel(str) {
	var arr = str.split(&#x27;-&#x27;);
	str = &#x27;&#x27;;
	_each(arr, function(key, val) {
		str += (key &gt; 0) ? val.charAt(0).toUpperCase() + val.substr(1) : val;
	});
	return str;
}
function _toHex(val) {
	function hex(d) {
		var s = parseInt(d, 10).toString(16).toUpperCase();
		return s.length &gt; 1 ? s : &#x27;0&#x27; + s;
	}
	return val.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/ig,
		function($0, $1, $2, $3) {
			return &#x27;#&#x27; + hex($1) + hex($2) + hex($3);
		}
	);
}
function _toMap(val, delimiter) {
	delimiter = delimiter === undefined ? &#x27;,&#x27; : delimiter;
	var map = {}, arr = _isArray(val) ? val : val.split(delimiter), match;
	_each(arr, function(key, val) {
		if ((match = /^(\d+)\.\.(\d+)$/.exec(val))) {
			for (var i = parseInt(match[1], 10); i &lt;= parseInt(match[2], 10); i++) {
				map[i.toString()] = true;
			}
		} else {
			map[val] = true;
		}
	});
	return map;
}
function _toArray(obj, offset) {
	return Array.prototype.slice.call(obj, offset || 0);
}
function _undef(val, defaultVal) {
	return val === undefined ? defaultVal : val;
}
function _invalidUrl(url) {
	return !url || /[&lt;&gt;&quot;]/.test(url);
}
function _addParam(url, param) {
	return url.indexOf(&#x27;?&#x27;) &gt;= 0 ? url + &#x27;&amp;&#x27; + param : url + &#x27;?&#x27; + param;
}
function _extend(child, parent, proto) {
	if (!proto) {
		proto = parent;
		parent = null;
	}
	var childProto;
	if (parent) {
		var fn = function () {};
		fn.prototype = parent.prototype;
		childProto = new fn();
		_each(proto, function(key, val) {
			childProto[key] = val;
		});
	} else {
		childProto = proto;
	}
	childProto.constructor = child;
	child.prototype = childProto;
	child.parent = parent ? parent.prototype : null;
}
function _json(text) {
	var match;
	if ((match = /\{[\s\S]*\}|\[[\s\S]*\]/.exec(text))) {
		text = match[0];
	}
	var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
	cx.lastIndex = 0;
	if (cx.test(text)) {
		text = text.replace(cx, function (a) {
			return &#x27;\\u&#x27; + (&#x27;0000&#x27; + a.charCodeAt(0).toString(16)).slice(-4);
		});
	}
	if (/^[\],:{}\s]*$/.
	test(text.replace(/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g, &#x27;@&#x27;).
	replace(/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, &#x27;]&#x27;).
	replace(/(?:^|:|,)(?:\s*\[)+/g, &#x27;&#x27;))) {
		return eval(&#x27;(&#x27; + text + &#x27;)&#x27;);
	}
	throw &#x27;JSON parse error&#x27;;
}
var _round = Math.round;
var K = {
	DEBUG : false,
	VERSION : _VERSION,
	IE : _IE,
	GECKO : _GECKO,
	WEBKIT : _WEBKIT,
	OPERA : _OPERA,
	V : _V,
	TIME : _TIME,
	each : _each,
	isArray : _isArray,
	isFunction : _isFunction,
	inArray : _inArray,
	inString : _inString,
	trim : _trim,
	addUnit : _addUnit,
	removeUnit : _removeUnit,
	escape : _escape,
	unescape : _unescape,
	toCamel : _toCamel,
	toHex : _toHex,
	toMap : _toMap,
	toArray : _toArray,
	undef : _undef,
	invalidUrl : _invalidUrl,
	addParam : _addParam,
	extend : _extend,
	json : _json
};
var _INLINE_TAG_MAP = _toMap(&#x27;a,abbr,acronym,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,img,input,ins,kbd,label,map,q,s,samp,select,small,span,strike,strong,sub,sup,textarea,tt,u,var&#x27;),
	_BLOCK_TAG_MAP = _toMap(&#x27;address,applet,blockquote,body,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,head,hr,html,iframe,ins,isindex,li,map,menu,meta,noframes,noscript,object,ol,p,pre,script,style,table,tbody,td,tfoot,th,thead,title,tr,ul&#x27;),
	_SINGLE_TAG_MAP = _toMap(&#x27;area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed&#x27;),
	_STYLE_TAG_MAP = _toMap(&#x27;b,basefont,big,del,em,font,i,s,small,span,strike,strong,sub,sup,u&#x27;),
	_CONTROL_TAG_MAP = _toMap(&#x27;img,table,input,textarea,button&#x27;),
	_PRE_TAG_MAP = _toMap(&#x27;pre,style,script&#x27;),
	_NOSPLIT_TAG_MAP = _toMap(&#x27;html,head,body,td,tr,table,ol,ul,li&#x27;),
	_AUTOCLOSE_TAG_MAP = _toMap(&#x27;colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr&#x27;),
	_FILL_ATTR_MAP = _toMap(&#x27;checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected&#x27;),
	_VALUE_TAG_MAP = _toMap(&#x27;input,button,textarea,select&#x27;);
function _getBasePath() {
	var els = document.getElementsByTagName(&#x27;script&#x27;), src;
	for (var i = 0, len = els.length; i &lt; len; i++) {
		src = els[i].src || &#x27;&#x27;;
		if (/kindeditor[\w\-\.]*\.js/.test(src)) {
			return src.substring(0, src.lastIndexOf(&#x27;/&#x27;) + 1);
		}
	}
	return &#x27;&#x27;;
}
K.basePath = _getBasePath();
K.options = {
	designMode : true,
	fullscreenMode : false,
	filterMode : true,
	wellFormatMode : true,
	shadowMode : true,
	loadStyleMode : true,
	basePath : K.basePath,
	themesPath : K.basePath + &#x27;themes/&#x27;,
	langPath : K.basePath + &#x27;lang/&#x27;,
	pluginsPath : K.basePath + &#x27;plugins/&#x27;,
	themeType : &#x27;default&#x27;,
	langType : &#x27;zh_CN&#x27;,
	urlType : &#x27;&#x27;,
	newlineTag : &#x27;p&#x27;,
	resizeType : 2,
	syncType : &#x27;form&#x27;,
	pasteType : 2,
	dialogAlignType : &#x27;page&#x27;,
	useContextmenu : true,
	fullscreenShortcut : false,
	bodyClass : &#x27;ke-content&#x27;,
	indentChar : &#x27;\t&#x27;,
	cssPath : &#x27;&#x27;,
	cssData : &#x27;&#x27;,
	minWidth : 650,
	minHeight : 100,
	minChangeSize : 50,
	zIndex : 811213,
	items : [
		&#x27;source&#x27;, &#x27;|&#x27;, &#x27;undo&#x27;, &#x27;redo&#x27;, &#x27;|&#x27;, &#x27;preview&#x27;, &#x27;print&#x27;, &#x27;template&#x27;, &#x27;code&#x27;, &#x27;cut&#x27;, &#x27;copy&#x27;, &#x27;paste&#x27;,
		&#x27;plainpaste&#x27;, &#x27;wordpaste&#x27;, &#x27;|&#x27;, &#x27;justifyleft&#x27;, &#x27;justifycenter&#x27;, &#x27;justifyright&#x27;,
		&#x27;justifyfull&#x27;, &#x27;insertorderedlist&#x27;, &#x27;insertunorderedlist&#x27;, &#x27;indent&#x27;, &#x27;outdent&#x27;, &#x27;subscript&#x27;,
		&#x27;superscript&#x27;, &#x27;clearhtml&#x27;, &#x27;quickformat&#x27;, &#x27;selectall&#x27;, &#x27;|&#x27;, &#x27;fullscreen&#x27;, &#x27;/&#x27;,
		&#x27;formatblock&#x27;, &#x27;fontname&#x27;, &#x27;fontsize&#x27;, &#x27;|&#x27;, &#x27;forecolor&#x27;, &#x27;hilitecolor&#x27;, &#x27;bold&#x27;,
		&#x27;italic&#x27;, &#x27;underline&#x27;, &#x27;strikethrough&#x27;, &#x27;lineheight&#x27;, &#x27;removeformat&#x27;, &#x27;|&#x27;, &#x27;image&#x27;, &#x27;multiimage&#x27;,
		&#x27;flash&#x27;, &#x27;media&#x27;, &#x27;insertfile&#x27;, &#x27;table&#x27;, &#x27;hr&#x27;, &#x27;emoticons&#x27;, &#x27;baidumap&#x27;, &#x27;pagebreak&#x27;,
		&#x27;anchor&#x27;, &#x27;link&#x27;, &#x27;unlink&#x27;, &#x27;|&#x27;, &#x27;about&#x27;
	],
	noDisableItems : [&#x27;source&#x27;, &#x27;fullscreen&#x27;],
	colorTable : [
		[&#x27;#E53333&#x27;, &#x27;#E56600&#x27;, &#x27;#FF9900&#x27;, &#x27;#64451D&#x27;, &#x27;#DFC5A4&#x27;, &#x27;#FFE500&#x27;],
		[&#x27;#009900&#x27;, &#x27;#006600&#x27;, &#x27;#99BB00&#x27;, &#x27;#B8D100&#x27;, &#x27;#60D978&#x27;, &#x27;#00D5FF&#x27;],
		[&#x27;#337FE5&#x27;, &#x27;#003399&#x27;, &#x27;#4C33E5&#x27;, &#x27;#9933E5&#x27;, &#x27;#CC33E5&#x27;, &#x27;#EE33EE&#x27;],
		[&#x27;#FFFFFF&#x27;, &#x27;#CCCCCC&#x27;, &#x27;#999999&#x27;, &#x27;#666666&#x27;, &#x27;#333333&#x27;, &#x27;#000000&#x27;]
	],
	fontSizeTable : [&#x27;9px&#x27;, &#x27;10px&#x27;, &#x27;12px&#x27;, &#x27;14px&#x27;, &#x27;16px&#x27;, &#x27;18px&#x27;, &#x27;24px&#x27;, &#x27;32px&#x27;],
	htmlTags : {
		font : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;color&#x27;, &#x27;size&#x27;, &#x27;face&#x27;, &#x27;.background-color&#x27;],
		span : [
			&#x27;id&#x27;, &#x27;class&#x27;, &#x27;.color&#x27;, &#x27;.background-color&#x27;, &#x27;.font-size&#x27;, &#x27;.font-family&#x27;, &#x27;.background&#x27;,
			&#x27;.font-weight&#x27;, &#x27;.font-style&#x27;, &#x27;.text-decoration&#x27;, &#x27;.vertical-align&#x27;, &#x27;.line-height&#x27;
		],
		div : [
			&#x27;id&#x27;, &#x27;class&#x27;, &#x27;align&#x27;, &#x27;.border&#x27;, &#x27;.margin&#x27;, &#x27;.padding&#x27;, &#x27;.text-align&#x27;, &#x27;.color&#x27;,
			&#x27;.background-color&#x27;, &#x27;.font-size&#x27;, &#x27;.font-family&#x27;, &#x27;.font-weight&#x27;, &#x27;.background&#x27;,
			&#x27;.font-style&#x27;, &#x27;.text-decoration&#x27;, &#x27;.vertical-align&#x27;, &#x27;.margin-left&#x27;
		],
		table: [
			&#x27;id&#x27;, &#x27;class&#x27;, &#x27;border&#x27;, &#x27;cellspacing&#x27;, &#x27;cellpadding&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, &#x27;align&#x27;, &#x27;bordercolor&#x27;,
			&#x27;.padding&#x27;, &#x27;.margin&#x27;, &#x27;.border&#x27;, &#x27;bgcolor&#x27;, &#x27;.text-align&#x27;, &#x27;.color&#x27;, &#x27;.background-color&#x27;,
			&#x27;.font-size&#x27;, &#x27;.font-family&#x27;, &#x27;.font-weight&#x27;, &#x27;.font-style&#x27;, &#x27;.text-decoration&#x27;, &#x27;.background&#x27;,
			&#x27;.width&#x27;, &#x27;.height&#x27;, &#x27;.border-collapse&#x27;
		],
		&#x27;td,th&#x27;: [
			&#x27;id&#x27;, &#x27;class&#x27;, &#x27;align&#x27;, &#x27;valign&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, &#x27;colspan&#x27;, &#x27;rowspan&#x27;, &#x27;bgcolor&#x27;,
			&#x27;.text-align&#x27;, &#x27;.color&#x27;, &#x27;.background-color&#x27;, &#x27;.font-size&#x27;, &#x27;.font-family&#x27;, &#x27;.font-weight&#x27;,
			&#x27;.font-style&#x27;, &#x27;.text-decoration&#x27;, &#x27;.vertical-align&#x27;, &#x27;.background&#x27;, &#x27;.border&#x27;
		],
		a : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;href&#x27;, &#x27;target&#x27;, &#x27;name&#x27;],
		embed : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;src&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, &#x27;type&#x27;, &#x27;loop&#x27;, &#x27;autostart&#x27;, &#x27;quality&#x27;, &#x27;.width&#x27;, &#x27;.height&#x27;, &#x27;align&#x27;, &#x27;allowscriptaccess&#x27;],
		img : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;src&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, &#x27;border&#x27;, &#x27;alt&#x27;, &#x27;title&#x27;, &#x27;align&#x27;, &#x27;.width&#x27;, &#x27;.height&#x27;, &#x27;.border&#x27;],
		&#x27;p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6&#x27; : [
			&#x27;id&#x27;, &#x27;class&#x27;, &#x27;align&#x27;, &#x27;.text-align&#x27;, &#x27;.color&#x27;, &#x27;.background-color&#x27;, &#x27;.font-size&#x27;, &#x27;.font-family&#x27;, &#x27;.background&#x27;,
			&#x27;.font-weight&#x27;, &#x27;.font-style&#x27;, &#x27;.text-decoration&#x27;, &#x27;.vertical-align&#x27;, &#x27;.text-indent&#x27;, &#x27;.margin-left&#x27;
		],
		pre : [&#x27;id&#x27;, &#x27;class&#x27;],
		hr : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;.page-break-after&#x27;],
		&#x27;br,tbody,tr,strong,b,sub,sup,em,i,u,strike,s,del&#x27; : [&#x27;id&#x27;, &#x27;class&#x27;],
		iframe : [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;src&#x27;, &#x27;frameborder&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, &#x27;.width&#x27;, &#x27;.height&#x27;]
	},
	layout : &#x27;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;toolbar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;edit&quot;&gt;&lt;/div&gt;&lt;div class=&quot;statusbar&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#x27;
};
var _useCapture = false;
var _INPUT_KEY_MAP = _toMap(&#x27;8,9,13,32,46,48..57,59,61,65..90,106,109..111,188,190..192,219..222&#x27;);
var _CURSORMOVE_KEY_MAP = _toMap(&#x27;33..40&#x27;);
var _CHANGE_KEY_MAP = {};
_each(_INPUT_KEY_MAP, function(key, val) {
	_CHANGE_KEY_MAP[key] = val;
});
_each(_CURSORMOVE_KEY_MAP, function(key, val) {
	_CHANGE_KEY_MAP[key] = val;
});
function _bindEvent(el, type, fn) {
	if (el.addEventListener){
		el.addEventListener(type, fn, _useCapture);
	} else if (el.attachEvent){
		el.attachEvent(&#x27;on&#x27; + type, fn);
	}
}
function _unbindEvent(el, type, fn) {
	if (el.removeEventListener){
		el.removeEventListener(type, fn, _useCapture);
	} else if (el.detachEvent){
		el.detachEvent(&#x27;on&#x27; + type, fn);
	}
}
var _EVENT_PROPS = (&#x27;altKey,attrChange,attrName,bubbles,button,cancelable,charCode,clientX,clientY,ctrlKey,currentTarget,&#x27; +
	&#x27;data,detail,eventPhase,fromElement,handler,keyCode,metaKey,newValue,offsetX,offsetY,originalTarget,pageX,&#x27; +
	&#x27;pageY,prevValue,relatedNode,relatedTarget,screenX,screenY,shiftKey,srcElement,target,toElement,view,wheelDelta,which&#x27;).split(&#x27;,&#x27;);
function KEvent(el, event) {
	this.init(el, event);
}
_extend(KEvent, {
	init : function(el, event) {
		var self = this, doc = el.ownerDocument || el.document || el;
		self.event = event;
		_each(_EVENT_PROPS, function(key, val) {
			self[val] = event[val];
		});
		if (!self.target) {
			self.target = self.srcElement || doc;
		}
		if (self.target.nodeType === 3) {
			self.target = self.target.parentNode;
		}
		if (!self.relatedTarget &amp;&amp; self.fromElement) {
			self.relatedTarget = self.fromElement === self.target ? self.toElement : self.fromElement;
		}
		if (self.pageX == null &amp;&amp; self.clientX != null) {
			var d = doc.documentElement, body = doc.body;
			self.pageX = self.clientX + (d &amp;&amp; d.scrollLeft || body &amp;&amp; body.scrollLeft || 0) - (d &amp;&amp; d.clientLeft || body &amp;&amp; body.clientLeft || 0);
			self.pageY = self.clientY + (d &amp;&amp; d.scrollTop  || body &amp;&amp; body.scrollTop  || 0) - (d &amp;&amp; d.clientTop  || body &amp;&amp; body.clientTop  || 0);
		}
		if (!self.which &amp;&amp; ((self.charCode || self.charCode === 0) ? self.charCode : self.keyCode)) {
			self.which = self.charCode || self.keyCode;
		}
		if (!self.metaKey &amp;&amp; self.ctrlKey) {
			self.metaKey = self.ctrlKey;
		}
		if (!self.which &amp;&amp; self.button !== undefined) {
			self.which = (self.button &amp; 1 ? 1 : (self.button &amp; 2 ? 3 : (self.button &amp; 4 ? 2 : 0)));
		}
		switch (self.which) {
		case 186 :
			self.which = 59;
			break;
		case 187 :
		case 107 :
		case 43 :
			self.which = 61;
			break;
		case 189 :
		case 45 :
			self.which = 109;
			break;
		case 42 :
			self.which = 106;
			break;
		case 47 :
			self.which = 111;
			break;
		case 78 :
			self.which = 110;
			break;
		}
		if (self.which &gt;= 96 &amp;&amp; self.which &lt;= 105) {
			self.which -= 48;
		}
	},
	preventDefault : function() {
		var ev = this.event;
		if (ev.preventDefault) {
			ev.preventDefault();
		}
		ev.returnValue = false;
	},
	stopPropagation : function() {
		var ev = this.event;
		if (ev.stopPropagation) {
			ev.stopPropagation();
		}
		ev.cancelBubble = true;
	},
	stop : function() {
		this.preventDefault();
		this.stopPropagation();
	}
});
var _eventExpendo = &#x27;kindeditor_&#x27; + _TIME, _eventId = 0, _eventData = {};
function _getId(el) {
	return el[_eventExpendo] || null;
}
function _setId(el) {
	el[_eventExpendo] = ++_eventId;
	return _eventId;
}
function _removeId(el) {
	try {
		delete el[_eventExpendo];
	} catch(e) {
		if (el.removeAttribute) {
			el.removeAttribute(_eventExpendo);
		}
	}
}
function _bind(el, type, fn) {
	if (type.indexOf(&#x27;,&#x27;) &gt;= 0) {
		_each(type.split(&#x27;,&#x27;), function() {
			_bind(el, this, fn);
		});
		return;
	}
	var id = _getId(el);
	if (!id) {
		id = _setId(el);
	}
	if (_eventData[id] === undefined) {
		_eventData[id] = {};
	}
	var events = _eventData[id][type];
	if (events &amp;&amp; events.length &gt; 0) {
		_unbindEvent(el, type, events[0]);
	} else {
		_eventData[id][type] = [];
		_eventData[id].el = el;
	}
	events = _eventData[id][type];
	if (events.length === 0) {
		events[0] = function(e) {
			var kevent = e ? new KEvent(el, e) : undefined;
			_each(events, function(i, event) {
				if (i &gt; 0 &amp;&amp; event) {
					event.call(el, kevent);
				}
			});
		};
	}
	if (_inArray(fn, events) &lt; 0) {
		events.push(fn);
	}
	_bindEvent(el, type, events[0]);
}
function _unbind(el, type, fn) {
	if (type &amp;&amp; type.indexOf(&#x27;,&#x27;) &gt;= 0) {
		_each(type.split(&#x27;,&#x27;), function() {
			_unbind(el, this, fn);
		});
		return;
	}
	var id = _getId(el);
	if (!id) {
		return;
	}
	if (type === undefined) {
		if (id in _eventData) {
			_each(_eventData[id], function(key, events) {
				if (key != &#x27;el&#x27; &amp;&amp; events.length &gt; 0) {
					_unbindEvent(el, key, events[0]);
				}
			});
			delete _eventData[id];
			_removeId(el);
		}
		return;
	}
	if (!_eventData[id]) {
		return;
	}
	var events = _eventData[id][type];
	if (events &amp;&amp; events.length &gt; 0) {
		if (fn === undefined) {
			_unbindEvent(el, type, events[0]);
			delete _eventData[id][type];
		} else {
			_each(events, function(i, event) {
				if (i &gt; 0 &amp;&amp; event === fn) {
					events.splice(i, 1);
				}
			});
			if (events.length == 1) {
				_unbindEvent(el, type, events[0]);
				delete _eventData[id][type];
			}
		}
		var count = 0;
		_each(_eventData[id], function() {
			count++;
		});
		if (count &lt; 2) {
			delete _eventData[id];
			_removeId(el);
		}
	}
}
function _fire(el, type) {
	if (type.indexOf(&#x27;,&#x27;) &gt;= 0) {
		_each(type.split(&#x27;,&#x27;), function() {
			_fire(el, this);
		});
		return;
	}
	var id = _getId(el);
	if (!id) {
		return;
	}
	var events = _eventData[id][type];
	if (_eventData[id] &amp;&amp; events &amp;&amp; events.length &gt; 0) {
		events[0]();
	}
}
function _ctrl(el, key, fn) {
	var self = this;
	key = /^\d{2,}$/.test(key) ? key : key.toUpperCase().charCodeAt(0);
	_bind(el, &#x27;keydown&#x27;, function(e) {
		if (e.ctrlKey &amp;&amp; e.which == key &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey) {
			fn.call(el);
			e.stop();
		}
	});
}
function _ready(fn) {
	var loaded = false;
	function readyFunc() {
		if (!loaded) {
			loaded = true;
			fn(KindEditor);
		}
	}
	function ieReadyFunc() {
		if (!loaded) {
			try {
				document.documentElement.doScroll(&#x27;left&#x27;);
			} catch(e) {
				setTimeout(ieReadyFunc, 100);
				return;
			}
			readyFunc();
		}
	}
	function ieReadyStateFunc() {
		if (document.readyState === &#x27;complete&#x27;) {
			readyFunc();
		}
	}
	if (document.addEventListener) {
		_bind(document, &#x27;DOMContentLoaded&#x27;, readyFunc);
	} else if (document.attachEvent) {
		_bind(document, &#x27;readystatechange&#x27;, ieReadyStateFunc);
		var toplevel = false;
		try {
			toplevel = window.frameElement == null;
		} catch(e) {}
		if (document.documentElement.doScroll &amp;&amp; toplevel) {
			ieReadyFunc();
		}
	}
	_bind(window, &#x27;load&#x27;, readyFunc);
}
if (_IE) {
	window.attachEvent(&#x27;onunload&#x27;, function() {
		_each(_eventData, function(key, events) {
			if (events.el) {
				_unbind(events.el);
			}
		});
	});
}
K.ctrl = _ctrl;
K.ready = _ready;
function _getCssList(css) {
	var list = {},
		reg = /\s*([\w\-]+)\s*:([^;]*)(;|$)/g,
		match;
	while ((match = reg.exec(css))) {
		var key = _trim(match[1].toLowerCase()),
			val = _trim(_toHex(match[2]));
		list[key] = val;
	}
	return list;
}
function _getAttrList(tag) {
	var list = {},
		reg = /\s+(?:([\w\-:]+)|(?:([\w\-:]+)=([^\s&quot;&#x27;&lt;&gt;]+))|(?:([\w\-:&quot;]+)=&quot;([^&quot;]*)&quot;)|(?:([\w\-:&quot;]+)=&#x27;([^&#x27;]*)&#x27;))(?=(?:\s|\/|&gt;)+)/g,
		match;
	while ((match = reg.exec(tag))) {
		var key = (match[1] || match[2] || match[4] || match[6]).toLowerCase(),
			val = (match[2] ? match[3] : (match[4] ? match[5] : match[7])) || &#x27;&#x27;;
		list[key] = val;
	}
	return list;
}
function _addClassToTag(tag, className) {
	if (/\s+class\s*=/.test(tag)) {
		tag = tag.replace(/(\s+class=[&quot;&#x27;]?)([^&quot;&#x27;]*)([&quot;&#x27;]?[\s&gt;])/, function($0, $1, $2, $3) {
			if ((&#x27; &#x27; + $2 + &#x27; &#x27;).indexOf(&#x27; &#x27; + className + &#x27; &#x27;) &lt; 0) {
				return $2 === &#x27;&#x27; ? $1 + className + $3 : $1 + $2 + &#x27; &#x27; + className + $3;
			} else {
				return $0;
			}
		});
	} else {
		tag = tag.substr(0, tag.length - 1) + &#x27; class=&quot;&#x27; + className + &#x27;&quot;&gt;&#x27;;
	}
	return tag;
}
function _formatCss(css) {
	var str = &#x27;&#x27;;
	_each(_getCssList(css), function(key, val) {
		str += key + &#x27;:&#x27; + val + &#x27;;&#x27;;
	});
	return str;
}
function _formatUrl(url, mode, host, pathname) {
	mode = _undef(mode, &#x27;&#x27;).toLowerCase();
	if (url.substr(0, 5) != &#x27;data:&#x27;) {
		url = url.replace(/([^:])\/\//g, &#x27;$1/&#x27;);
	}
	if (_inArray(mode, [&#x27;absolute&#x27;, &#x27;relative&#x27;, &#x27;domain&#x27;]) &lt; 0) {
		return url;
	}
	host = host || location.protocol + &#x27;//&#x27; + location.host;
	if (pathname === undefined) {
		var m = location.pathname.match(/^(\/.*)\//);
		pathname = m ? m[1] : &#x27;&#x27;;
	}
	var match;
	if ((match = /^(\w+:\/\/[^\/]*)/.exec(url))) {
		if (match[1] !== host) {
			return url;
		}
	} else if (/^\w+:/.test(url)) {
		return url;
	}
	function getRealPath(path) {
		var parts = path.split(&#x27;/&#x27;), paths = [];
		for (var i = 0, len = parts.length; i &lt; len; i++) {
			var part = parts[i];
			if (part == &#x27;..&#x27;) {
				if (paths.length &gt; 0) {
					paths.pop();
				}
			} else if (part !== &#x27;&#x27; &amp;&amp; part != &#x27;.&#x27;) {
				paths.push(part);
			}
		}
		return &#x27;/&#x27; + paths.join(&#x27;/&#x27;);
	}
	if (/^\//.test(url)) {
		url = host + getRealPath(url.substr(1));
	} else if (!/^\w+:\/\//.test(url)) {
		url = host + getRealPath(pathname + &#x27;/&#x27; + url);
	}
	function getRelativePath(path, depth) {
		if (url.substr(0, path.length) === path) {
			var arr = [];
			for (var i = 0; i &lt; depth; i++) {
				arr.push(&#x27;..&#x27;);
			}
			var prefix = &#x27;.&#x27;;
			if (arr.length &gt; 0) {
				prefix += &#x27;/&#x27; + arr.join(&#x27;/&#x27;);
			}
			if (pathname == &#x27;/&#x27;) {
				prefix += &#x27;/&#x27;;
			}
			return prefix + url.substr(path.length);
		} else {
			if ((match = /^(.*)\//.exec(path))) {
				return getRelativePath(match[1], ++depth);
			}
		}
	}
	if (mode === &#x27;relative&#x27;) {
		url = getRelativePath(host + pathname, 0).substr(2);
	} else if (mode === &#x27;absolute&#x27;) {
		if (url.substr(0, host.length) === host) {
			url = url.substr(host.length);
		}
	}
	return url;
}
function _formatHtml(html, htmlTags, urlType, wellFormatted, indentChar) {
	urlType = urlType || &#x27;&#x27;;
	wellFormatted = _undef(wellFormatted, false);
	indentChar = _undef(indentChar, &#x27;\t&#x27;);
	var fontSizeList = &#x27;xx-small,x-small,small,medium,large,x-large,xx-large&#x27;.split(&#x27;,&#x27;);
	html = html.replace(/(&lt;(?:pre|pre\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/pre&gt;)/ig, function($0, $1, $2, $3) {
		return $1 + $2.replace(/&lt;(?:br|br\s[^&gt;]*)&gt;/ig, &#x27;\n&#x27;) + $3;
	});
	html = html.replace(/&lt;(?:br|br\s[^&gt;]*)\s*\/?&gt;\s*&lt;\/p&gt;/ig, &#x27;&lt;/p&gt;&#x27;);
	html = html.replace(/(&lt;(?:p|p\s[^&gt;]*)&gt;)\s*(&lt;\/p&gt;)/ig, &#x27;$1&lt;br /&gt;$2&#x27;);
	html = html.replace(/\u200B/g, &#x27;&#x27;);
	html = html.replace(/\u00A9/g, &#x27;&amp;copy;&#x27;);
	var htmlTagMap = {};
	if (htmlTags) {
		_each(htmlTags, function(key, val) {
			var arr = key.split(&#x27;,&#x27;);
			for (var i = 0, len = arr.length; i &lt; len; i++) {
				htmlTagMap[arr[i]] = _toMap(val);
			}
		});
		if (!htmlTagMap.script) {
			html = html.replace(/(&lt;(?:script|script\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/script&gt;)/ig, &#x27;&#x27;);
		}
		if (!htmlTagMap.style) {
			html = html.replace(/(&lt;(?:style|style\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/style&gt;)/ig, &#x27;&#x27;);
		}
	}
	var re = /([ \t\n\r]*)&lt;(\/)?([\w\-:]+)((?:\s+|(?:\s+[\w\-:]+)|(?:\s+[\w\-:]+=[^\s&quot;&#x27;&lt;&gt;]+)|(?:\s+[\w\-:&quot;]+=&quot;[^&quot;]*&quot;)|(?:\s+[\w\-:&quot;]+=&#x27;[^&#x27;]*&#x27;))*)(\/)?&gt;([ \t\n\r]*)/g;
	var tagStack = [];
	html = html.replace(re, function($0, $1, $2, $3, $4, $5, $6) {
		var full = $0,
			startNewline = $1 || &#x27;&#x27;,
			startSlash = $2 || &#x27;&#x27;,
			tagName = $3.toLowerCase(),
			attr = $4 || &#x27;&#x27;,
			endSlash = $5 ? &#x27; &#x27; + $5 : &#x27;&#x27;,
			endNewline = $6 || &#x27;&#x27;;
		if (htmlTags &amp;&amp; !htmlTagMap[tagName]) {
			return &#x27;&#x27;;
		}
		if (endSlash === &#x27;&#x27; &amp;&amp; _SINGLE_TAG_MAP[tagName]) {
			endSlash = &#x27; /&#x27;;
		}
		if (_INLINE_TAG_MAP[tagName]) {
			if (startNewline) {
				startNewline = &#x27; &#x27;;
			}
			if (endNewline) {
				endNewline = &#x27; &#x27;;
			}
		}
		if (_PRE_TAG_MAP[tagName]) {
			if (startSlash) {
				endNewline = &#x27;\n&#x27;;
			} else {
				startNewline = &#x27;\n&#x27;;
			}
		}
		if (wellFormatted &amp;&amp; tagName == &#x27;br&#x27;) {
			endNewline = &#x27;\n&#x27;;
		}
		if (_BLOCK_TAG_MAP[tagName] &amp;&amp; !_PRE_TAG_MAP[tagName]) {
			if (wellFormatted) {
				if (startSlash &amp;&amp; tagStack.length &gt; 0 &amp;&amp; tagStack[tagStack.length - 1] === tagName) {
					tagStack.pop();
				} else {
					tagStack.push(tagName);
				}
				startNewline = &#x27;\n&#x27;;
				endNewline = &#x27;\n&#x27;;
				for (var i = 0, len = startSlash ? tagStack.length : tagStack.length - 1; i &lt; len; i++) {
					startNewline += indentChar;
					if (!startSlash) {
						endNewline += indentChar;
					}
				}
				if (endSlash) {
					tagStack.pop();
				} else if (!startSlash) {
					endNewline += indentChar;
				}
			} else {
				startNewline = endNewline = &#x27;&#x27;;
			}
		}
		if (attr !== &#x27;&#x27;) {
			var attrMap = _getAttrList(full);
			if (tagName === &#x27;font&#x27;) {
				var fontStyleMap = {}, fontStyle = &#x27;&#x27;;
				_each(attrMap, function(key, val) {
					if (key === &#x27;color&#x27;) {
						fontStyleMap.color = val;
						delete attrMap[key];
					}
					if (key === &#x27;size&#x27;) {
						fontStyleMap[&#x27;font-size&#x27;] = fontSizeList[parseInt(val, 10) - 1] || &#x27;&#x27;;
						delete attrMap[key];
					}
					if (key === &#x27;face&#x27;) {
						fontStyleMap[&#x27;font-family&#x27;] = val;
						delete attrMap[key];
					}
					if (key === &#x27;style&#x27;) {
						fontStyle = val;
					}
				});
				if (fontStyle &amp;&amp; !/;$/.test(fontStyle)) {
					fontStyle += &#x27;;&#x27;;
				}
				_each(fontStyleMap, function(key, val) {
					if (val === &#x27;&#x27;) {
						return;
					}
					if (/\s/.test(val)) {
						val = &quot;&#x27;&quot; + val + &quot;&#x27;&quot;;
					}
					fontStyle += key + &#x27;:&#x27; + val + &#x27;;&#x27;;
				});
				attrMap.style = fontStyle;
			}
			_each(attrMap, function(key, val) {
				if (_FILL_ATTR_MAP[key]) {
					attrMap[key] = key;
				}
				if (_inArray(key, [&#x27;src&#x27;, &#x27;href&#x27;]) &gt;= 0) {
					attrMap[key] = _formatUrl(val, urlType);
				}
				if (htmlTags &amp;&amp; key !== &#x27;style&#x27; &amp;&amp; !htmlTagMap[tagName][&#x27;*&#x27;] &amp;&amp; !htmlTagMap[tagName][key] ||
					tagName === &#x27;body&#x27; &amp;&amp; key === &#x27;contenteditable&#x27; ||
					/^kindeditor_\d+$/.test(key)) {
					delete attrMap[key];
				}
				if (key === &#x27;style&#x27; &amp;&amp; val !== &#x27;&#x27;) {
					var styleMap = _getCssList(val);
					_each(styleMap, function(k, v) {
						if (htmlTags &amp;&amp; !htmlTagMap[tagName].style &amp;&amp; !htmlTagMap[tagName][&#x27;.&#x27; + k]) {
							delete styleMap[k];
						}
					});
					var style = &#x27;&#x27;;
					_each(styleMap, function(k, v) {
						style += k + &#x27;:&#x27; + v + &#x27;;&#x27;;
					});
					attrMap.style = style;
				}
			});
			attr = &#x27;&#x27;;
			_each(attrMap, function(key, val) {
				if (key === &#x27;style&#x27; &amp;&amp; val === &#x27;&#x27;) {
					return;
				}
				val = val.replace(/&quot;/g, &#x27;&amp;quot;&#x27;);
				attr += &#x27; &#x27; + key + &#x27;=&quot;&#x27; + val + &#x27;&quot;&#x27;;
			});
		}
		if (tagName === &#x27;font&#x27;) {
			tagName = &#x27;span&#x27;;
		}
		return startNewline + &#x27;&lt;&#x27; + startSlash + tagName + attr + endSlash + &#x27;&gt;&#x27; + endNewline;
	});
	html = html.replace(/(&lt;(?:pre|pre\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/pre&gt;)/ig, function($0, $1, $2, $3) {
		return $1 + $2.replace(/\n/g, &#x27;&lt;span id=&quot;__kindeditor_pre_newline__&quot;&gt;\n&#x27;) + $3;
	});
	html = html.replace(/\n\s*\n/g, &#x27;\n&#x27;);
	html = html.replace(/&lt;span id=&quot;__kindeditor_pre_newline__&quot;&gt;\n/g, &#x27;\n&#x27;);
	return _trim(html);
}
function _clearMsWord(html, htmlTags) {
	html = html.replace(/&lt;meta[\s\S]*?&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;![\s\S]*?&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;style[^&gt;]*&gt;[\s\S]*?&lt;\/style&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;script[^&gt;]*&gt;[\s\S]*?&lt;\/script&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;w:[^&gt;]+&gt;[\s\S]*?&lt;\/w:[^&gt;]+&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;o:[^&gt;]+&gt;[\s\S]*?&lt;\/o:[^&gt;]+&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;xml&gt;[\s\S]*?&lt;\/xml&gt;/ig, &#x27;&#x27;)
		.replace(/&lt;(?:table|td)[^&gt;]*&gt;/ig, function(full) {
			return full.replace(/border-bottom:([#\w\s]+)/ig, &#x27;border:$1&#x27;);
		});
	return _formatHtml(html, htmlTags);
}
function _mediaType(src) {
	if (/\.(rm|rmvb)(\?|$)/i.test(src)) {
		return &#x27;audio/x-pn-realaudio-plugin&#x27;;
	}
	if (/\.(swf|flv)(\?|$)/i.test(src)) {
		return &#x27;application/x-shockwave-flash&#x27;;
	}
	return &#x27;video/x-ms-asf-plugin&#x27;;
}
function _mediaClass(type) {
	if (/realaudio/i.test(type)) {
		return &#x27;ke-rm&#x27;;
	}
	if (/flash/i.test(type)) {
		return &#x27;ke-flash&#x27;;
	}
	return &#x27;ke-media&#x27;;
}
function _mediaAttrs(srcTag) {
	return _getAttrList(unescape(srcTag));
}
function _mediaEmbed(attrs) {
	var html = &#x27;&lt;embed &#x27;;
	_each(attrs, function(key, val) {
		html += key + &#x27;=&quot;&#x27; + val + &#x27;&quot; &#x27;;
	});
	html += &#x27;/&gt;&#x27;;
	return html;
}
function _mediaImg(blankPath, attrs) {
	var width = attrs.width,
		height = attrs.height,
		type = attrs.type || _mediaType(attrs.src),
		srcTag = _mediaEmbed(attrs),
		style = &#x27;&#x27;;
	if (width &gt; 0) {
		style += &#x27;width:&#x27; + width + &#x27;px;&#x27;;
	}
	if (height &gt; 0) {
		style += &#x27;height:&#x27; + height + &#x27;px;&#x27;;
	}
	var html = &#x27;&lt;img class=&quot;&#x27; + _mediaClass(type) + &#x27;&quot; src=&quot;&#x27; + blankPath + &#x27;&quot; &#x27;;
	if (style !== &#x27;&#x27;) {
		html += &#x27;style=&quot;&#x27; + style + &#x27;&quot; &#x27;;
	}
	html += &#x27;data-ke-tag=&quot;&#x27; + escape(srcTag) + &#x27;&quot; alt=&quot;&quot; /&gt;&#x27;;
	return html;
}
function _tmpl(str, data) {
	var fn = new Function(&quot;obj&quot;,
		&quot;var p=[],print=function(){p.push.apply(p,arguments);};&quot; +
		&quot;with(obj){p.push(&#x27;&quot; +
		str.replace(/[\r\t\n]/g, &quot; &quot;)
			.split(&quot;&lt;%&quot;).join(&quot;\t&quot;)
			.replace(/((^|%&gt;)[^\t]*)&#x27;/g, &quot;$1\r&quot;)
			.replace(/\t=(.*?)%&gt;/g, &quot;&#x27;,$1,&#x27;&quot;)
			.split(&quot;\t&quot;).join(&quot;&#x27;);&quot;)
			.split(&quot;%&gt;&quot;).join(&quot;p.push(&#x27;&quot;)
			.split(&quot;\r&quot;).join(&quot;\\&#x27;&quot;) + &quot;&#x27;);}return p.join(&#x27;&#x27;);&quot;);
	return data ? fn(data) : fn;
}
K.formatUrl = _formatUrl;
K.formatHtml = _formatHtml;
K.getCssList = _getCssList;
K.getAttrList = _getAttrList;
K.mediaType = _mediaType;
K.mediaAttrs = _mediaAttrs;
K.mediaEmbed = _mediaEmbed;
K.mediaImg = _mediaImg;
K.clearMsWord = _clearMsWord;
K.tmpl = _tmpl;
function _contains(nodeA, nodeB) {
	if (nodeA.nodeType == 9 &amp;&amp; nodeB.nodeType != 9) {
		return true;
	}
	while ((nodeB = nodeB.parentNode)) {
		if (nodeB == nodeA) {
			return true;
		}
	}
	return false;
}
var _getSetAttrDiv = document.createElement(&#x27;div&#x27;);
_getSetAttrDiv.setAttribute(&#x27;className&#x27;, &#x27;t&#x27;);
var _GET_SET_ATTRIBUTE = _getSetAttrDiv.className !== &#x27;t&#x27;;
function _getAttr(el, key) {
	key = key.toLowerCase();
	var val = null;
	if (!_GET_SET_ATTRIBUTE &amp;&amp; el.nodeName.toLowerCase() != &#x27;script&#x27;) {
		var div = el.ownerDocument.createElement(&#x27;div&#x27;);
		div.appendChild(el.cloneNode(false));
		var list = _getAttrList(_unescape(div.innerHTML));
		if (key in list) {
			val = list[key];
		}
	} else {
		try {
			val = el.getAttribute(key, 2);
		} catch(e) {
			val = el.getAttribute(key, 1);
		}
	}
	if (key === &#x27;style&#x27; &amp;&amp; val !== null) {
		val = _formatCss(val);
	}
	return val;
}
function _queryAll(expr, root) {
	var exprList = expr.split(&#x27;,&#x27;);
	if (exprList.length &gt; 1) {
		var mergedResults = [];
		_each(exprList, function() {
			_each(_queryAll(this, root), function() {
				if (_inArray(this, mergedResults) &lt; 0) {
					mergedResults.push(this);
				}
			});
		});
		return mergedResults;
	}
	root = root || document;
	function escape(str) {
		if (typeof str != &#x27;string&#x27;) {
			return str;
		}
		return str.replace(/([^\w\-])/g, &#x27;\\$1&#x27;);
	}
	function stripslashes(str) {
		return str.replace(/\\/g, &#x27;&#x27;);
	}
	function cmpTag(tagA, tagB) {
		return tagA === &#x27;*&#x27; || tagA.toLowerCase() === escape(tagB.toLowerCase());
	}
	function byId(id, tag, root) {
		var arr = [],
			doc = root.ownerDocument || root,
			el = doc.getElementById(stripslashes(id));
		if (el) {
			if (cmpTag(tag, el.nodeName) &amp;&amp; _contains(root, el)) {
				arr.push(el);
			}
		}
		return arr;
	}
	function byClass(className, tag, root) {
		var doc = root.ownerDocument || root, arr = [], els, i, len, el;
		if (root.getElementsByClassName) {
			els = root.getElementsByClassName(stripslashes(className));
			for (i = 0, len = els.length; i &lt; len; i++) {
				el = els[i];
				if (cmpTag(tag, el.nodeName)) {
					arr.push(el);
				}
			}
		} else if (doc.querySelectorAll) {
			els = doc.querySelectorAll((root.nodeName !== &#x27;#document&#x27; ? root.nodeName + &#x27; &#x27; : &#x27;&#x27;) + tag + &#x27;.&#x27; + className);
			for (i = 0, len = els.length; i &lt; len; i++) {
				el = els[i];
				if (_contains(root, el)) {
					arr.push(el);
				}
			}
		} else {
			els = root.getElementsByTagName(tag);
			className = &#x27; &#x27; + className + &#x27; &#x27;;
			for (i = 0, len = els.length; i &lt; len; i++) {
				el = els[i];
				if (el.nodeType == 1) {
					var cls = el.className;
					if (cls &amp;&amp; (&#x27; &#x27; + cls + &#x27; &#x27;).indexOf(className) &gt; -1) {
						arr.push(el);
					}
				}
			}
		}
		return arr;
	}
	function byName(name, tag, root) {
		var arr = [], doc = root.ownerDocument || root,
			els = doc.getElementsByName(stripslashes(name)), el;
		for (var i = 0, len = els.length; i &lt; len; i++) {
			el = els[i];
			if (cmpTag(tag, el.nodeName) &amp;&amp; _contains(root, el)) {
				if (el.getAttributeNode(&#x27;name&#x27;)) {
					arr.push(el);
				}
			}
		}
		return arr;
	}
	function byAttr(key, val, tag, root) {
		var arr = [], els = root.getElementsByTagName(tag), el;
		for (var i = 0, len = els.length; i &lt; len; i++) {
			el = els[i];
			if (el.nodeType == 1) {
				if (val === null) {
					if (_getAttr(el, key) !== null) {
						arr.push(el);
					}
				} else {
					if (val === escape(_getAttr(el, key))) {
						arr.push(el);
					}
				}
			}
		}
		return arr;
	}
	function select(expr, root) {
		var arr = [], matches;
		matches = /^((?:\\.|[^.#\s\[&lt;&gt;])+)/.exec(expr);
		var tag = matches ? matches[1] : &#x27;*&#x27;;
		if ((matches = /#((?:[\w\-]|\\.)+)$/.exec(expr))) {
			arr = byId(matches[1], tag, root);
		} else if ((matches = /\.((?:[\w\-]|\\.)+)$/.exec(expr))) {
			arr = byClass(matches[1], tag, root);
		} else if ((matches = /\[((?:[\w\-]|\\.)+)\]/.exec(expr))) {
			arr = byAttr(matches[1].toLowerCase(), null, tag, root);
		} else if ((matches = /\[((?:[\w\-]|\\.)+)\s*=\s*[&#x27;&quot;]?((?:\\.|[^&#x27;&quot;]+)+)[&#x27;&quot;]?\]/.exec(expr))) {
			var key = matches[1].toLowerCase(), val = matches[2];
			if (key === &#x27;id&#x27;) {
				arr = byId(val, tag, root);
			} else if (key === &#x27;class&#x27;) {
				arr = byClass(val, tag, root);
			} else if (key === &#x27;name&#x27;) {
				arr = byName(val, tag, root);
			} else {
				arr = byAttr(key, val, tag, root);
			}
		} else {
			var els = root.getElementsByTagName(tag), el;
			for (var i = 0, len = els.length; i &lt; len; i++) {
				el = els[i];
				if (el.nodeType == 1) {
					arr.push(el);
				}
			}
		}
		return arr;
	}
	var parts = [], arr, re = /((?:\\.|[^\s&gt;])+|[\s&gt;])/g;
	while ((arr = re.exec(expr))) {
		if (arr[1] !== &#x27; &#x27;) {
			parts.push(arr[1]);
		}
	}
	var results = [];
	if (parts.length == 1) {
		return select(parts[0], root);
	}
	var isChild = false, part, els, subResults, val, v, i, j, k, length, len, l;
	for (i = 0, lenth = parts.length; i &lt; lenth; i++) {
		part = parts[i];
		if (part === &#x27;&gt;&#x27;) {
			isChild = true;
			continue;
		}
		if (i &gt; 0) {
			els = [];
			for (j = 0, len = results.length; j &lt; len; j++) {
				val = results[j];
				subResults = select(part, val);
				for (k = 0, l = subResults.length; k &lt; l; k++) {
					v = subResults[k];
					if (isChild) {
						if (val === v.parentNode) {
							els.push(v);
						}
					} else {
						els.push(v);
					}
				}
			}
			results = els;
		} else {
			results = select(part, root);
		}
		if (results.length === 0) {
			return [];
		}
	}
	return results;
}
function _query(expr, root) {
	var arr = _queryAll(expr, root);
	return arr.length &gt; 0 ? arr[0] : null;
}
K.query = _query;
K.queryAll = _queryAll;
function _get(val) {
	return K(val)[0];
}
function _getDoc(node) {
	if (!node) {
		return document;
	}
	return node.ownerDocument || node.document || node;
}
function _getWin(node) {
	if (!node) {
		return window;
	}
	var doc = _getDoc(node);
	return doc.parentWindow || doc.defaultView;
}
function _setHtml(el, html) {
	if (el.nodeType != 1) {
		return;
	}
	var doc = _getDoc(el);
	try {
		el.innerHTML = &#x27;&lt;img id=&quot;__kindeditor_temp_tag__&quot; width=&quot;0&quot; height=&quot;0&quot; style=&quot;display:none;&quot; /&gt;&#x27; + html;
		var temp = doc.getElementById(&#x27;__kindeditor_temp_tag__&#x27;);
		temp.parentNode.removeChild(temp);
	} catch(e) {
		K(el).empty();
		K(&#x27;@&#x27; + html, doc).each(function() {
			el.appendChild(this);
		});
	}
}
function _hasClass(el, cls) {
	return _inString(cls, el.className, &#x27; &#x27;);
}
function _setAttr(el, key, val) {
	if (_IE &amp;&amp; _V &lt; 8 &amp;&amp; key.toLowerCase() == &#x27;class&#x27;) {
		key = &#x27;className&#x27;;
	}
	el.setAttribute(key, &#x27;&#x27; + val);
}
function _removeAttr(el, key) {
	if (_IE &amp;&amp; _V &lt; 8 &amp;&amp; key.toLowerCase() == &#x27;class&#x27;) {
		key = &#x27;className&#x27;;
	}
	_setAttr(el, key, &#x27;&#x27;);
	el.removeAttribute(key);
}
function _getNodeName(node) {
	if (!node || !node.nodeName) {
		return &#x27;&#x27;;
	}
	return node.nodeName.toLowerCase();
}
function _computedCss(el, key) {
	var self = this, win = _getWin(el), camelKey = _toCamel(key), val = &#x27;&#x27;;
	if (win.getComputedStyle) {
		var style = win.getComputedStyle(el, null);
		val = style[camelKey] || style.getPropertyValue(key) || el.style[camelKey];
	} else if (el.currentStyle) {
		val = el.currentStyle[camelKey] || el.style[camelKey];
	}
	return val;
}
function _hasVal(node) {
	return !!_VALUE_TAG_MAP[_getNodeName(node)];
}
function _docElement(doc) {
	doc = doc || document;
	return _QUIRKS ? doc.body : doc.documentElement;
}
function _docHeight(doc) {
	var el = _docElement(doc);
	return Math.max(el.scrollHeight, el.clientHeight);
}
function _docWidth(doc) {
	var el = _docElement(doc);
	return Math.max(el.scrollWidth, el.clientWidth);
}
function _getScrollPos(doc) {
	doc = doc || document;
	var x, y;
	if (_IE || _OPERA) {
		x = _docElement(doc).scrollLeft;
		y = _docElement(doc).scrollTop;
	} else {
		x = _getWin(doc).scrollX;
		y = _getWin(doc).scrollY;
	}
	return {x : x, y : y};
}
function KNode(node) {
	this.init(node);
}
_extend(KNode, {
	init : function(node) {
		var self = this;
		node = _isArray(node) ? node : [node];
		var length = 0;
		for (var i = 0, len = node.length; i &lt; len; i++) {
			if (node[i]) {
				self[i] = node[i].constructor === KNode ? node[i][0] : node[i];
				length++;
			}
		}
		self.length = length;
		self.doc = _getDoc(self[0]);
		self.name = _getNodeName(self[0]);
		self.type = self.length &gt; 0 ? self[0].nodeType : null;
		self.win = _getWin(self[0]);
	},
	each : function(fn) {
		var self = this;
		for (var i = 0; i &lt; self.length; i++) {
			if (fn.call(self[i], i, self[i]) === false) {
				return self;
			}
		}
		return self;
	},
	bind : function(type, fn) {
		this.each(function() {
			_bind(this, type, fn);
		});
		return this;
	},
	unbind : function(type, fn) {
		this.each(function() {
			_unbind(this, type, fn);
		});
		return this;
	},
	fire : function(type) {
		if (this.length &lt; 1) {
			return this;
		}
		_fire(this[0], type);
		return this;
	},
	hasAttr : function(key) {
		if (this.length &lt; 1) {
			return false;
		}
		return !!_getAttr(this[0], key);
	},
	attr : function(key, val) {
		var self = this;
		if (key === undefined) {
			return _getAttrList(self.outer());
		}
		if (typeof key === &#x27;object&#x27;) {
			_each(key, function(k, v) {
				self.attr(k, v);
			});
			return self;
		}
		if (val === undefined) {
			val = self.length &lt; 1 ? null : _getAttr(self[0], key);
			return val === null ? &#x27;&#x27; : val;
		}
		self.each(function() {
			_setAttr(this, key, val);
		});
		return self;
	},
	removeAttr : function(key) {
		this.each(function() {
			_removeAttr(this, key);
		});
		return this;
	},
	get : function(i) {
		if (this.length &lt; 1) {
			return null;
		}
		return this[i || 0];
	},
	eq : function(i) {
		if (this.length &lt; 1) {
			return null;
		}
		return this[i] ? new KNode(this[i]) : null;
	},
	hasClass : function(cls) {
		if (this.length &lt; 1) {
			return false;
		}
		return _hasClass(this[0], cls);
	},
	addClass : function(cls) {
		this.each(function() {
			if (!_hasClass(this, cls)) {
				this.className = _trim(this.className + &#x27; &#x27; + cls);
			}
		});
		return this;
	},
	removeClass : function(cls) {
		this.each(function() {
			if (_hasClass(this, cls)) {
				this.className = _trim(this.className.replace(new RegExp(&#x27;(^|\\s)&#x27; + cls + &#x27;(\\s|$)&#x27;), &#x27; &#x27;));
			}
		});
		return this;
	},
	html : function(val) {
		var self = this;
		if (val === undefined) {
			if (self.length &lt; 1 || self.type != 1) {
				return &#x27;&#x27;;
			}
			return _formatHtml(self[0].innerHTML);
		}
		self.each(function() {
			_setHtml(this, val);
		});
		return self;
	},
	text : function() {
		var self = this;
		if (self.length &lt; 1) {
			return &#x27;&#x27;;
		}
		return _IE ? self[0].innerText : self[0].textContent;
	},
	hasVal : function() {
		if (this.length &lt; 1) {
			return false;
		}
		return _hasVal(this[0]);
	},
	val : function(val) {
		var self = this;
		if (val === undefined) {
			if (self.length &lt; 1) {
				return &#x27;&#x27;;
			}
			return self.hasVal() ? self[0].value : self.attr(&#x27;value&#x27;);
		} else {
			self.each(function() {
				if (_hasVal(this)) {
					this.value = val;
				} else {
					_setAttr(this, &#x27;value&#x27; , val);
				}
			});
			return self;
		}
	},
	css : function(key, val) {
		var self = this;
		if (key === undefined) {
			return _getCssList(self.attr(&#x27;style&#x27;));
		}
		if (typeof key === &#x27;object&#x27;) {
			_each(key, function(k, v) {
				self.css(k, v);
			});
			return self;
		}
		if (val === undefined) {
			if (self.length &lt; 1) {
				return &#x27;&#x27;;
			}
			return self[0].style[_toCamel(key)] || _computedCss(self[0], key) || &#x27;&#x27;;
		}
		self.each(function() {
			this.style[_toCamel(key)] = val;
		});
		return self;
	},
	width : function(val) {
		var self = this;
		if (val === undefined) {
			if (self.length &lt; 1) {
				return 0;
			}
			return self[0].offsetWidth;
		}
		return self.css(&#x27;width&#x27;, _addUnit(val));
	},
	height : function(val) {
		var self = this;
		if (val === undefined) {
			if (self.length &lt; 1) {
				return 0;
			}
			return self[0].offsetHeight;
		}
		return self.css(&#x27;height&#x27;, _addUnit(val));
	},
	opacity : function(val) {
		this.each(function() {
			if (this.style.opacity === undefined) {
				this.style.filter = val == 1 ? &#x27;&#x27; : &#x27;alpha(opacity=&#x27; + (val * 100) + &#x27;)&#x27;;
			} else {
				this.style.opacity = val == 1 ? &#x27;&#x27; : val;
			}
		});
		return this;
	},
	data : function(key, val) {
		var self = this;
		key = &#x27;kindeditor_data_&#x27; + key;
		if (val === undefined) {
			if (self.length &lt; 1) {
				return null;
			}
			return self[0][key];
		}
		this.each(function() {
			this[key] = val;
		});
		return self;
	},
	pos : function() {
		var self = this, node = self[0], x = 0, y = 0;
		if (node) {
			if (node.getBoundingClientRect) {
				var box = node.getBoundingClientRect(),
					pos = _getScrollPos(self.doc);
				x = box.left + pos.x;
				y = box.top + pos.y;
			} else {
				while (node) {
					x += node.offsetLeft;
					y += node.offsetTop;
					node = node.offsetParent;
				}
			}
		}
		return {x : _round(x), y : _round(y)};
	},
	clone : function(bool) {
		if (this.length &lt; 1) {
			return new KNode([]);
		}
		return new KNode(this[0].cloneNode(bool));
	},
	append : function(expr) {
		this.each(function() {
			if (this.appendChild) {
				this.appendChild(_get(expr));
			}
		});
		return this;
	},
	appendTo : function(expr) {
		this.each(function() {
			_get(expr).appendChild(this);
		});
		return this;
	},
	before : function(expr) {
		this.each(function() {
			this.parentNode.insertBefore(_get(expr), this);
		});
		return this;
	},
	after : function(expr) {
		this.each(function() {
			if (this.nextSibling) {
				this.parentNode.insertBefore(_get(expr), this.nextSibling);
			} else {
				this.parentNode.appendChild(_get(expr));
			}
		});
		return this;
	},
	replaceWith : function(expr) {
		var nodes = [];
		this.each(function(i, node) {
			_unbind(node);
			var newNode = _get(expr);
			node.parentNode.replaceChild(newNode, node);
			nodes.push(newNode);
		});
		return K(nodes);
	},
	empty : function() {
		var self = this;
		self.each(function(i, node) {
			var child = node.firstChild;
			while (child) {
				if (!node.parentNode) {
					return;
				}
				var next = child.nextSibling;
				child.parentNode.removeChild(child);
				child = next;
			}
		});
		return self;
	},
	remove : function(keepChilds) {
		var self = this;
		self.each(function(i, node) {
			if (!node.parentNode) {
				return;
			}
			_unbind(node);
			if (keepChilds) {
				var child = node.firstChild;
				while (child) {
					var next = child.nextSibling;
					node.parentNode.insertBefore(child, node);
					child = next;
				}
			}
			node.parentNode.removeChild(node);
			delete self[i];
		});
		self.length = 0;
		return self;
	},
	show : function(val) {
		var self = this;
		if (val === undefined) {
			val = self._originDisplay || &#x27;&#x27;;
		}
		if (self.css(&#x27;display&#x27;) != &#x27;none&#x27;) {
			return self;
		}
		return self.css(&#x27;display&#x27;, val);
	},
	hide : function() {
		var self = this;
		if (self.length &lt; 1) {
			return self;
		}
		self._originDisplay = self[0].style.display;
		return self.css(&#x27;display&#x27;, &#x27;none&#x27;);
	},
	outer : function() {
		var self = this;
		if (self.length &lt; 1) {
			return &#x27;&#x27;;
		}
		var div = self.doc.createElement(&#x27;div&#x27;), html;
		div.appendChild(self[0].cloneNode(true));
		html = _formatHtml(div.innerHTML);
		div = null;
		return html;
	},
	isSingle : function() {
		return !!_SINGLE_TAG_MAP[this.name];
	},
	isInline : function() {
		return !!_INLINE_TAG_MAP[this.name];
	},
	isBlock : function() {
		return !!_BLOCK_TAG_MAP[this.name];
	},
	isStyle : function() {
		return !!_STYLE_TAG_MAP[this.name];
	},
	isControl : function() {
		return !!_CONTROL_TAG_MAP[this.name];
	},
	contains : function(otherNode) {
		if (this.length &lt; 1) {
			return false;
		}
		return _contains(this[0], _get(otherNode));
	},
	parent : function() {
		if (this.length &lt; 1) {
			return null;
		}
		var node = this[0].parentNode;
		return node ? new KNode(node) : null;
	},
	children : function() {
		if (this.length &lt; 1) {
			return new KNode([]);
		}
		var list = [], child = this[0].firstChild;
		while (child) {
			if (child.nodeType != 3 || _trim(child.nodeValue) !== &#x27;&#x27;) {
				list.push(child);
			}
			child = child.nextSibling;
		}
		return new KNode(list);
	},
	first : function() {
		var list = this.children();
		return list.length &gt; 0 ? list.eq(0) : null;
	},
	last : function() {
		var list = this.children();
		return list.length &gt; 0 ? list.eq(list.length - 1) : null;
	},
	index : function() {
		if (this.length &lt; 1) {
			return -1;
		}
		var i = -1, sibling = this[0];
		while (sibling) {
			i++;
			sibling = sibling.previousSibling;
		}
		return i;
	},
	prev : function() {
		if (this.length &lt; 1) {
			return null;
		}
		var node = this[0].previousSibling;
		return node ? new KNode(node) : null;
	},
	next : function() {
		if (this.length &lt; 1) {
			return null;
		}
		var node = this[0].nextSibling;
		return node ? new KNode(node) : null;
	},
	scan : function(fn, order) {
		if (this.length &lt; 1) {
			return;
		}
		order = (order === undefined) ? true : order;
		function walk(node) {
			var n = order ? node.firstChild : node.lastChild;
			while (n) {
				var next = order ? n.nextSibling : n.previousSibling;
				if (fn(n) === false) {
					return false;
				}
				if (walk(n) === false) {
					return false;
				}
				n = next;
			}
		}
		walk(this[0]);
		return this;
	}
});
_each((&#x27;blur,focus,focusin,focusout,load,resize,scroll,unload,click,dblclick,&#x27; +
	&#x27;mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,&#x27; +
	&#x27;change,select,submit,keydown,keypress,keyup,error,contextmenu&#x27;).split(&#x27;,&#x27;), function(i, type) {
	KNode.prototype[type] = function(fn) {
		return fn ? this.bind(type, fn) : this.fire(type);
	};
});
var _K = K;
K = function(expr, root) {
	if (expr === undefined || expr === null) {
		return;
	}
	function newNode(node) {
		if (!node[0]) {
			node = [];
		}
		return new KNode(node);
	}
	if (typeof expr === &#x27;string&#x27;) {
		if (root) {
			root = _get(root);
		}
		var length = expr.length;
		if (expr.charAt(0) === &#x27;@&#x27;) {
			expr = expr.substr(1);
		}
		if (expr.length !== length || /&lt;.+&gt;/.test(expr)) {
			var doc = root ? root.ownerDocument || root : document,
				div = doc.createElement(&#x27;div&#x27;), list = [];
			div.innerHTML = &#x27;&lt;img id=&quot;__kindeditor_temp_tag__&quot; width=&quot;0&quot; height=&quot;0&quot; style=&quot;display:none;&quot; /&gt;&#x27; + expr;
			for (var i = 0, len = div.childNodes.length; i &lt; len; i++) {
				var child = div.childNodes[i];
				if (child.id == &#x27;__kindeditor_temp_tag__&#x27;) {
					continue;
				}
				list.push(child);
			}
			return newNode(list);
		}
		return newNode(_queryAll(expr, root));
	}
	if (expr &amp;&amp; expr.constructor === KNode) {
		return expr;
	}
	if (expr.toArray) {
		expr = expr.toArray();
	}
	if (_isArray(expr)) {
		return newNode(expr);
	}
	return newNode(_toArray(arguments));
};
_each(_K, function(key, val) {
	K[key] = val;
});
K.NodeClass = KNode;
window.KindEditor = K;
var _START_TO_START = 0,
	_START_TO_END = 1,
	_END_TO_END = 2,
	_END_TO_START = 3,
	_BOOKMARK_ID = 0;
function _updateCollapsed(range) {
	range.collapsed = (range.startContainer === range.endContainer &amp;&amp; range.startOffset === range.endOffset);
	return range;
}
function _copyAndDelete(range, isCopy, isDelete) {
	var doc = range.doc, nodeList = [];
	function splitTextNode(node, startOffset, endOffset) {
		var length = node.nodeValue.length, centerNode;
		if (isCopy) {
			var cloneNode = node.cloneNode(true);
			if (startOffset &gt; 0) {
				centerNode = cloneNode.splitText(startOffset);
			} else {
				centerNode = cloneNode;
			}
			if (endOffset &lt; length) {
				centerNode.splitText(endOffset - startOffset);
			}
		}
		if (isDelete) {
			var center = node;
			if (startOffset &gt; 0) {
				center = node.splitText(startOffset);
				range.setStart(node, startOffset);
			}
			if (endOffset &lt; length) {
				var right = center.splitText(endOffset - startOffset);
				range.setEnd(right, 0);
			}
			nodeList.push(center);
		}
		return centerNode;
	}
	function removeNodes() {
		if (isDelete) {
			range.up().collapse(true);
		}
		for (var i = 0, len = nodeList.length; i &lt; len; i++) {
			var node = nodeList[i];
			if (node.parentNode) {
				node.parentNode.removeChild(node);
			}
		}
	}
	var copyRange = range.cloneRange().down();
	var start = -1, incStart = -1, incEnd = -1, end = -1,
		ancestor = range.commonAncestor(), frag = doc.createDocumentFragment();
	if (ancestor.nodeType == 3) {
		var textNode = splitTextNode(ancestor, range.startOffset, range.endOffset);
		if (isCopy) {
			frag.appendChild(textNode);
		}
		removeNodes();
		return isCopy ? frag : range;
	}
	function extractNodes(parent, frag) {
		var node = parent.firstChild, nextNode;
		while (node) {
			var testRange = new KRange(doc).selectNode(node);
			start = testRange.compareBoundaryPoints(_START_TO_END, range);
			if (start &gt;= 0 &amp;&amp; incStart &lt;= 0) {
				incStart = testRange.compareBoundaryPoints(_START_TO_START, range);
			}
			if (incStart &gt;= 0 &amp;&amp; incEnd &lt;= 0) {
				incEnd = testRange.compareBoundaryPoints(_END_TO_END, range);
			}
			if (incEnd &gt;= 0 &amp;&amp; end &lt;= 0) {
				end = testRange.compareBoundaryPoints(_END_TO_START, range);
			}
			if (end &gt;= 0) {
				return false;
			}
			nextNode = node.nextSibling;
			if (start &gt; 0) {
				if (node.nodeType == 1) {
					if (incStart &gt;= 0 &amp;&amp; incEnd &lt;= 0) {
						if (isCopy) {
							frag.appendChild(node.cloneNode(true));
						}
						if (isDelete) {
							nodeList.push(node);
						}
					} else {
						var childFlag;
						if (isCopy) {
							childFlag = node.cloneNode(false);
							frag.appendChild(childFlag);
						}
						if (extractNodes(node, childFlag) === false) {
							return false;
						}
					}
				} else if (node.nodeType == 3) {
					var textNode;
					if (node == copyRange.startContainer) {
						textNode = splitTextNode(node, copyRange.startOffset, node.nodeValue.length);
					} else if (node == copyRange.endContainer) {
						textNode = splitTextNode(node, 0, copyRange.endOffset);
					} else {
						textNode = splitTextNode(node, 0, node.nodeValue.length);
					}
					if (isCopy) {
						try {
							frag.appendChild(textNode);
						} catch(e) {}
					}
				}
			}
			node = nextNode;
		}
	}
	extractNodes(ancestor, frag);
	if (isDelete) {
		range.up().collapse(true);
	}
	for (var i = 0, len = nodeList.length; i &lt; len; i++) {
		var node = nodeList[i];
		if (node.parentNode) {
			node.parentNode.removeChild(node);
		}
	}
	return isCopy ? frag : range;
}
function _moveToElementText(range, el) {
	var node = el;
	while (node) {
		var knode = K(node);
		if (knode.name == &#x27;marquee&#x27; || knode.name == &#x27;select&#x27;) {
			return;
		}
		node = node.parentNode;
	}
	try {
		range.moveToElementText(el);
	} catch(e) {}
}
function _getStartEnd(rng, isStart) {
	var doc = rng.parentElement().ownerDocument,
		pointRange = rng.duplicate();
	pointRange.collapse(isStart);
	var parent = pointRange.parentElement(),
		nodes = parent.childNodes;
	if (nodes.length === 0) {
		return {node: parent.parentNode, offset: K(parent).index()};
	}
	var startNode = doc, startPos = 0, cmp = -1;
	var testRange = rng.duplicate();
	_moveToElementText(testRange, parent);
	for (var i = 0, len = nodes.length; i &lt; len; i++) {
		var node = nodes[i];
		cmp = testRange.compareEndPoints(&#x27;StartToStart&#x27;, pointRange);
		if (cmp === 0) {
			return {node: node.parentNode, offset: i};
		}
		if (node.nodeType == 1) {
			var nodeRange = rng.duplicate(), dummy, knode = K(node), newNode = node;
			if (knode.isControl()) {
				dummy = doc.createElement(&#x27;span&#x27;);
				knode.after(dummy);
				newNode = dummy;
				startPos += knode.text().replace(/\r\n|\n|\r/g, &#x27;&#x27;).length;
			}
			_moveToElementText(nodeRange, newNode);
			testRange.setEndPoint(&#x27;StartToEnd&#x27;, nodeRange);
			if (cmp &gt; 0) {
				startPos += nodeRange.text.replace(/\r\n|\n|\r/g, &#x27;&#x27;).length;
			} else {
				startPos = 0;
			}
			if (dummy) {
				K(dummy).remove();
			}
		} else if (node.nodeType == 3) {
			testRange.moveStart(&#x27;character&#x27;, node.nodeValue.length);
			startPos += node.nodeValue.length;
		}
		if (cmp &lt; 0) {
			startNode = node;
		}
	}
	if (cmp &lt; 0 &amp;&amp; startNode.nodeType == 1) {
		return {node: parent, offset: K(parent.lastChild).index() + 1};
	}
	if (cmp &gt; 0) {
		while (startNode.nextSibling &amp;&amp; startNode.nodeType == 1) {
			startNode = startNode.nextSibling;
		}
	}
	testRange = rng.duplicate();
	_moveToElementText(testRange, parent);
	testRange.setEndPoint(&#x27;StartToEnd&#x27;, pointRange);
	startPos -= testRange.text.replace(/\r\n|\n|\r/g, &#x27;&#x27;).length;
	if (cmp &gt; 0 &amp;&amp; startNode.nodeType == 3) {
		var prevNode = startNode.previousSibling;
		while (prevNode &amp;&amp; prevNode.nodeType == 3) {
			startPos -= prevNode.nodeValue.length;
			prevNode = prevNode.previousSibling;
		}
	}
	return {node: startNode, offset: startPos};
}
function _getEndRange(node, offset) {
	var doc = node.ownerDocument || node,
		range = doc.body.createTextRange();
	if (doc == node) {
		range.collapse(true);
		return range;
	}
	if (node.nodeType == 1 &amp;&amp; node.childNodes.length &gt; 0) {
		var children = node.childNodes, isStart, child;
		if (offset === 0) {
			child = children[0];
			isStart = true;
		} else {
			child = children[offset - 1];
			isStart = false;
		}
		if (!child) {
			return range;
		}
		if (K(child).name === &#x27;head&#x27;) {
			if (offset === 1) {
				isStart = true;
			}
			if (offset === 2) {
				isStart = false;
			}
			range.collapse(isStart);
			return range;
		}
		if (child.nodeType == 1) {
			var kchild = K(child), span;
			if (kchild.isControl()) {
				span = doc.createElement(&#x27;span&#x27;);
				if (isStart) {
					kchild.before(span);
				} else {
					kchild.after(span);
				}
				child = span;
			}
			_moveToElementText(range, child);
			range.collapse(isStart);
			if (span) {
				K(span).remove();
			}
			return range;
		}
		node = child;
		offset = isStart ? 0 : child.nodeValue.length;
	}
	var dummy = doc.createElement(&#x27;span&#x27;);
	K(node).before(dummy);
	_moveToElementText(range, dummy);
	range.moveStart(&#x27;character&#x27;, offset);
	K(dummy).remove();
	return range;
}
function _toRange(rng) {
	var doc, range;
	function tr2td(start) {
		if (K(start.node).name == &#x27;tr&#x27;) {
			start.node = start.node.cells[start.offset];
			start.offset = 0;
		}
	}
	if (_IE) {
		if (rng.item) {
			doc = _getDoc(rng.item(0));
			range = new KRange(doc);
			range.selectNode(rng.item(0));
			return range;
		}
		doc = rng.parentElement().ownerDocument;
		var start = _getStartEnd(rng, true),
			end = _getStartEnd(rng, false);
		tr2td(start);
		tr2td(end);
		range = new KRange(doc);
		range.setStart(start.node, start.offset);
		range.setEnd(end.node, end.offset);
		return range;
	}
	var startContainer = rng.startContainer;
	doc = startContainer.ownerDocument || startContainer;
	range = new KRange(doc);
	range.setStart(startContainer, rng.startOffset);
	range.setEnd(rng.endContainer, rng.endOffset);
	return range;
}
function KRange(doc) {
	this.init(doc);
}
_extend(KRange, {
	init : function(doc) {
		var self = this;
		self.startContainer = doc;
		self.startOffset = 0;
		self.endContainer = doc;
		self.endOffset = 0;
		self.collapsed = true;
		self.doc = doc;
	},
	commonAncestor : function() {
		function getParents(node) {
			var parents = [];
			while (node) {
				parents.push(node);
				node = node.parentNode;
			}
			return parents;
		}
		var parentsA = getParents(this.startContainer),
			parentsB = getParents(this.endContainer),
			i = 0, lenA = parentsA.length, lenB = parentsB.length, parentA, parentB;
		while (++i) {
			parentA = parentsA[lenA - i];
			parentB = parentsB[lenB - i];
			if (!parentA || !parentB || parentA !== parentB) {
				break;
			}
		}
		return parentsA[lenA - i + 1];
	},
	setStart : function(node, offset) {
		var self = this, doc = self.doc;
		self.startContainer = node;
		self.startOffset = offset;
		if (self.endContainer === doc) {
			self.endContainer = node;
			self.endOffset = offset;
		}
		return _updateCollapsed(this);
	},
	setEnd : function(node, offset) {
		var self = this, doc = self.doc;
		self.endContainer = node;
		self.endOffset = offset;
		if (self.startContainer === doc) {
			self.startContainer = node;
			self.startOffset = offset;
		}
		return _updateCollapsed(this);
	},
	setStartBefore : function(node) {
		return this.setStart(node.parentNode || this.doc, K(node).index());
	},
	setStartAfter : function(node) {
		return this.setStart(node.parentNode || this.doc, K(node).index() + 1);
	},
	setEndBefore : function(node) {
		return this.setEnd(node.parentNode || this.doc, K(node).index());
	},
	setEndAfter : function(node) {
		return this.setEnd(node.parentNode || this.doc, K(node).index() + 1);
	},
	selectNode : function(node) {
		return this.setStartBefore(node).setEndAfter(node);
	},
	selectNodeContents : function(node) {
		var knode = K(node);
		if (knode.type == 3 || knode.isSingle()) {
			return this.selectNode(node);
		}
		var children = knode.children();
		if (children.length &gt; 0) {
			return this.setStartBefore(children[0]).setEndAfter(children[children.length - 1]);
		}
		return this.setStart(node, 0).setEnd(node, 0);
	},
	collapse : function(toStart) {
		if (toStart) {
			return this.setEnd(this.startContainer, this.startOffset);
		}
		return this.setStart(this.endContainer, this.endOffset);
	},
	compareBoundaryPoints : function(how, range) {
		var rangeA = this.get(), rangeB = range.get();
		if (_IE) {
			var arr = {};
			arr[_START_TO_START] = &#x27;StartToStart&#x27;;
			arr[_START_TO_END] = &#x27;EndToStart&#x27;;
			arr[_END_TO_END] = &#x27;EndToEnd&#x27;;
			arr[_END_TO_START] = &#x27;StartToEnd&#x27;;
			var cmp = rangeA.compareEndPoints(arr[how], rangeB);
			if (cmp !== 0) {
				return cmp;
			}
			var nodeA, nodeB, nodeC, posA, posB;
			if (how === _START_TO_START || how === _END_TO_START) {
				nodeA = this.startContainer;
				posA = this.startOffset;
			}
			if (how === _START_TO_END || how === _END_TO_END) {
				nodeA = this.endContainer;
				posA = this.endOffset;
			}
			if (how === _START_TO_START || how === _START_TO_END) {
				nodeB = range.startContainer;
				posB = range.startOffset;
			}
			if (how === _END_TO_END || how === _END_TO_START) {
				nodeB = range.endContainer;
				posB = range.endOffset;
			}
			if (nodeA === nodeB) {
				var diff = posA - posB;
				return diff &gt; 0 ? 1 : (diff &lt; 0 ? -1 : 0);
			}
			nodeC = nodeB;
			while (nodeC &amp;&amp; nodeC.parentNode !== nodeA) {
				nodeC = nodeC.parentNode;
			}
			if (nodeC) {
				return K(nodeC).index() &gt;= posA ? -1 : 1;
			}
			nodeC = nodeA;
			while (nodeC &amp;&amp; nodeC.parentNode !== nodeB) {
				nodeC = nodeC.parentNode;
			}
			if (nodeC) {
				return K(nodeC).index() &gt;= posB ? 1 : -1;
			}
			nodeC = K(nodeB).next();
			if (nodeC &amp;&amp; nodeC.contains(nodeA)) {
				return 1;
			}
			nodeC = K(nodeA).next();
			if (nodeC &amp;&amp; nodeC.contains(nodeB)) {
				return -1;
			}
		} else {
			return rangeA.compareBoundaryPoints(how, rangeB);
		}
	},
	cloneRange : function() {
		return new KRange(this.doc).setStart(this.startContainer, this.startOffset).setEnd(this.endContainer, this.endOffset);
	},
	toString : function() {
		var rng = this.get(), str = _IE ? rng.text : rng.toString();
		return str.replace(/\r\n|\n|\r/g, &#x27;&#x27;);
	},
	cloneContents : function() {
		return _copyAndDelete(this, true, false);
	},
	deleteContents : function() {
		return _copyAndDelete(this, false, true);
	},
	extractContents : function() {
		return _copyAndDelete(this, true, true);
	},
	insertNode : function(node) {
		var self = this,
			sc = self.startContainer, so = self.startOffset,
			ec = self.endContainer, eo = self.endOffset,
			firstChild, lastChild, c, nodeCount = 1;
		if (node.nodeName.toLowerCase() === &#x27;#document-fragment&#x27;) {
			firstChild = node.firstChild;
			lastChild = node.lastChild;
			nodeCount = node.childNodes.length;
		}
		if (sc.nodeType == 1) {
			c = sc.childNodes[so];
			if (c) {
				sc.insertBefore(node, c);
				if (sc === ec) {
					eo += nodeCount;
				}
			} else {
				sc.appendChild(node);
			}
		} else if (sc.nodeType == 3) {
			if (so === 0) {
				sc.parentNode.insertBefore(node, sc);
				if (sc.parentNode === ec) {
					eo += nodeCount;
				}
			} else if (so &gt;= sc.nodeValue.length) {
				if (sc.nextSibling) {
					sc.parentNode.insertBefore(node, sc.nextSibling);
				} else {
					sc.parentNode.appendChild(node);
				}
			} else {
				if (so &gt; 0) {
					c = sc.splitText(so);
				} else {
					c = sc;
				}
				sc.parentNode.insertBefore(node, c);
				if (sc === ec) {
					ec = c;
					eo -= so;
				}
			}
		}
		if (firstChild) {
			self.setStartBefore(firstChild).setEndAfter(lastChild);
		} else {
			self.selectNode(node);
		}
		if (self.compareBoundaryPoints(_END_TO_END, self.cloneRange().setEnd(ec, eo)) &gt;= 1) {
			return self;
		}
		return self.setEnd(ec, eo);
	},
	surroundContents : function(node) {
		node.appendChild(this.extractContents());
		return this.insertNode(node).selectNode(node);
	},
	isControl : function() {
		var self = this,
			sc = self.startContainer, so = self.startOffset,
			ec = self.endContainer, eo = self.endOffset, rng;
		return sc.nodeType == 1 &amp;&amp; sc === ec &amp;&amp; so + 1 === eo &amp;&amp; K(sc.childNodes[so]).isControl();
	},
	get : function(hasControlRange) {
		var self = this, doc = self.doc, node, rng;
		if (!_IE) {
			rng = doc.createRange();
			try {
				rng.setStart(self.startContainer, self.startOffset);
				rng.setEnd(self.endContainer, self.endOffset);
			} catch (e) {}
			return rng;
		}
		if (hasControlRange &amp;&amp; self.isControl()) {
			rng = doc.body.createControlRange();
			rng.addElement(self.startContainer.childNodes[self.startOffset]);
			return rng;
		}
		var range = self.cloneRange().down();
		rng = doc.body.createTextRange();
		rng.setEndPoint(&#x27;StartToStart&#x27;, _getEndRange(range.startContainer, range.startOffset));
		rng.setEndPoint(&#x27;EndToStart&#x27;, _getEndRange(range.endContainer, range.endOffset));
		return rng;
	},
	html : function() {
		return K(this.cloneContents()).outer();
	},
	down : function() {
		var self = this;
		function downPos(node, pos, isStart) {
			if (node.nodeType != 1) {
				return;
			}
			var children = K(node).children();
			if (children.length === 0) {
				return;
			}
			var left, right, child, offset;
			if (pos &gt; 0) {
				left = children.eq(pos - 1);
			}
			if (pos &lt; children.length) {
				right = children.eq(pos);
			}
			if (left &amp;&amp; left.type == 3) {
				child = left[0];
				offset = child.nodeValue.length;
			}
			if (right &amp;&amp; right.type == 3) {
				child = right[0];
				offset = 0;
			}
			if (!child) {
				return;
			}
			if (isStart) {
				self.setStart(child, offset);
			} else {
				self.setEnd(child, offset);
			}
		}
		downPos(self.startContainer, self.startOffset, true);
		downPos(self.endContainer, self.endOffset, false);
		return self;
	},
	up : function() {
		var self = this;
		function upPos(node, pos, isStart) {
			if (node.nodeType != 3) {
				return;
			}
			if (pos === 0) {
				if (isStart) {
					self.setStartBefore(node);
				} else {
					self.setEndBefore(node);
				}
			} else if (pos == node.nodeValue.length) {
				if (isStart) {
					self.setStartAfter(node);
				} else {
					self.setEndAfter(node);
				}
			}
		}
		upPos(self.startContainer, self.startOffset, true);
		upPos(self.endContainer, self.endOffset, false);
		return self;
	},
	enlarge : function(toBlock) {
		var self = this;
		self.up();
		function enlargePos(node, pos, isStart) {
			var knode = K(node), parent;
			if (knode.type == 3 || _NOSPLIT_TAG_MAP[knode.name] || !toBlock &amp;&amp; knode.isBlock()) {
				return;
			}
			if (pos === 0) {
				while (!knode.prev()) {
					parent = knode.parent();
					if (!parent || _NOSPLIT_TAG_MAP[parent.name] || !toBlock &amp;&amp; parent.isBlock()) {
						break;
					}
					knode = parent;
				}
				if (isStart) {
					self.setStartBefore(knode[0]);
				} else {
					self.setEndBefore(knode[0]);
				}
			} else if (pos == knode.children().length) {
				while (!knode.next()) {
					parent = knode.parent();
					if (!parent || _NOSPLIT_TAG_MAP[parent.name] || !toBlock &amp;&amp; parent.isBlock()) {
						break;
					}
					knode = parent;
				}
				if (isStart) {
					self.setStartAfter(knode[0]);
				} else {
					self.setEndAfter(knode[0]);
				}
			}
		}
		enlargePos(self.startContainer, self.startOffset, true);
		enlargePos(self.endContainer, self.endOffset, false);
		return self;
	},
	shrink : function() {
		var self = this, child, collapsed = self.collapsed;
		while (self.startContainer.nodeType == 1 &amp;&amp; (child = self.startContainer.childNodes[self.startOffset]) &amp;&amp; child.nodeType == 1 &amp;&amp; !K(child).isSingle()) {
			self.setStart(child, 0);
		}
		if (collapsed) {
			return self.collapse(collapsed);
		}
		while (self.endContainer.nodeType == 1 &amp;&amp; self.endOffset &gt; 0 &amp;&amp; (child = self.endContainer.childNodes[self.endOffset - 1]) &amp;&amp; child.nodeType == 1 &amp;&amp; !K(child).isSingle()) {
			self.setEnd(child, child.childNodes.length);
		}
		return self;
	},
	createBookmark : function(serialize) {
		var self = this, doc = self.doc, endNode,
			startNode = K(&#x27;&lt;span style=&quot;display:none;&quot;&gt;&lt;/span&gt;&#x27;, doc)[0];
		startNode.id = &#x27;__kindeditor_bookmark_start_&#x27; + (_BOOKMARK_ID++) + &#x27;__&#x27;;
		if (!self.collapsed) {
			endNode = startNode.cloneNode(true);
			endNode.id = &#x27;__kindeditor_bookmark_end_&#x27; + (_BOOKMARK_ID++) + &#x27;__&#x27;;
		}
		if (endNode) {
			self.cloneRange().collapse(false).insertNode(endNode).setEndBefore(endNode);
		}
		self.insertNode(startNode).setStartAfter(startNode);
		return {
			start : serialize ? &#x27;#&#x27; + startNode.id : startNode,
			end : endNode ? (serialize ? &#x27;#&#x27; + endNode.id : endNode) : null
		};
	},
	moveToBookmark : function(bookmark) {
		var self = this, doc = self.doc,
			start = K(bookmark.start, doc), end = bookmark.end ? K(bookmark.end, doc) : null;
		if (!start || start.length &lt; 1) {
			return self;
		}
		self.setStartBefore(start[0]);
		start.remove();
		if (end &amp;&amp; end.length &gt; 0) {
			self.setEndBefore(end[0]);
			end.remove();
		} else {
			self.collapse(true);
		}
		return self;
	},
	dump : function() {
		console.log(&#x27;--------------------&#x27;);
		console.log(this.startContainer.nodeType == 3 ? this.startContainer.nodeValue : this.startContainer, this.startOffset);
		console.log(this.endContainer.nodeType == 3 ? this.endContainer.nodeValue : this.endContainer, this.endOffset);
	}
});
function _range(mixed) {
	if (!mixed.nodeName) {
		return mixed.constructor === KRange ? mixed : _toRange(mixed);
	}
	return new KRange(mixed);
}
K.RangeClass = KRange;
K.range = _range;
K.START_TO_START = _START_TO_START;
K.START_TO_END = _START_TO_END;
K.END_TO_END = _END_TO_END;
K.END_TO_START = _END_TO_START;
function _nativeCommand(doc, key, val) {
	try {
		doc.execCommand(key, false, val);
	} catch(e) {}
}
function _nativeCommandValue(doc, key) {
	var val = &#x27;&#x27;;
	try {
		val = doc.queryCommandValue(key);
	} catch (e) {}
	if (typeof val !== &#x27;string&#x27;) {
		val = &#x27;&#x27;;
	}
	return val;
}
function _getSel(doc) {
	var win = _getWin(doc);
	return doc.selection || win.getSelection();
}
function _getRng(doc) {
	var sel = _getSel(doc), rng;
	try {
		if (sel.rangeCount &gt; 0) {
			rng = sel.getRangeAt(0);
		} else {
			rng = sel.createRange();
		}
	} catch(e) {}
	if (_IE &amp;&amp; (!rng || (!rng.item &amp;&amp; rng.parentElement().ownerDocument !== doc))) {
		return null;
	}
	return rng;
}
function _singleKeyMap(map) {
	var newMap = {}, arr, v;
	_each(map, function(key, val) {
		arr = key.split(&#x27;,&#x27;);
		for (var i = 0, len = arr.length; i &lt; len; i++) {
			v = arr[i];
			newMap[v] = val;
		}
	});
	return newMap;
}
function _hasAttrOrCss(knode, map) {
	return _hasAttrOrCssByKey(knode, map, &#x27;*&#x27;) || _hasAttrOrCssByKey(knode, map);
}
function _hasAttrOrCssByKey(knode, map, mapKey) {
	mapKey = mapKey || knode.name;
	if (knode.type !== 1) {
		return false;
	}
	var newMap = _singleKeyMap(map);
	if (!newMap[mapKey]) {
		return false;
	}
	var arr = newMap[mapKey].split(&#x27;,&#x27;);
	for (var i = 0, len = arr.length; i &lt; len; i++) {
		var key = arr[i];
		if (key === &#x27;*&#x27;) {
			return true;
		}
		var match = /^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key);
		var method = match[1] ? &#x27;css&#x27; : &#x27;attr&#x27;;
		key = match[2];
		var val = match[3] || &#x27;&#x27;;
		if (val === &#x27;&#x27; &amp;&amp; knode[method](key) !== &#x27;&#x27;) {
			return true;
		}
		if (val !== &#x27;&#x27; &amp;&amp; knode[method](key) === val) {
			return true;
		}
	}
	return false;
}
function _removeAttrOrCss(knode, map) {
	if (knode.type != 1) {
		return;
	}
	_removeAttrOrCssByKey(knode, map, &#x27;*&#x27;);
	_removeAttrOrCssByKey(knode, map);
}
function _removeAttrOrCssByKey(knode, map, mapKey) {
	mapKey = mapKey || knode.name;
	if (knode.type !== 1) {
		return;
	}
	var newMap = _singleKeyMap(map);
	if (!newMap[mapKey]) {
		return;
	}
	var arr = newMap[mapKey].split(&#x27;,&#x27;), allFlag = false;
	for (var i = 0, len = arr.length; i &lt; len; i++) {
		var key = arr[i];
		if (key === &#x27;*&#x27;) {
			allFlag = true;
			break;
		}
		var match = /^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key);
		key = match[2];
		if (match[1]) {
			key = _toCamel(key);
			if (knode[0].style[key]) {
				knode[0].style[key] = &#x27;&#x27;;
			}
		} else {
			knode.removeAttr(key);
		}
	}
	if (allFlag) {
		knode.remove(true);
	}
}
function _getInnerNode(knode) {
	var inner = knode;
	while (inner.first()) {
		inner = inner.first();
	}
	return inner;
}
function _isEmptyNode(knode) {
	if (knode.type != 1 || knode.isSingle()) {
		return false;
	}
	return knode.html().replace(/&lt;[^&gt;]+&gt;/g, &#x27;&#x27;) === &#x27;&#x27;;
}
function _mergeWrapper(a, b) {
	a = a.clone(true);
	var lastA = _getInnerNode(a), childA = a, merged = false;
	while (b) {
		while (childA) {
			if (childA.name === b.name) {
				_mergeAttrs(childA, b.attr(), b.css());
				merged = true;
			}
			childA = childA.first();
		}
		if (!merged) {
			lastA.append(b.clone(false));
		}
		merged = false;
		b = b.first();
	}
	return a;
}
function _wrapNode(knode, wrapper) {
	wrapper = wrapper.clone(true);
	if (knode.type == 3) {
		_getInnerNode(wrapper).append(knode.clone(false));
		knode.replaceWith(wrapper);
		return wrapper;
	}
	var nodeWrapper = knode, child;
	while ((child = knode.first()) &amp;&amp; child.children().length == 1) {
		knode = child;
	}
	child = knode.first();
	var frag = knode.doc.createDocumentFragment();
	while (child) {
		frag.appendChild(child[0]);
		child = child.next();
	}
	wrapper = _mergeWrapper(nodeWrapper, wrapper);
	if (frag.firstChild) {
		_getInnerNode(wrapper).append(frag);
	}
	nodeWrapper.replaceWith(wrapper);
	return wrapper;
}
function _mergeAttrs(knode, attrs, styles) {
	_each(attrs, function(key, val) {
		if (key !== &#x27;style&#x27;) {
			knode.attr(key, val);
		}
	});
	_each(styles, function(key, val) {
		knode.css(key, val);
	});
}
function _inPreElement(knode) {
	while (knode &amp;&amp; knode.name != &#x27;body&#x27;) {
		if (_PRE_TAG_MAP[knode.name] || knode.name == &#x27;div&#x27; &amp;&amp; knode.hasClass(&#x27;ke-script&#x27;)) {
			return true;
		}
		knode = knode.parent();
	}
	return false;
}
function KCmd(range) {
	this.init(range);
}
_extend(KCmd, {
	init : function(range) {
		var self = this, doc = range.doc;
		self.doc = doc;
		self.win = _getWin(doc);
		self.sel = _getSel(doc);
		self.range = range;
	},
	selection : function(forceReset) {
		var self = this, doc = self.doc, rng = _getRng(doc);
		self.sel = _getSel(doc);
		if (rng) {
			self.range = _range(rng);
			if (K(self.range.startContainer).name == &#x27;html&#x27;) {
				self.range.selectNodeContents(doc.body).collapse(false);
			}
			return self;
		}
		if (forceReset) {
			self.range.selectNodeContents(doc.body).collapse(false);
		}
		return self;
	},
	select : function(hasDummy) {
		hasDummy = _undef(hasDummy, true);
		var self = this, sel = self.sel, range = self.range.cloneRange().shrink(),
			sc = range.startContainer, so = range.startOffset,
			ec = range.endContainer, eo = range.endOffset,
			doc = _getDoc(sc), win = self.win, rng, hasU200b = false;
		if (hasDummy &amp;&amp; sc.nodeType == 1 &amp;&amp; range.collapsed) {
			if (_IE) {
				var dummy = K(&#x27;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&#x27;, doc);
				range.insertNode(dummy[0]);
				rng = doc.body.createTextRange();
				try {
					rng.moveToElementText(dummy[0]);
				} catch(ex) {}
				rng.collapse(false);
				rng.select();
				dummy.remove();
				win.focus();
				return self;
			}
			if (_WEBKIT) {
				var children = sc.childNodes;
				if (K(sc).isInline() || so &gt; 0 &amp;&amp; K(children[so - 1]).isInline() || children[so] &amp;&amp; K(children[so]).isInline()) {
					range.insertNode(doc.createTextNode(&#x27;\u200B&#x27;));
					hasU200b = true;
				}
			}
		}
		if (_IE) {
			try {
				rng = range.get(true);
				rng.select();
			} catch(e) {}
		} else {
			if (hasU200b) {
				range.collapse(false);
			}
			rng = range.get(true);
			sel.removeAllRanges();
			sel.addRange(rng);
			if (doc !== document) {
				var pos = K(rng.endContainer).pos();
				win.scrollTo(pos.x, pos.y);
			}
		}
		win.focus();
		return self;
	},
	wrap : function(val) {
		var self = this, doc = self.doc, range = self.range, wrapper;
		wrapper = K(val, doc);
		if (range.collapsed) {
			range.shrink();
			range.insertNode(wrapper[0]).selectNodeContents(wrapper[0]);
			return self;
		}
		if (wrapper.isBlock()) {
			var copyWrapper = wrapper.clone(true), child = copyWrapper;
			while (child.first()) {
				child = child.first();
			}
			child.append(range.extractContents());
			range.insertNode(copyWrapper[0]).selectNode(copyWrapper[0]);
			return self;
		}
		range.enlarge();
		var bookmark = range.createBookmark(), ancestor = range.commonAncestor(), isStart = false;
		K(ancestor).scan(function(node) {
			if (!isStart &amp;&amp; node == bookmark.start) {
				isStart = true;
				return;
			}
			if (isStart) {
				if (node == bookmark.end) {
					return false;
				}
				var knode = K(node);
				if (_inPreElement(knode)) {
					return;
				}
				if (knode.type == 3 &amp;&amp; _trim(node.nodeValue).length &gt; 0) {
					var parent;
					while ((parent = knode.parent()) &amp;&amp; parent.isStyle() &amp;&amp; parent.children().length == 1) {
						knode = parent;
					}
					_wrapNode(knode, wrapper);
				}
			}
		});
		range.moveToBookmark(bookmark);
		return self;
	},
	split : function(isStart, map) {
		var range = this.range, doc = range.doc;
		var tempRange = range.cloneRange().collapse(isStart);
		var node = tempRange.startContainer, pos = tempRange.startOffset,
			parent = node.nodeType == 3 ? node.parentNode : node,
			needSplit = false, knode;
		while (parent &amp;&amp; parent.parentNode) {
			knode = K(parent);
			if (map) {
				if (!knode.isStyle()) {
					break;
				}
				if (!_hasAttrOrCss(knode, map)) {
					break;
				}
			} else {
				if (_NOSPLIT_TAG_MAP[knode.name]) {
					break;
				}
			}
			needSplit = true;
			parent = parent.parentNode;
		}
		if (needSplit) {
			var dummy = doc.createElement(&#x27;span&#x27;);
			range.cloneRange().collapse(!isStart).insertNode(dummy);
			if (isStart) {
				tempRange.setStartBefore(parent.firstChild).setEnd(node, pos);
			} else {
				tempRange.setStart(node, pos).setEndAfter(parent.lastChild);
			}
			var frag = tempRange.extractContents(),
				first = frag.firstChild, last = frag.lastChild;
			if (isStart) {
				tempRange.insertNode(frag);
				range.setStartAfter(last).setEndBefore(dummy);
			} else {
				parent.appendChild(frag);
				range.setStartBefore(dummy).setEndBefore(first);
			}
			var dummyParent = dummy.parentNode;
			if (dummyParent == range.endContainer) {
				var prev = K(dummy).prev(), next = K(dummy).next();
				if (prev &amp;&amp; next &amp;&amp; prev.type == 3 &amp;&amp; next.type == 3) {
					range.setEnd(prev[0], prev[0].nodeValue.length);
				} else if (!isStart) {
					range.setEnd(range.endContainer, range.endOffset - 1);
				}
			}
			dummyParent.removeChild(dummy);
		}
		return this;
	},
	remove : function(map) {
		var self = this, doc = self.doc, range = self.range;
		range.enlarge();
		if (range.startOffset === 0) {
			var ksc = K(range.startContainer), parent;
			while ((parent = ksc.parent()) &amp;&amp; parent.isStyle() &amp;&amp; parent.children().length == 1) {
				ksc = parent;
			}
			range.setStart(ksc[0], 0);
			ksc = K(range.startContainer);
			if (ksc.isBlock()) {
				_removeAttrOrCss(ksc, map);
			}
			var kscp = ksc.parent();
			if (kscp &amp;&amp; kscp.isBlock()) {
				_removeAttrOrCss(kscp, map);
			}
		}
		var sc, so;
		if (range.collapsed) {
			self.split(true, map);
			sc = range.startContainer;
			so = range.startOffset;
			if (so &gt; 0) {
				var sb = K(sc.childNodes[so - 1]);
				if (sb &amp;&amp; _isEmptyNode(sb)) {
					sb.remove();
					range.setStart(sc, so - 1);
				}
			}
			var sa = K(sc.childNodes[so]);
			if (sa &amp;&amp; _isEmptyNode(sa)) {
				sa.remove();
			}
			if (_isEmptyNode(sc)) {
				range.startBefore(sc);
				sc.remove();
			}
			range.collapse(true);
			return self;
		}
		self.split(true, map);
		self.split(false, map);
		var startDummy = doc.createElement(&#x27;span&#x27;), endDummy = doc.createElement(&#x27;span&#x27;);
		range.cloneRange().collapse(false).insertNode(endDummy);
		range.cloneRange().collapse(true).insertNode(startDummy);
		var nodeList = [], cmpStart = false;
		K(range.commonAncestor()).scan(function(node) {
			if (!cmpStart &amp;&amp; node == startDummy) {
				cmpStart = true;
				return;
			}
			if (node == endDummy) {
				return false;
			}
			if (cmpStart) {
				nodeList.push(node);
			}
		});
		K(startDummy).remove();
		K(endDummy).remove();
		sc = range.startContainer;
		so = range.startOffset;
		var ec = range.endContainer, eo = range.endOffset;
		if (so &gt; 0) {
			var startBefore = K(sc.childNodes[so - 1]);
			if (startBefore &amp;&amp; _isEmptyNode(startBefore)) {
				startBefore.remove();
				range.setStart(sc, so - 1);
				if (sc == ec) {
					range.setEnd(ec, eo - 1);
				}
			}
			var startAfter = K(sc.childNodes[so]);
			if (startAfter &amp;&amp; _isEmptyNode(startAfter)) {
				startAfter.remove();
				if (sc == ec) {
					range.setEnd(ec, eo - 1);
				}
			}
		}
		var endAfter = K(ec.childNodes[range.endOffset]);
		if (endAfter &amp;&amp; _isEmptyNode(endAfter)) {
			endAfter.remove();
		}
		var bookmark = range.createBookmark(true);
		_each(nodeList, function(i, node) {
			_removeAttrOrCss(K(node), map);
		});
		range.moveToBookmark(bookmark);
		return self;
	},
	commonNode : function(map) {
		var range = this.range;
		var ec = range.endContainer, eo = range.endOffset,
			node = (ec.nodeType == 3 || eo === 0) ? ec : ec.childNodes[eo - 1];
		function find(node) {
			var child = node, parent = node;
			while (parent) {
				if (_hasAttrOrCss(K(parent), map)) {
					return K(parent);
				}
				parent = parent.parentNode;
			}
			while (child &amp;&amp; (child = child.lastChild)) {
				if (_hasAttrOrCss(K(child), map)) {
					return K(child);
				}
			}
			return null;
		}
		var cNode = find(node);
		if (cNode) {
			return cNode;
		}
		if (node.nodeType == 1 || (ec.nodeType == 3 &amp;&amp; eo === 0)) {
			var prev = K(node).prev();
			if (prev) {
				return find(prev);
			}
		}
		return null;
	},
	commonAncestor : function(tagName) {
		var range = this.range,
			sc = range.startContainer, so = range.startOffset,
			ec = range.endContainer, eo = range.endOffset,
			startNode = (sc.nodeType == 3 || so === 0) ? sc : sc.childNodes[so - 1],
			endNode = (ec.nodeType == 3 || eo === 0) ? ec : ec.childNodes[eo - 1];
		function find(node) {
			while (node) {
				if (node.nodeType == 1) {
					if (node.tagName.toLowerCase() === tagName) {
						return node;
					}
				}
				node = node.parentNode;
			}
			return null;
		}
		var start = find(startNode), end = find(endNode);
		if (start &amp;&amp; end &amp;&amp; start === end) {
			return K(start);
		}
		return null;
	},
	state : function(key) {
		var self = this, doc = self.doc, bool = false;
		try {
			bool = doc.queryCommandState(key);
		} catch (e) {}
		return bool;
	},
	val : function(key) {
		var self = this, doc = self.doc, range = self.range;
		function lc(val) {
			return val.toLowerCase();
		}
		key = lc(key);
		var val = &#x27;&#x27;, knode;
		if (key === &#x27;fontfamily&#x27; || key === &#x27;fontname&#x27;) {
			val = _nativeCommandValue(doc, &#x27;fontname&#x27;);
			val = val.replace(/[&#x27;&quot;]/g, &#x27;&#x27;);
			return lc(val);
		}
		if (key === &#x27;formatblock&#x27;) {
			val = _nativeCommandValue(doc, key);
			if (val === &#x27;&#x27;) {
				knode = self.commonNode({&#x27;h1,h2,h3,h4,h5,h6,p,div,pre,address&#x27; : &#x27;*&#x27;});
				if (knode) {
					val = knode.name;
				}
			}
			if (val === &#x27;Normal&#x27;) {
				val = &#x27;p&#x27;;
			}
			return lc(val);
		}
		if (key === &#x27;fontsize&#x27;) {
			knode = self.commonNode({&#x27;*&#x27; : &#x27;.font-size&#x27;});
			if (knode) {
				val = knode.css(&#x27;font-size&#x27;);
			}
			return lc(val);
		}
		if (key === &#x27;forecolor&#x27;) {
			knode = self.commonNode({&#x27;*&#x27; : &#x27;.color&#x27;});
			if (knode) {
				val = knode.css(&#x27;color&#x27;);
			}
			val = _toHex(val);
			if (val === &#x27;&#x27;) {
				val = &#x27;default&#x27;;
			}
			return lc(val);
		}
		if (key === &#x27;hilitecolor&#x27;) {
			knode = self.commonNode({&#x27;*&#x27; : &#x27;.background-color&#x27;});
			if (knode) {
				val = knode.css(&#x27;background-color&#x27;);
			}
			val = _toHex(val);
			if (val === &#x27;&#x27;) {
				val = &#x27;default&#x27;;
			}
			return lc(val);
		}
		return val;
	},
	toggle : function(wrapper, map) {
		var self = this;
		if (self.commonNode(map)) {
			self.remove(map);
		} else {
			self.wrap(wrapper);
		}
		return self.select();
	},
	bold : function() {
		return this.toggle(&#x27;&lt;strong&gt;&lt;/strong&gt;&#x27;, {
			span : &#x27;.font-weight=bold&#x27;,
			strong : &#x27;*&#x27;,
			b : &#x27;*&#x27;
		});
	},
	italic : function() {
		return this.toggle(&#x27;&lt;em&gt;&lt;/em&gt;&#x27;, {
			span : &#x27;.font-style=italic&#x27;,
			em : &#x27;*&#x27;,
			i : &#x27;*&#x27;
		});
	},
	underline : function() {
		return this.toggle(&#x27;&lt;u&gt;&lt;/u&gt;&#x27;, {
			span : &#x27;.text-decoration=underline&#x27;,
			u : &#x27;*&#x27;
		});
	},
	strikethrough : function() {
		return this.toggle(&#x27;&lt;s&gt;&lt;/s&gt;&#x27;, {
			span : &#x27;.text-decoration=line-through&#x27;,
			s : &#x27;*&#x27;
		});
	},
	forecolor : function(val) {
		return this.toggle(&#x27;&lt;span style=&quot;color:&#x27; + val + &#x27;;&quot;&gt;&lt;/span&gt;&#x27;, {
			span : &#x27;.color=&#x27; + val,
			font : &#x27;color&#x27;
		});
	},
	hilitecolor : function(val) {
		return this.toggle(&#x27;&lt;span style=&quot;background-color:&#x27; + val + &#x27;;&quot;&gt;&lt;/span&gt;&#x27;, {
			span : &#x27;.background-color=&#x27; + val
		});
	},
	fontsize : function(val) {
		return this.toggle(&#x27;&lt;span style=&quot;font-size:&#x27; + val + &#x27;;&quot;&gt;&lt;/span&gt;&#x27;, {
			span : &#x27;.font-size=&#x27; + val,
			font : &#x27;size&#x27;
		});
	},
	fontname : function(val) {
		return this.fontfamily(val);
	},
	fontfamily : function(val) {
		return this.toggle(&#x27;&lt;span style=&quot;font-family:&#x27; + val + &#x27;;&quot;&gt;&lt;/span&gt;&#x27;, {
			span : &#x27;.font-family=&#x27; + val,
			font : &#x27;face&#x27;
		});
	},
	removeformat : function() {
		var map = {
			&#x27;*&#x27; : &#x27;.font-weight,.font-style,.text-decoration,.color,.background-color,.font-size,.font-family,.text-indent&#x27;
		},
		tags = _STYLE_TAG_MAP;
		_each(tags, function(key, val) {
			map[key] = &#x27;*&#x27;;
		});
		this.remove(map);
		return this.select();
	},
	inserthtml : function(val, quickMode) {
		var self = this, range = self.range;
		if (val === &#x27;&#x27;) {
			return self;
		}
		function pasteHtml(range, val) {
			val = &#x27;&lt;img id=&quot;__kindeditor_temp_tag__&quot; width=&quot;0&quot; height=&quot;0&quot; style=&quot;display:none;&quot; /&gt;&#x27; + val;
			var rng = range.get();
			if (rng.item) {
				rng.item(0).outerHTML = val;
			} else {
				rng.pasteHTML(val);
			}
			var temp = range.doc.getElementById(&#x27;__kindeditor_temp_tag__&#x27;);
			temp.parentNode.removeChild(temp);
			var newRange = _toRange(rng);
			range.setEnd(newRange.endContainer, newRange.endOffset);
			range.collapse(false);
			self.select(false);
		}
		function insertHtml(range, val) {
			var doc = range.doc,
				frag = doc.createDocumentFragment();
			K(&#x27;@&#x27; + val, doc).each(function() {
				frag.appendChild(this);
			});
			range.deleteContents();
			range.insertNode(frag);
			range.collapse(false);
			self.select(false);
		}
		if (_IE &amp;&amp; quickMode) {
			try {
				pasteHtml(range, val);
			} catch(e) {
				insertHtml(range, val);
			}
			return self;
		}
		insertHtml(range, val);
		return self;
	},
	hr : function() {
		return this.inserthtml(&#x27;&lt;hr /&gt;&#x27;);
	},
	print : function() {
		this.win.print();
		return this;
	},
	insertimage : function(url, title, width, height, border, align) {
		title = _undef(title, &#x27;&#x27;);
		border = _undef(border, 0);
		var html = &#x27;&lt;img src=&quot;&#x27; + _escape(url) + &#x27;&quot; data-ke-src=&quot;&#x27; + _escape(url) + &#x27;&quot; &#x27;;
		if (width) {
			html += &#x27;width=&quot;&#x27; + _escape(width) + &#x27;&quot; &#x27;;
		}
		if (height) {
			html += &#x27;height=&quot;&#x27; + _escape(height) + &#x27;&quot; &#x27;;
		}
		if (title) {
			html += &#x27;title=&quot;&#x27; + _escape(title) + &#x27;&quot; &#x27;;
		}
		if (align) {
			html += &#x27;align=&quot;&#x27; + _escape(align) + &#x27;&quot; &#x27;;
		}
		html += &#x27;alt=&quot;&#x27; + _escape(title) + &#x27;&quot; &#x27;;
		html += &#x27;/&gt;&#x27;;
		return this.inserthtml(html);
	},
	createlink : function(url, type) {
		var self = this, doc = self.doc, range = self.range;
		self.select();
		var a = self.commonNode({ a : &#x27;*&#x27; });
		if (a &amp;&amp; !range.isControl()) {
			range.selectNode(a.get());
			self.select();
		}
		var html = &#x27;&lt;a href=&quot;&#x27; + _escape(url) + &#x27;&quot; data-ke-src=&quot;&#x27; + _escape(url) + &#x27;&quot; &#x27;;
		if (type) {
			html += &#x27; target=&quot;&#x27; + _escape(type) + &#x27;&quot;&#x27;;
		}
		if (range.collapsed) {
			html += &#x27;&gt;&#x27; + _escape(url) + &#x27;&lt;/a&gt;&#x27;;
			return self.inserthtml(html);
		}
		if (range.isControl()) {
			var node = K(range.startContainer.childNodes[range.startOffset]);
			html += &#x27;&gt;&lt;/a&gt;&#x27;;
			node.after(K(html, doc));
			node.next().append(node);
			range.selectNode(node[0]);
			return self.select();
		}
		_nativeCommand(doc, &#x27;createlink&#x27;, &#x27;__kindeditor_temp_url__&#x27;);
		K(&#x27;a[href=&quot;__kindeditor_temp_url__&quot;]&#x27;, doc).each(function() {
			K(this).attr(&#x27;href&#x27;, url).attr(&#x27;data-ke-src&#x27;, url);
			if (type) {
				K(this).attr(&#x27;target&#x27;, type);
			} else {
				K(this).removeAttr(&#x27;target&#x27;);
			}
		});
		return self;
	},
	unlink : function() {
		var self = this, doc = self.doc, range = self.range;
		self.select();
		if (range.collapsed) {
			var a = self.commonNode({ a : &#x27;*&#x27; });
			if (a) {
				range.selectNode(a.get());
				self.select();
			}
			_nativeCommand(doc, &#x27;unlink&#x27;, null);
			if (_WEBKIT &amp;&amp; K(range.startContainer).name === &#x27;img&#x27;) {
				var parent = K(range.startContainer).parent();
				if (parent.name === &#x27;a&#x27;) {
					parent.remove(true);
				}
			}
		} else {
			_nativeCommand(doc, &#x27;unlink&#x27;, null);
		}
		return self;
	}
});
_each((&#x27;formatblock,selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,&#x27; +
	&#x27;insertunorderedlist,indent,outdent,subscript,superscript&#x27;).split(&#x27;,&#x27;), function(i, name) {
	KCmd.prototype[name] = function(val) {
		var self = this;
		self.select();
		_nativeCommand(self.doc, name, val);
		if (!_IE || _inArray(name, &#x27;formatblock,selectall,insertorderedlist,insertunorderedlist&#x27;.split(&#x27;,&#x27;)) &gt;= 0) {
			self.selection();
		}
		return self;
	};
});
_each(&#x27;cut,copy,paste&#x27;.split(&#x27;,&#x27;), function(i, name) {
	KCmd.prototype[name] = function() {
		var self = this;
		if (!self.doc.queryCommandSupported(name)) {
			throw &#x27;not supported&#x27;;
		}
		self.select();
		_nativeCommand(self.doc, name, null);
		return self;
	};
});
function _cmd(mixed) {
	if (mixed.nodeName) {
		var doc = _getDoc(mixed);
		mixed = _range(doc).selectNodeContents(doc.body).collapse(false);
	}
	return new KCmd(mixed);
}
K.CmdClass = KCmd;
K.cmd = _cmd;
function _drag(options) {
	var moveEl = options.moveEl,
		moveFn = options.moveFn,
		clickEl = options.clickEl || moveEl,
		beforeDrag = options.beforeDrag,
		iframeFix = options.iframeFix === undefined ? true : options.iframeFix;
	var docs = [document];
	if (iframeFix) {
		K(&#x27;iframe&#x27;).each(function() {
			var src = _formatUrl(this.src || &#x27;&#x27;, &#x27;absolute&#x27;);
			if (/^https?:\/\//.test(src)) {
				return;
			}
			var doc;
			try {
				doc = _iframeDoc(this);
			} catch(e) {}
			if (doc) {
				var pos = K(this).pos();
				K(doc).data(&#x27;pos-x&#x27;, pos.x);
				K(doc).data(&#x27;pos-y&#x27;, pos.y);
				docs.push(doc);
			}
		});
	}
	clickEl.mousedown(function(e) {
		e.stopPropagation();
		var self = clickEl.get(),
			x = _removeUnit(moveEl.css(&#x27;left&#x27;)),
			y = _removeUnit(moveEl.css(&#x27;top&#x27;)),
			width = moveEl.width(),
			height = moveEl.height(),
			pageX = e.pageX,
			pageY = e.pageY;
		if (beforeDrag) {
			beforeDrag();
		}
		function moveListener(e) {
			e.preventDefault();
			var kdoc = K(_getDoc(e.target));
			var diffX = _round((kdoc.data(&#x27;pos-x&#x27;) || 0) + e.pageX - pageX);
			var diffY = _round((kdoc.data(&#x27;pos-y&#x27;) || 0) + e.pageY - pageY);
			moveFn.call(clickEl, x, y, width, height, diffX, diffY);
		}
		function selectListener(e) {
			e.preventDefault();
		}
		function upListener(e) {
			e.preventDefault();
			K(docs).unbind(&#x27;mousemove&#x27;, moveListener)
				.unbind(&#x27;mouseup&#x27;, upListener)
				.unbind(&#x27;selectstart&#x27;, selectListener);
			if (self.releaseCapture) {
				self.releaseCapture();
			}
		}
		K(docs).mousemove(moveListener)
			.mouseup(upListener)
			.bind(&#x27;selectstart&#x27;, selectListener);
		if (self.setCapture) {
			self.setCapture();
		}
	});
}
function KWidget(options) {
	this.init(options);
}
_extend(KWidget, {
	init : function(options) {
		var self = this;
		self.name = options.name || &#x27;&#x27;;
		self.doc = options.doc || document;
		self.win = _getWin(self.doc);
		self.x = _addUnit(options.x);
		self.y = _addUnit(options.y);
		self.z = options.z;
		self.width = _addUnit(options.width);
		self.height = _addUnit(options.height);
		self.div = K(&#x27;&lt;div style=&quot;display:block;&quot;&gt;&lt;/div&gt;&#x27;);
		self.options = options;
		self._alignEl = options.alignEl;
		if (self.width) {
			self.div.css(&#x27;width&#x27;, self.width);
		}
		if (self.height) {
			self.div.css(&#x27;height&#x27;, self.height);
		}
		if (self.z) {
			self.div.css({
				position : &#x27;absolute&#x27;,
				left : self.x,
				top : self.y,
				&#x27;z-index&#x27; : self.z
			});
		}
		if (self.z &amp;&amp; (self.x === undefined || self.y === undefined)) {
			self.autoPos(self.width, self.height);
		}
		if (options.cls) {
			self.div.addClass(options.cls);
		}
		if (options.shadowMode) {
			self.div.addClass(&#x27;ke-shadow&#x27;);
		}
		if (options.css) {
			self.div.css(options.css);
		}
		if (options.src) {
			K(options.src).replaceWith(self.div);
		} else {
			K(self.doc.body).append(self.div);
		}
		if (options.html) {
			self.div.html(options.html);
		}
		if (options.autoScroll) {
			if (_IE &amp;&amp; _V &lt; 7 || _QUIRKS) {
				var scrollPos = _getScrollPos();
				K(self.win).bind(&#x27;scroll&#x27;, function(e) {
					var pos = _getScrollPos(),
						diffX = pos.x - scrollPos.x,
						diffY = pos.y - scrollPos.y;
					self.pos(_removeUnit(self.x) + diffX, _removeUnit(self.y) + diffY, false);
				});
			} else {
				self.div.css(&#x27;position&#x27;, &#x27;fixed&#x27;);
			}
		}
	},
	pos : function(x, y, updateProp) {
		var self = this;
		updateProp = _undef(updateProp, true);
		if (x !== null) {
			x = x &lt; 0 ? 0 : _addUnit(x);
			self.div.css(&#x27;left&#x27;, x);
			if (updateProp) {
				self.x = x;
			}
		}
		if (y !== null) {
			y = y &lt; 0 ? 0 : _addUnit(y);
			self.div.css(&#x27;top&#x27;, y);
			if (updateProp) {
				self.y = y;
			}
		}
		return self;
	},
	autoPos : function(width, height) {
		var self = this,
			w = _removeUnit(width) || 0,
			h = _removeUnit(height) || 0,
			scrollPos = _getScrollPos();
		if (self._alignEl) {
			var knode = K(self._alignEl),
				pos = knode.pos(),
				diffX = _round(knode[0].clientWidth / 2 - w / 2),
				diffY = _round(knode[0].clientHeight / 2 - h / 2);
			x = diffX &lt; 0 ? pos.x : pos.x + diffX;
			y = diffY &lt; 0 ? pos.y : pos.y + diffY;
		} else {
			var docEl = _docElement(self.doc);
			x = _round(scrollPos.x + (docEl.clientWidth - w) / 2);
			y = _round(scrollPos.y + (docEl.clientHeight - h) / 2);
		}
		if (!(_IE &amp;&amp; _V &lt; 7 || _QUIRKS)) {
			x -= scrollPos.x;
			y -= scrollPos.y;
		}
		return self.pos(x, y);
	},
	remove : function() {
		var self = this;
		if (_IE &amp;&amp; _V &lt; 7 || _QUIRKS) {
			K(self.win).unbind(&#x27;scroll&#x27;);
		}
		self.div.remove();
		_each(self, function(i) {
			self[i] = null;
		});
		return this;
	},
	show : function() {
		this.div.show();
		return this;
	},
	hide : function() {
		this.div.hide();
		return this;
	},
	draggable : function(options) {
		var self = this;
		options = options || {};
		options.moveEl = self.div;
		options.moveFn = function(x, y, width, height, diffX, diffY) {
			if ((x = x + diffX) &lt; 0) {
				x = 0;
			}
			if ((y = y + diffY) &lt; 0) {
				y = 0;
			}
			self.pos(x, y);
		};
		_drag(options);
		return self;
	}
});
function _widget(options) {
	return new KWidget(options);
}
K.WidgetClass = KWidget;
K.widget = _widget;
function _iframeDoc(iframe) {
	iframe = _get(iframe);
	return iframe.contentDocument || iframe.contentWindow.document;
}
var html, _direction = &#x27;&#x27;;
if ((html = document.getElementsByTagName(&#x27;html&#x27;))) {
	_direction = html[0].dir;
}
function _getInitHtml(themesPath, bodyClass, cssPath, cssData) {
	var arr = [
		(_direction === &#x27;&#x27; ? &#x27;&lt;html&gt;&#x27; : &#x27;&lt;html dir=&quot;&#x27; + _direction + &#x27;&quot;&gt;&#x27;),
		&#x27;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot; /&gt;&lt;title&gt;&lt;/title&gt;&#x27;,
		&#x27;&lt;style&gt;&#x27;,
		&#x27;html {margin:0;padding:0;}&#x27;,
		&#x27;body {margin:0;padding:5px;}&#x27;,
		&#x27;body, td {font:12px/1.5 &quot;sans serif&quot;,tahoma,verdana,helvetica;}&#x27;,
		&#x27;body, p, div {word-wrap: break-word;}&#x27;,
		&#x27;p {margin:5px 0;}&#x27;,
		&#x27;table {border-collapse:collapse;}&#x27;,
		&#x27;img {border:0;}&#x27;,
		&#x27;noscript {display:none;}&#x27;,
		&#x27;table.ke-zeroborder td {border:1px dotted #AAA;}&#x27;,
		&#x27;img.ke-flash {&#x27;,
		&#x27;	border:1px solid #AAA;&#x27;,
		&#x27;	background-image:url(&#x27; + themesPath + &#x27;common/flash.gif);&#x27;,
		&#x27;	background-position:center center;&#x27;,
		&#x27;	background-repeat:no-repeat;&#x27;,
		&#x27;	width:100px;&#x27;,
		&#x27;	height:100px;&#x27;,
		&#x27;}&#x27;,
		&#x27;img.ke-rm {&#x27;,
		&#x27;	border:1px solid #AAA;&#x27;,
		&#x27;	background-image:url(&#x27; + themesPath + &#x27;common/rm.gif);&#x27;,
		&#x27;	background-position:center center;&#x27;,
		&#x27;	background-repeat:no-repeat;&#x27;,
		&#x27;	width:100px;&#x27;,
		&#x27;	height:100px;&#x27;,
		&#x27;}&#x27;,
		&#x27;img.ke-media {&#x27;,
		&#x27;	border:1px solid #AAA;&#x27;,
		&#x27;	background-image:url(&#x27; + themesPath + &#x27;common/media.gif);&#x27;,
		&#x27;	background-position:center center;&#x27;,
		&#x27;	background-repeat:no-repeat;&#x27;,
		&#x27;	width:100px;&#x27;,
		&#x27;	height:100px;&#x27;,
		&#x27;}&#x27;,
		&#x27;img.ke-anchor {&#x27;,
		&#x27;	border:1px dashed #666;&#x27;,
		&#x27;	width:16px;&#x27;,
		&#x27;	height:16px;&#x27;,
		&#x27;}&#x27;,
		&#x27;.ke-script, .ke-noscript, .ke-display-none {&#x27;,
		&#x27;	display:none;&#x27;,
		&#x27;	font-size:0;&#x27;,
		&#x27;	width:0;&#x27;,
		&#x27;	height:0;&#x27;,
		&#x27;}&#x27;,
		&#x27;.ke-pagebreak {&#x27;,
		&#x27;	border:1px dotted #AAA;&#x27;,
		&#x27;	font-size:0;&#x27;,
		&#x27;	height:2px;&#x27;,
		&#x27;}&#x27;,
		&#x27;&lt;/style&gt;&#x27;
	];
	if (!_isArray(cssPath)) {
		cssPath = [cssPath];
	}
	_each(cssPath, function(i, path) {
		if (path) {
			arr.push(&#x27;&lt;link href=&quot;&#x27; + path + &#x27;&quot; rel=&quot;stylesheet&quot; /&gt;&#x27;);
		}
	});
	if (cssData) {
		arr.push(&#x27;&lt;style&gt;&#x27; + cssData + &#x27;&lt;/style&gt;&#x27;);
	}
	arr.push(&#x27;&lt;/head&gt;&lt;body &#x27; + (bodyClass ? &#x27;class=&quot;&#x27; + bodyClass + &#x27;&quot;&#x27; : &#x27;&#x27;) + &#x27;&gt;&lt;/body&gt;&lt;/html&gt;&#x27;);
	return arr.join(&#x27;\n&#x27;);
}
function _elementVal(knode, val) {
	if (knode.hasVal()) {
		if (val === undefined) {
			var html = knode.val();
			html = html.replace(/(&lt;(?:p|p\s[^&gt;]*)&gt;) *(&lt;\/p&gt;)/ig, &#x27;&#x27;);
			return html;
		}
		return knode.val(val);
	}
	return knode.html(val);
}
function KEdit(options) {
	this.init(options);
}
_extend(KEdit, KWidget, {
	init : function(options) {
		var self = this;
		KEdit.parent.init.call(self, options);
		self.srcElement = K(options.srcElement);
		self.div.addClass(&#x27;ke-edit&#x27;);
		self.designMode = _undef(options.designMode, true);
		self.beforeGetHtml = options.beforeGetHtml;
		self.beforeSetHtml = options.beforeSetHtml;
		self.afterSetHtml = options.afterSetHtml;
		var themesPath = _undef(options.themesPath, &#x27;&#x27;),
			bodyClass = options.bodyClass,
			cssPath = options.cssPath,
			cssData = options.cssData,
			isDocumentDomain = location.host.replace(/:\d+/, &#x27;&#x27;) !== document.domain,
			srcScript = (&#x27;document.open();&#x27; +
				(isDocumentDomain ? &#x27;document.domain=&quot;&#x27; + document.domain + &#x27;&quot;;&#x27; : &#x27;&#x27;) +
				&#x27;document.close();&#x27;),
			iframeSrc = _IE ? &#x27; src=&quot;javascript:void(function(){&#x27; + encodeURIComponent(srcScript) + &#x27;}())&quot;&#x27; : &#x27;&#x27;;
		self.iframe = K(&#x27;&lt;iframe class=&quot;ke-edit-iframe&quot; hidefocus=&quot;true&quot; frameborder=&quot;0&quot;&#x27; + iframeSrc + &#x27;&gt;&lt;/iframe&gt;&#x27;).css(&#x27;width&#x27;, &#x27;100%&#x27;);
		self.textarea = K(&#x27;&lt;textarea class=&quot;ke-edit-textarea&quot; hidefocus=&quot;true&quot;&gt;&lt;/textarea&gt;&#x27;).css(&#x27;width&#x27;, &#x27;100%&#x27;);
		if (self.width) {
			self.setWidth(self.width);
		}
		if (self.height) {
			self.setHeight(self.height);
		}
		if (self.designMode) {
			self.textarea.hide();
		} else {
			self.iframe.hide();
		}
		function ready() {
			var doc = _iframeDoc(self.iframe);
			doc.open();
			if (isDocumentDomain) {
				doc.domain = document.domain;
			}
			doc.write(_getInitHtml(themesPath, bodyClass, cssPath, cssData));
			doc.close();
			self.win = self.iframe[0].contentWindow;
			self.doc = doc;
			var cmd = _cmd(doc);
			self.afterChange(function(e) {
				cmd.selection();
			});
			if (_WEBKIT) {
				K(doc).click(function(e) {
					if (K(e.target).name === &#x27;img&#x27;) {
						cmd.selection(true);
						cmd.range.selectNode(e.target);
						cmd.select();
					}
				});
			}
			if (_IE) {
				self._mousedownHandler = function() {
					var newRange = cmd.range.cloneRange();
					newRange.shrink();
					if (newRange.isControl()) {
						self.blur();
					}
				};
				K(document).mousedown(self._mousedownHandler);
				K(doc).keydown(function(e) {
					if (e.which == 8) {
						cmd.selection();
						var rng = cmd.range;
						if (rng.isControl()) {
							rng.collapse(true);
							K(rng.startContainer.childNodes[rng.startOffset]).remove();
							e.preventDefault();
						}
					}
				});
			}
			self.cmd = cmd;
			self.html(_elementVal(self.srcElement));
			if (_IE) {
				doc.body.disabled = true;
				doc.body.contentEditable = true;
				doc.body.removeAttribute(&#x27;disabled&#x27;);
			} else {
				doc.designMode = &#x27;on&#x27;;
			}
			if (options.afterCreate) {
				options.afterCreate.call(self);
			}
		}
		if (isDocumentDomain) {
			self.iframe.bind(&#x27;load&#x27;, function(e) {
				self.iframe.unbind(&#x27;load&#x27;);
				if (_IE) {
					ready();
				} else {
					setTimeout(ready, 0);
				}
			});
		}
		self.div.append(self.iframe);
		self.div.append(self.textarea);
		self.srcElement.hide();
		!isDocumentDomain &amp;&amp; ready();
	},
	setWidth : function(val) {
		this.div.css(&#x27;width&#x27;, _addUnit(val));
		return this;
	},
	setHeight : function(val) {
		var self = this;
		val = _addUnit(val);
		self.div.css(&#x27;height&#x27;, val);
		self.iframe.css(&#x27;height&#x27;, val);
		if ((_IE &amp;&amp; _V &lt; 8) || _QUIRKS) {
			val = _addUnit(_removeUnit(val) - 2);
		}
		self.textarea.css(&#x27;height&#x27;, val);
		return self;
	},
	remove : function() {
		var self = this, doc = self.doc;
		K(doc.body).unbind();
		K(doc).unbind();
		K(self.win).unbind();
		if (self._mousedownHandler) {
			K(document).unbind(&#x27;mousedown&#x27;, self._mousedownHandler);
		}
		_elementVal(self.srcElement, self.html());
		self.srcElement.show();
		doc.write(&#x27;&#x27;);
		self.iframe.unbind();
		self.textarea.unbind();
		KEdit.parent.remove.call(self);
	},
	html : function(val, isFull) {
		var self = this, doc = self.doc;
		if (self.designMode) {
			var body = doc.body;
			if (val === undefined) {
				if (isFull) {
					val = &#x27;&lt;!doctype html&gt;&lt;html&gt;&#x27; + body.parentNode.innerHTML + &#x27;&lt;/html&gt;&#x27;;
				} else {
					val = body.innerHTML;
				}
				if (self.beforeGetHtml) {
					val = self.beforeGetHtml(val);
				}
				if (_GECKO &amp;&amp; val == &#x27;&lt;br /&gt;&#x27;) {
					val = &#x27;&#x27;;
				}
				return val;
			}
			if (self.beforeSetHtml) {
				val = self.beforeSetHtml(val);
			}
			if (_IE &amp;&amp; _V &gt;= 9) {
				val = val.replace(/(&lt;.*?checked=&quot;)checked(&quot;.*&gt;)/ig, &#x27;$1$2&#x27;);
			}
			K(body).html(val);
			if (self.afterSetHtml) {
				self.afterSetHtml();
			}
			return self;
		}
		if (val === undefined) {
			return self.textarea.val();
		}
		self.textarea.val(val);
		return self;
	},
	design : function(bool) {
		var self = this, val;
		if (bool === undefined ? !self.designMode : bool) {
			if (!self.designMode) {
				val = self.html();
				self.designMode = true;
				self.html(val);
				self.textarea.hide();
				self.iframe.show();
			}
		} else {
			if (self.designMode) {
				val = self.html();
				self.designMode = false;
				self.html(val);
				self.iframe.hide();
				self.textarea.show();
			}
		}
		return self.focus();
	},
	focus : function() {
		var self = this;
		self.designMode ? self.win.focus() : self.textarea[0].focus();
		return self;
	},
	blur : function() {
		var self = this;
		if (_IE) {
			var input = K(&#x27;&lt;input type=&quot;text&quot; style=&quot;float:left;width:0;height:0;padding:0;margin:0;border:0;&quot; value=&quot;&quot; /&gt;&#x27;, self.div);
			self.div.append(input);
			input[0].focus();
			input.remove();
		} else {
			self.designMode ? self.win.blur() : self.textarea[0].blur();
		}
		return self;
	},
	afterChange : function(fn) {
		var self = this, doc = self.doc, body = doc.body;
		K(doc).keyup(function(e) {
			if (!e.ctrlKey &amp;&amp; !e.altKey &amp;&amp; _CHANGE_KEY_MAP[e.which]) {
				fn(e);
			}
		});
		K(doc).mouseup(fn).contextmenu(fn);
		K(self.win).blur(fn);
		function timeoutHandler(e) {
			setTimeout(function() {
				fn(e);
			}, 1);
		}
		K(body).bind(&#x27;paste&#x27;, timeoutHandler);
		K(body).bind(&#x27;cut&#x27;, timeoutHandler);
		return self;
	}
});
function _edit(options) {
	return new KEdit(options);
}
K.EditClass = KEdit;
K.edit = _edit;
K.iframeDoc = _iframeDoc;
function _selectToolbar(name, fn) {
	var self = this,
		knode = self.get(name);
	if (knode) {
		if (knode.hasClass(&#x27;ke-disabled&#x27;)) {
			return;
		}
		fn(knode);
	}
}
function KToolbar(options) {
	this.init(options);
}
_extend(KToolbar, KWidget, {
	init : function(options) {
		var self = this;
		KToolbar.parent.init.call(self, options);
		self.disableMode = _undef(options.disableMode, false);
		self.noDisableItemMap = _toMap(_undef(options.noDisableItems, []));
		self._itemMap = {};
		self.div.addClass(&#x27;ke-toolbar&#x27;).bind(&#x27;contextmenu,mousedown,mousemove&#x27;, function(e) {
			e.preventDefault();
		}).attr(&#x27;unselectable&#x27;, &#x27;on&#x27;);
		function find(target) {
			var knode = K(target);
			if (knode.hasClass(&#x27;ke-outline&#x27;)) {
				return knode;
			}
			if (knode.hasClass(&#x27;ke-toolbar-icon&#x27;)) {
				return knode.parent();
			}
		}
		function hover(e, method) {
			var knode = find(e.target);
			if (knode) {
				if (knode.hasClass(&#x27;ke-disabled&#x27;)) {
					return;
				}
				if (knode.hasClass(&#x27;ke-selected&#x27;)) {
					return;
				}
				knode[method](&#x27;ke-on&#x27;);
			}
		}
		self.div.mouseover(function(e) {
			hover(e, &#x27;addClass&#x27;);
		})
		.mouseout(function(e) {
			hover(e, &#x27;removeClass&#x27;);
		})
		.click(function(e) {
			var knode = find(e.target);
			if (knode) {
				if (knode.hasClass(&#x27;ke-disabled&#x27;)) {
					return;
				}
				self.options.click.call(this, e, knode.attr(&#x27;data-name&#x27;));
			}
		});
	},
	get : function(name) {
		if (this._itemMap[name]) {
			return this._itemMap[name];
		}
		return (this._itemMap[name] = K(&#x27;span.ke-icon-&#x27; + name, this.div).parent());
	},
	select : function(name) {
		_selectToolbar.call(this, name, function(knode) {
			knode.addClass(&#x27;ke-selected&#x27;);
		});
		return self;
	},
	unselect : function(name) {
		_selectToolbar.call(this, name, function(knode) {
			knode.removeClass(&#x27;ke-selected&#x27;).removeClass(&#x27;ke-on&#x27;);
		});
		return self;
	},
	enable : function(name) {
		var self = this,
			knode = name.get ? name : self.get(name);
		if (knode) {
			knode.removeClass(&#x27;ke-disabled&#x27;);
			knode.opacity(1);
		}
		return self;
	},
	disable : function(name) {
		var self = this,
			knode = name.get ? name : self.get(name);
		if (knode) {
			knode.removeClass(&#x27;ke-selected&#x27;).addClass(&#x27;ke-disabled&#x27;);
			knode.opacity(0.5);
		}
		return self;
	},
	disableAll : function(bool, noDisableItems) {
		var self = this, map = self.noDisableItemMap, item;
		if (noDisableItems) {
			map = _toMap(noDisableItems);
		}
		if (bool === undefined ? !self.disableMode : bool) {
			K(&#x27;span.ke-outline&#x27;, self.div).each(function() {
				var knode = K(this),
					name = knode[0].getAttribute(&#x27;data-name&#x27;, 2);
				if (!map[name]) {
					self.disable(knode);
				}
			});
			self.disableMode = true;
		} else {
			K(&#x27;span.ke-outline&#x27;, self.div).each(function() {
				var knode = K(this),
					name = knode[0].getAttribute(&#x27;data-name&#x27;, 2);
				if (!map[name]) {
					self.enable(knode);
				}
			});
			self.disableMode = false;
		}
		return self;
	}
});
function _toolbar(options) {
	return new KToolbar(options);
}
K.ToolbarClass = KToolbar;
K.toolbar = _toolbar;
function KMenu(options) {
	this.init(options);
}
_extend(KMenu, KWidget, {
	init : function(options) {
		var self = this;
		options.z = options.z || 811213;
		KMenu.parent.init.call(self, options);
		self.centerLineMode = _undef(options.centerLineMode, true);
		self.div.addClass(&#x27;ke-menu&#x27;).bind(&#x27;click,mousedown&#x27;, function(e){
			e.stopPropagation();
		}).attr(&#x27;unselectable&#x27;, &#x27;on&#x27;);
	},
	addItem : function(item) {
		var self = this;
		if (item.title === &#x27;-&#x27;) {
			self.div.append(K(&#x27;&lt;div class=&quot;ke-menu-separator&quot;&gt;&lt;/div&gt;&#x27;));
			return;
		}
		var itemDiv = K(&#x27;&lt;div class=&quot;ke-menu-item&quot; unselectable=&quot;on&quot;&gt;&lt;/div&gt;&#x27;),
			leftDiv = K(&#x27;&lt;div class=&quot;ke-inline-block ke-menu-item-left&quot;&gt;&lt;/div&gt;&#x27;),
			rightDiv = K(&#x27;&lt;div class=&quot;ke-inline-block ke-menu-item-right&quot;&gt;&lt;/div&gt;&#x27;),
			height = _addUnit(item.height),
			iconClass = _undef(item.iconClass, &#x27;&#x27;);
		self.div.append(itemDiv);
		if (height) {
			itemDiv.css(&#x27;height&#x27;, height);
			rightDiv.css(&#x27;line-height&#x27;, height);
		}
		var centerDiv;
		if (self.centerLineMode) {
			centerDiv = K(&#x27;&lt;div class=&quot;ke-inline-block ke-menu-item-center&quot;&gt;&lt;/div&gt;&#x27;);
			if (height) {
				centerDiv.css(&#x27;height&#x27;, height);
			}
		}
		itemDiv.mouseover(function(e) {
			K(this).addClass(&#x27;ke-menu-item-on&#x27;);
			if (centerDiv) {
				centerDiv.addClass(&#x27;ke-menu-item-center-on&#x27;);
			}
		})
		.mouseout(function(e) {
			K(this).removeClass(&#x27;ke-menu-item-on&#x27;);
			if (centerDiv) {
				centerDiv.removeClass(&#x27;ke-menu-item-center-on&#x27;);
			}
		})
		.click(function(e) {
			item.click.call(K(this));
			e.stopPropagation();
		})
		.append(leftDiv);
		if (centerDiv) {
			itemDiv.append(centerDiv);
		}
		itemDiv.append(rightDiv);
		if (item.checked) {
			iconClass = &#x27;ke-icon-checked&#x27;;
		}
		if (iconClass !== &#x27;&#x27;) {
			leftDiv.html(&#x27;&lt;span class=&quot;ke-inline-block ke-toolbar-icon ke-toolbar-icon-url &#x27; + iconClass + &#x27;&quot;&gt;&lt;/span&gt;&#x27;);
		}
		rightDiv.html(item.title);
		return self;
	},
	remove : function() {
		var self = this;
		if (self.options.beforeRemove) {
			self.options.beforeRemove.call(self);
		}
		K(&#x27;.ke-menu-item&#x27;, self.div[0]).unbind();
		KMenu.parent.remove.call(self);
		return self;
	}
});
function _menu(options) {
	return new KMenu(options);
}
K.MenuClass = KMenu;
K.menu = _menu;
function KColorPicker(options) {
	this.init(options);
}
_extend(KColorPicker, KWidget, {
	init : function(options) {
		var self = this;
		options.z = options.z || 811213;
		KColorPicker.parent.init.call(self, options);
		var colors = options.colors || [
			[&#x27;#E53333&#x27;, &#x27;#E56600&#x27;, &#x27;#FF9900&#x27;, &#x27;#64451D&#x27;, &#x27;#DFC5A4&#x27;, &#x27;#FFE500&#x27;],
			[&#x27;#009900&#x27;, &#x27;#006600&#x27;, &#x27;#99BB00&#x27;, &#x27;#B8D100&#x27;, &#x27;#60D978&#x27;, &#x27;#00D5FF&#x27;],
			[&#x27;#337FE5&#x27;, &#x27;#003399&#x27;, &#x27;#4C33E5&#x27;, &#x27;#9933E5&#x27;, &#x27;#CC33E5&#x27;, &#x27;#EE33EE&#x27;],
			[&#x27;#FFFFFF&#x27;, &#x27;#CCCCCC&#x27;, &#x27;#999999&#x27;, &#x27;#666666&#x27;, &#x27;#333333&#x27;, &#x27;#000000&#x27;]
		];
		self.selectedColor = (options.selectedColor || &#x27;&#x27;).toLowerCase();
		self._cells = [];
		self.div.addClass(&#x27;ke-colorpicker&#x27;).bind(&#x27;click,mousedown&#x27;, function(e){
			e.stopPropagation();
		}).attr(&#x27;unselectable&#x27;, &#x27;on&#x27;);
		var table = self.doc.createElement(&#x27;table&#x27;);
		self.div.append(table);
		table.className = &#x27;ke-colorpicker-table&#x27;;
		table.cellPadding = 0;
		table.cellSpacing = 0;
		table.border = 0;
		var row = table.insertRow(0), cell = row.insertCell(0);
		cell.colSpan = colors[0].length;
		self._addAttr(cell, &#x27;&#x27;, &#x27;ke-colorpicker-cell-top&#x27;);
		for (var i = 0; i &lt; colors.length; i++) {
			row = table.insertRow(i + 1);
			for (var j = 0; j &lt; colors[i].length; j++) {
				cell = row.insertCell(j);
				self._addAttr(cell, colors[i][j], &#x27;ke-colorpicker-cell&#x27;);
			}
		}
	},
	_addAttr : function(cell, color, cls) {
		var self = this;
		cell = K(cell).addClass(cls);
		if (self.selectedColor === color.toLowerCase()) {
			cell.addClass(&#x27;ke-colorpicker-cell-selected&#x27;);
		}
		cell.attr(&#x27;title&#x27;, color || self.options.noColor);
		cell.mouseover(function(e) {
			K(this).addClass(&#x27;ke-colorpicker-cell-on&#x27;);
		});
		cell.mouseout(function(e) {
			K(this).removeClass(&#x27;ke-colorpicker-cell-on&#x27;);
		});
		cell.click(function(e) {
			e.stop();
			self.options.click.call(K(this), color);
		});
		if (color) {
			cell.append(K(&#x27;&lt;div class=&quot;ke-colorpicker-cell-color&quot; unselectable=&quot;on&quot;&gt;&lt;/div&gt;&#x27;).css(&#x27;background-color&#x27;, color));
		} else {
			cell.html(self.options.noColor);
		}
		K(cell).attr(&#x27;unselectable&#x27;, &#x27;on&#x27;);
		self._cells.push(cell);
	},
	remove : function() {
		var self = this;
		_each(self._cells, function() {
			this.unbind();
		});
		KColorPicker.parent.remove.call(self);
		return self;
	}
});
function _colorpicker(options) {
	return new KColorPicker(options);
}
K.ColorPickerClass = KColorPicker;
K.colorpicker = _colorpicker;
function KUploadButton(options) {
	this.init(options);
}
_extend(KUploadButton, {
	init : function(options) {
		var self = this,
			button = K(options.button),
			fieldName = options.fieldName || &#x27;file&#x27;,
			url = options.url || &#x27;&#x27;,
			title = button.val(),
			extraParams = options.extraParams || {},
			cls = button[0].className || &#x27;&#x27;,
			target = options.target || &#x27;kindeditor_upload_iframe_&#x27; + new Date().getTime();
		options.afterError = options.afterError || function(str) {
			alert(str);
		};
		var hiddenElements = [];
		for(var k in extraParams){
			hiddenElements.push(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;&#x27; + k + &#x27;&quot; value=&quot;&#x27; + extraParams[k] + &#x27;&quot; /&gt;&#x27;);
		}
		var html = [
			&#x27;&lt;div class=&quot;ke-inline-block &#x27; + cls + &#x27;&quot;&gt;&#x27;,
			(options.target ? &#x27;&#x27; : &#x27;&lt;iframe name=&quot;&#x27; + target + &#x27;&quot; style=&quot;display:none;&quot;&gt;&lt;/iframe&gt;&#x27;),
			(options.form ? &#x27;&lt;div class=&quot;ke-upload-area&quot;&gt;&#x27; : &#x27;&lt;form class=&quot;ke-upload-area ke-form&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; target=&quot;&#x27; + target + &#x27;&quot; action=&quot;&#x27; + url + &#x27;&quot;&gt;&#x27;),
			&#x27;&lt;span class=&quot;ke-button-common&quot;&gt;&#x27;,
			hiddenElements.join(&#x27;&#x27;),
			&#x27;&lt;input type=&quot;button&quot; class=&quot;ke-button-common ke-button&quot; value=&quot;&#x27; + title + &#x27;&quot; /&gt;&#x27;,
			&#x27;&lt;/span&gt;&#x27;,
			&#x27;&lt;input type=&quot;file&quot; class=&quot;ke-upload-file&quot; name=&quot;&#x27; + fieldName + &#x27;&quot; tabindex=&quot;-1&quot; /&gt;&#x27;,
			(options.form ? &#x27;&lt;/div&gt;&#x27; : &#x27;&lt;/form&gt;&#x27;),
			&#x27;&lt;/div&gt;&#x27;].join(&#x27;&#x27;);
		var div = K(html, button.doc);
		button.hide();
		button.before(div);
		self.div = div;
		self.button = button;
		self.iframe = options.target ? K(&#x27;iframe[name=&quot;&#x27; + target + &#x27;&quot;]&#x27;) : K(&#x27;iframe&#x27;, div);
		self.form = options.form ? K(options.form) : K(&#x27;form&#x27;, div);
		var width = options.width || K(&#x27;.ke-button-common&#x27;, div).width();
		self.fileBox = K(&#x27;.ke-upload-file&#x27;, div).width(width);
		self.options = options;
	},
	submit : function() {
		var self = this,
			iframe = self.iframe;
		iframe.bind(&#x27;load&#x27;, function() {
			iframe.unbind();
			var tempForm = document.createElement(&#x27;form&#x27;);
			self.fileBox.before(tempForm);
			K(tempForm).append(self.fileBox);
			tempForm.reset();
			K(tempForm).remove(true);
			var doc = K.iframeDoc(iframe),
				pre = doc.getElementsByTagName(&#x27;pre&#x27;)[0],
				str = &#x27;&#x27;, data;
			if (pre) {
				str = pre.innerHTML;
			} else {
				str = doc.body.innerHTML;
			}
			str = _unescape(str);
			iframe[0].src = &#x27;javascript:false&#x27;;
			try {
				data = K.json(str);
			} catch (e) {
				self.options.afterError.call(self, &#x27;&lt;!doctype html&gt;&lt;html&gt;&#x27; + doc.body.parentNode.innerHTML + &#x27;&lt;/html&gt;&#x27;);
			}
			if (data) {
				self.options.afterUpload.call(self, data);
			}
		});
		self.form[0].submit();
		return self;
	},
	remove : function() {
		var self = this;
		if (self.fileBox) {
			self.fileBox.unbind();
		}
		self.iframe.remove();
		self.div.remove();
		self.button.show();
		return self;
	}
});
function _uploadbutton(options) {
	return new KUploadButton(options);
}
K.UploadButtonClass = KUploadButton;
K.uploadbutton = _uploadbutton;
function _createButton(arg) {
	arg = arg || {};
	var name = arg.name || &#x27;&#x27;,
		span = K(&#x27;&lt;span class=&quot;ke-button-common ke-button-outer&quot; title=&quot;&#x27; + name + &#x27;&quot;&gt;&lt;/span&gt;&#x27;),
		btn = K(&#x27;&lt;input class=&quot;ke-button-common ke-button&quot; type=&quot;button&quot; value=&quot;&#x27; + name + &#x27;&quot; /&gt;&#x27;);
	if (arg.click) {
		btn.click(arg.click);
	}
	span.append(btn);
	return span;
}
function KDialog(options) {
	this.init(options);
}
_extend(KDialog, KWidget, {
	init : function(options) {
		var self = this;
		var shadowMode = _undef(options.shadowMode, true);
		options.z = options.z || 811213;
		options.shadowMode = false;
		options.autoScroll = _undef(options.autoScroll, true);
		KDialog.parent.init.call(self, options);
		var title = options.title,
			body = K(options.body, self.doc),
			previewBtn = options.previewBtn,
			yesBtn = options.yesBtn,
			noBtn = options.noBtn,
			closeBtn = options.closeBtn,
			showMask = _undef(options.showMask, true);
		self.div.addClass(&#x27;ke-dialog&#x27;).bind(&#x27;click,mousedown&#x27;, function(e){
			e.stopPropagation();
		});
		var contentDiv = K(&#x27;&lt;div class=&quot;ke-dialog-content&quot;&gt;&lt;/div&gt;&#x27;).appendTo(self.div);
		if (_IE &amp;&amp; _V &lt; 7) {
			self.iframeMask = K(&#x27;&lt;iframe src=&quot;about:blank&quot; class=&quot;ke-dialog-shadow&quot;&gt;&lt;/iframe&gt;&#x27;).appendTo(self.div);
		} else if (shadowMode) {
			K(&#x27;&lt;div class=&quot;ke-dialog-shadow&quot;&gt;&lt;/div&gt;&#x27;).appendTo(self.div);
		}
		var headerDiv = K(&#x27;&lt;div class=&quot;ke-dialog-header&quot;&gt;&lt;/div&gt;&#x27;);
		contentDiv.append(headerDiv);
		headerDiv.html(title);
		self.closeIcon = K(&#x27;&lt;span class=&quot;ke-dialog-icon-close&quot; title=&quot;&#x27; + closeBtn.name + &#x27;&quot;&gt;&lt;/span&gt;&#x27;).click(closeBtn.click);
		headerDiv.append(self.closeIcon);
		self.draggable({
			clickEl : headerDiv,
			beforeDrag : options.beforeDrag
		});
		var bodyDiv = K(&#x27;&lt;div class=&quot;ke-dialog-body&quot;&gt;&lt;/div&gt;&#x27;);
		contentDiv.append(bodyDiv);
		bodyDiv.append(body);
		var footerDiv = K(&#x27;&lt;div class=&quot;ke-dialog-footer&quot;&gt;&lt;/div&gt;&#x27;);
		if (previewBtn || yesBtn || noBtn) {
			contentDiv.append(footerDiv);
		}
		_each([
			{ btn : previewBtn, name : &#x27;preview&#x27; },
			{ btn : yesBtn, name : &#x27;yes&#x27; },
			{ btn : noBtn, name : &#x27;no&#x27; }
		], function() {
			if (this.btn) {
				var button = _createButton(this.btn);
				button.addClass(&#x27;ke-dialog-&#x27; + this.name);
				footerDiv.append(button);
			}
		});
		if (self.height) {
			bodyDiv.height(_removeUnit(self.height) - headerDiv.height() - footerDiv.height());
		}
		self.div.width(self.div.width());
		self.div.height(self.div.height());
		self.mask = null;
		if (showMask) {
			var docEl = _docElement(self.doc),
				docWidth = Math.max(docEl.scrollWidth, docEl.clientWidth),
				docHeight = Math.max(docEl.scrollHeight, docEl.clientHeight);
			self.mask = _widget({
				x : 0,
				y : 0,
				z : self.z - 1,
				cls : &#x27;ke-dialog-mask&#x27;,
				width : docWidth,
				height : docHeight
			});
		}
		self.autoPos(self.div.width(), self.div.height());
		self.footerDiv = footerDiv;
		self.bodyDiv = bodyDiv;
		self.headerDiv = headerDiv;
		self.isLoading = false;
	},
	setMaskIndex : function(z) {
		var self = this;
		self.mask.div.css(&#x27;z-index&#x27;, z);
	},
	showLoading : function(msg) {
		msg = _undef(msg, &#x27;&#x27;);
		var self = this, body = self.bodyDiv;
		self.loading = K(&#x27;&lt;div class=&quot;ke-dialog-loading&quot;&gt;&lt;div class=&quot;ke-inline-block ke-dialog-loading-content&quot; style=&quot;margin-top:&#x27; + Math.round(body.height() / 3) + &#x27;px;&quot;&gt;&#x27; + msg + &#x27;&lt;/div&gt;&lt;/div&gt;&#x27;)
			.width(body.width()).height(body.height())
			.css(&#x27;top&#x27;, self.headerDiv.height() + &#x27;px&#x27;);
		body.css(&#x27;visibility&#x27;, &#x27;hidden&#x27;).after(self.loading);
		self.isLoading = true;
		return self;
	},
	hideLoading : function() {
		this.loading &amp;&amp; this.loading.remove();
		this.bodyDiv.css(&#x27;visibility&#x27;, &#x27;visible&#x27;);
		this.isLoading = false;
		return this;
	},
	remove : function() {
		var self = this;
		if (self.options.beforeRemove) {
			self.options.beforeRemove.call(self);
		}
		self.mask &amp;&amp; self.mask.remove();
		self.iframeMask &amp;&amp; self.iframeMask.remove();
		self.closeIcon.unbind();
		K(&#x27;input&#x27;, self.div).unbind();
		K(&#x27;button&#x27;, self.div).unbind();
		self.footerDiv.unbind();
		self.bodyDiv.unbind();
		self.headerDiv.unbind();
		K(&#x27;iframe&#x27;, self.div).each(function() {
			K(this).remove();
		});
		KDialog.parent.remove.call(self);
		return self;
	}
});
function _dialog(options) {
	return new KDialog(options);
}
K.DialogClass = KDialog;
K.dialog = _dialog;
function _tabs(options) {
	var self = _widget(options),
		remove = self.remove,
		afterSelect = options.afterSelect,
		div = self.div,
		liList = [];
	div.addClass(&#x27;ke-tabs&#x27;)
		.bind(&#x27;contextmenu,mousedown,mousemove&#x27;, function(e) {
			e.preventDefault();
		});
	var ul = K(&#x27;&lt;ul class=&quot;ke-tabs-ul ke-clearfix&quot;&gt;&lt;/ul&gt;&#x27;);
	div.append(ul);
	self.add = function(tab) {
		var li = K(&#x27;&lt;li class=&quot;ke-tabs-li&quot;&gt;&#x27; + tab.title + &#x27;&lt;/li&gt;&#x27;);
		li.data(&#x27;tab&#x27;, tab);
		liList.push(li);
		ul.append(li);
	};
	self.selectedIndex = 0;
	self.select = function(index) {
		self.selectedIndex = index;
		_each(liList, function(i, li) {
			li.unbind();
			if (i === index) {
				li.addClass(&#x27;ke-tabs-li-selected&#x27;);
				K(li.data(&#x27;tab&#x27;).panel).show(&#x27;&#x27;);
			} else {
				li.removeClass(&#x27;ke-tabs-li-selected&#x27;).removeClass(&#x27;ke-tabs-li-on&#x27;)
				.mouseover(function() {
					K(this).addClass(&#x27;ke-tabs-li-on&#x27;);
				})
				.mouseout(function() {
					K(this).removeClass(&#x27;ke-tabs-li-on&#x27;);
				})
				.click(function() {
					self.select(i);
				});
				K(li.data(&#x27;tab&#x27;).panel).hide();
			}
		});
		if (afterSelect) {
			afterSelect.call(self, index);
		}
	};
	self.remove = function() {
		_each(liList, function() {
			this.remove();
		});
		ul.remove();
		remove.call(self);
	};
	return self;
}
K.tabs = _tabs;
function _loadScript(url, fn) {
	var head = document.getElementsByTagName(&#x27;head&#x27;)[0] || (_QUIRKS ? document.body : document.documentElement),
		script = document.createElement(&#x27;script&#x27;);
	head.appendChild(script);
	script.src = url;
	script.charset = &#x27;utf-8&#x27;;
	script.onload = script.onreadystatechange = function() {
		if (!this.readyState || this.readyState === &#x27;loaded&#x27;) {
			if (fn) {
				fn();
			}
			script.onload = script.onreadystatechange = null;
			head.removeChild(script);
		}
	};
}
function _chopQuery(url) {
	var index = url.indexOf(&#x27;?&#x27;);
	return index &gt; 0 ? url.substr(0, index) : url;
}
function _loadStyle(url) {
	var head = document.getElementsByTagName(&#x27;head&#x27;)[0] || (_QUIRKS ? document.body : document.documentElement),
		link = document.createElement(&#x27;link&#x27;),
		absoluteUrl = _chopQuery(_formatUrl(url, &#x27;absolute&#x27;));
	var links = K(&#x27;link[rel=&quot;stylesheet&quot;]&#x27;, head);
	for (var i = 0, len = links.length; i &lt; len; i++) {
		if (_chopQuery(_formatUrl(links[i].href, &#x27;absolute&#x27;)) === absoluteUrl) {
			return;
		}
	}
	head.appendChild(link);
	link.href = url;
	link.rel = &#x27;stylesheet&#x27;;
}
function _ajax(url, fn, method, param, dataType) {
	method = method || &#x27;GET&#x27;;
	dataType = dataType || &#x27;json&#x27;;
	var xhr = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject(&#x27;Microsoft.XMLHTTP&#x27;);
	xhr.open(method, url, true);
	xhr.onreadystatechange = function () {
		if (xhr.readyState == 4 &amp;&amp; xhr.status == 200) {
			if (fn) {
				var data = _trim(xhr.responseText);
				if (dataType == &#x27;json&#x27;) {
					data = _json(data);
				}
				fn(data);
			}
		}
	};
	if (method == &#x27;POST&#x27;) {
		var params = [];
		_each(param, function(key, val) {
			params.push(encodeURIComponent(key) + &#x27;=&#x27; + encodeURIComponent(val));
		});
		try {
			xhr.setRequestHeader(&#x27;Content-Type&#x27;, &#x27;application/x-www-form-urlencoded&#x27;);
		} catch (e) {}
		xhr.send(params.join(&#x27;&amp;&#x27;));
	} else {
		xhr.send(null);
	}
}
K.loadScript = _loadScript;
K.loadStyle = _loadStyle;
K.ajax = _ajax;
var _plugins = {};
function _plugin(name, fn) {
	if (name === undefined) {
		return _plugins;
	}
	if (!fn) {
		return _plugins[name];
	}
	_plugins[name] = fn;
}
var _language = {};
function _parseLangKey(key) {
	var match, ns = &#x27;core&#x27;;
	if ((match = /^(\w+)\.(\w+)$/.exec(key))) {
		ns = match[1];
		key = match[2];
	}
	return { ns : ns, key : key };
}
function _lang(mixed, langType) {
	langType = langType === undefined ? K.options.langType : langType;
	if (typeof mixed === &#x27;string&#x27;) {
		if (!_language[langType]) {
			return &#x27;no language&#x27;;
		}
		var pos = mixed.length - 1;
		if (mixed.substr(pos) === &#x27;.&#x27;) {
			return _language[langType][mixed.substr(0, pos)];
		}
		var obj = _parseLangKey(mixed);
		return _language[langType][obj.ns][obj.key];
	}
	_each(mixed, function(key, val) {
		var obj = _parseLangKey(key);
		if (!_language[langType]) {
			_language[langType] = {};
		}
		if (!_language[langType][obj.ns]) {
			_language[langType][obj.ns] = {};
		}
		_language[langType][obj.ns][obj.key] = val;
	});
}
function _getImageFromRange(range, fn) {
	if (range.collapsed) {
		return;
	}
	range = range.cloneRange().up();
	var sc = range.startContainer, so = range.startOffset;
	if (!_WEBKIT &amp;&amp; !range.isControl()) {
		return;
	}
	var img = K(sc.childNodes[so]);
	if (!img || img.name != &#x27;img&#x27;) {
		return;
	}
	if (fn(img)) {
		return img;
	}
}
function _bindContextmenuEvent() {
	var self = this, doc = self.edit.doc;
	K(doc).contextmenu(function(e) {
		if (self.menu) {
			self.hideMenu();
		}
		if (!self.useContextmenu) {
			e.preventDefault();
			return;
		}
		if (self._contextmenus.length === 0) {
			return;
		}
		var maxWidth = 0, items = [];
		_each(self._contextmenus, function() {
			if (this.title == &#x27;-&#x27;) {
				items.push(this);
				return;
			}
			if (this.cond &amp;&amp; this.cond()) {
				items.push(this);
				if (this.width &amp;&amp; this.width &gt; maxWidth) {
					maxWidth = this.width;
				}
			}
		});
		while (items.length &gt; 0 &amp;&amp; items[0].title == &#x27;-&#x27;) {
			items.shift();
		}
		while (items.length &gt; 0 &amp;&amp; items[items.length - 1].title == &#x27;-&#x27;) {
			items.pop();
		}
		var prevItem = null;
		_each(items, function(i) {
			if (this.title == &#x27;-&#x27; &amp;&amp; prevItem.title == &#x27;-&#x27;) {
				delete items[i];
			}
			prevItem = this;
		});
		if (items.length &gt; 0) {
			e.preventDefault();
			var pos = K(self.edit.iframe).pos(),
				menu = _menu({
					x : pos.x + e.clientX,
					y : pos.y + e.clientY,
					width : maxWidth,
					css : { visibility: &#x27;hidden&#x27; },
					shadowMode : self.shadowMode
				});
			_each(items, function() {
				if (this.title) {
					menu.addItem(this);
				}
			});
			var docEl = _docElement(menu.doc),
				menuHeight = menu.div.height();
			if (e.clientY + menuHeight &gt;= docEl.clientHeight - 100) {
				menu.pos(menu.x, _removeUnit(menu.y) - menuHeight);
			}
			menu.div.css(&#x27;visibility&#x27;, &#x27;visible&#x27;);
			self.menu = menu;
		}
	});
}
function _bindNewlineEvent() {
	var self = this, doc = self.edit.doc, newlineTag = self.newlineTag;
	if (_IE &amp;&amp; newlineTag !== &#x27;br&#x27;) {
		return;
	}
	if (_GECKO &amp;&amp; _V &lt; 3 &amp;&amp; newlineTag !== &#x27;p&#x27;) {
		return;
	}
	if (_OPERA &amp;&amp; _V &lt; 9) {
		return;
	}
	var brSkipTagMap = _toMap(&#x27;h1,h2,h3,h4,h5,h6,pre,li&#x27;),
		pSkipTagMap = _toMap(&#x27;p,h1,h2,h3,h4,h5,h6,pre,li,blockquote&#x27;);
	function getAncestorTagName(range) {
		var ancestor = K(range.commonAncestor());
		while (ancestor) {
			if (ancestor.type == 1 &amp;&amp; !ancestor.isStyle()) {
				break;
			}
			ancestor = ancestor.parent();
		}
		return ancestor.name;
	}
	K(doc).keydown(function(e) {
		if (e.which != 13 || e.shiftKey || e.ctrlKey || e.altKey) {
			return;
		}
		self.cmd.selection();
		var tagName = getAncestorTagName(self.cmd.range);
		if (tagName == &#x27;marquee&#x27; || tagName == &#x27;select&#x27;) {
			return;
		}
		if (newlineTag === &#x27;br&#x27; &amp;&amp; !brSkipTagMap[tagName]) {
			e.preventDefault();
			self.insertHtml(&#x27;&lt;br /&gt;&#x27; + (_IE &amp;&amp; _V &lt; 9 ? &#x27;&#x27; : &#x27;\u200B&#x27;));
			return;
		}
		if (!pSkipTagMap[tagName]) {
			_nativeCommand(doc, &#x27;formatblock&#x27;, &#x27;&lt;p&gt;&#x27;);
		}
	});
	K(doc).keyup(function(e) {
		if (e.which != 13 || e.shiftKey || e.ctrlKey || e.altKey) {
			return;
		}
		if (newlineTag == &#x27;br&#x27;) {
			return;
		}
		if (_GECKO) {
			var root = self.cmd.commonAncestor(&#x27;p&#x27;);
			var a = self.cmd.commonAncestor(&#x27;a&#x27;);
			if (a &amp;&amp; a.text() == &#x27;&#x27;) {
				a.remove(true);
				self.cmd.range.selectNodeContents(root[0]).collapse(true);
				self.cmd.select();
			}
			return;
		}
		self.cmd.selection();
		var tagName = getAncestorTagName(self.cmd.range);
		if (tagName == &#x27;marquee&#x27; || tagName == &#x27;select&#x27;) {
			return;
		}
		if (!pSkipTagMap[tagName]) {
			_nativeCommand(doc, &#x27;formatblock&#x27;, &#x27;&lt;p&gt;&#x27;);
		}
		var div = self.cmd.commonAncestor(&#x27;div&#x27;);
		if (div) {
			var p = K(&#x27;&lt;p&gt;&lt;/p&gt;&#x27;),
				child = div[0].firstChild;
			while (child) {
				var next = child.nextSibling;
				p.append(child);
				child = next;
			}
			div.before(p);
			div.remove();
			self.cmd.range.selectNodeContents(p[0]);
			self.cmd.select();
		}
	});
}
function _bindTabEvent() {
	var self = this, doc = self.edit.doc;
	K(doc).keydown(function(e) {
		if (e.which == 9) {
			e.preventDefault();
			if (self.afterTab) {
				self.afterTab.call(self, e);
				return;
			}
			var cmd = self.cmd, range = cmd.range;
			range.shrink();
			if (range.collapsed &amp;&amp; range.startContainer.nodeType == 1) {
				range.insertNode(K(&#x27;@&amp;nbsp;&#x27;, doc)[0]);
				cmd.select();
			}
			self.insertHtml(&#x27;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#x27;);
		}
	});
}
function _bindFocusEvent() {
	var self = this;
	K(self.edit.textarea[0], self.edit.win).focus(function(e) {
		if (self.afterFocus) {
			self.afterFocus.call(self, e);
		}
	}).blur(function(e) {
		if (self.afterBlur) {
			self.afterBlur.call(self, e);
		}
	});
}
function _removeBookmarkTag(html) {
	return _trim(html.replace(/&lt;span [^&gt;]*id=&quot;?__kindeditor_bookmark_\w+_\d+__&quot;?[^&gt;]*&gt;&lt;\/span&gt;/ig, &#x27;&#x27;));
}
function _removeTempTag(html) {
	return html.replace(/&lt;div[^&gt;]+class=&quot;?__kindeditor_paste__&quot;?[^&gt;]*&gt;[\s\S]*?&lt;\/div&gt;/ig, &#x27;&#x27;);
}
function _addBookmarkToStack(stack, bookmark) {
	if (stack.length === 0) {
		stack.push(bookmark);
		return;
	}
	var prev = stack[stack.length - 1];
	if (_removeBookmarkTag(bookmark.html) !== _removeBookmarkTag(prev.html)) {
		stack.push(bookmark);
	}
}
function _undoToRedo(fromStack, toStack) {
	var self = this, edit = self.edit,
		body = edit.doc.body,
		range, bookmark;
	if (fromStack.length === 0) {
		return self;
	}
	if (edit.designMode) {
		range = self.cmd.range;
		bookmark = range.createBookmark(true);
		bookmark.html = body.innerHTML;
	} else {
		bookmark = {
			html : body.innerHTML
		};
	}
	_addBookmarkToStack(toStack, bookmark);
	var prev = fromStack.pop();
	if (_removeBookmarkTag(bookmark.html) === _removeBookmarkTag(prev.html) &amp;&amp; fromStack.length &gt; 0) {
		prev = fromStack.pop();
	}
	if (edit.designMode) {
		edit.html(prev.html);
		if (prev.start) {
			range.moveToBookmark(prev);
			self.select();
		}
	} else {
		K(body).html(_removeBookmarkTag(prev.html));
	}
	return self;
}
function KEditor(options) {
	var self = this;
	self.options = {};
	function setOption(key, val) {
		if (KEditor.prototype[key] === undefined) {
			self[key] = val;
		}
		self.options[key] = val;
	}
	_each(options, function(key, val) {
		setOption(key, options[key]);
	});
	_each(K.options, function(key, val) {
		if (self[key] === undefined) {
			setOption(key, val);
		}
	});
	var se = K(self.srcElement || &#x27;&lt;textarea/&gt;&#x27;);
	if (!self.width) {
		self.width = se[0].style.width || se.width();
	}
	if (!self.height) {
		self.height = se[0].style.height || se.height();
	}
	setOption(&#x27;width&#x27;, _undef(self.width, self.minWidth));
	setOption(&#x27;height&#x27;, _undef(self.height, self.minHeight));
	setOption(&#x27;width&#x27;, _addUnit(self.width));
	setOption(&#x27;height&#x27;, _addUnit(self.height));
	if (_MOBILE &amp;&amp; (!_IOS || _V &lt; 534)) {
		self.designMode = false;
	}
	self.srcElement = se;
	self.initContent = &#x27;&#x27;;
	self.plugin = {};
	self.isCreated = false;
	self.isLoading = false;
	self._handlers = {};
	self._contextmenus = [];
	self._undoStack = [];
	self._redoStack = [];
	self._calledPlugins = {};
	self._firstAddBookmark = true;
	self.menu = self.contextmenu = null;
	self.dialogs = [];
}
KEditor.prototype = {
	lang : function(mixed) {
		return _lang(mixed, this.langType);
	},
	loadPlugin : function(name, fn) {
		var self = this;
		if (_plugins[name]) {
			if (self._calledPlugins[name]) {
				if (fn) {
					fn.call(self);
				}
				return self;
			}
			_plugins[name].call(self, KindEditor);
			if (fn) {
				fn.call(self);
			}
			self._calledPlugins[name] = true;
			return self;
		}
		if (self.isLoading) {
			return self;
		}
		self.isLoading = true;
		_loadScript(self.pluginsPath + name + &#x27;/&#x27; + name + &#x27;.js?ver=&#x27; + encodeURIComponent(K.DEBUG ? _TIME : _VERSION), function() {
			self.isLoading = false;
			if (_plugins[name]) {
				self.loadPlugin(name, fn);
			}
		});
		return self;
	},
	handler : function(key, fn) {
		var self = this;
		if (!self._handlers[key]) {
			self._handlers[key] = [];
		}
		if (_isFunction(fn)) {
			self._handlers[key].push(fn);
			return self;
		}
		_each(self._handlers[key], function() {
			fn = this.call(self, fn);
		});
		return fn;
	},
	clickToolbar : function(name, fn) {
		var self = this, key = &#x27;clickToolbar&#x27; + name;
		if (fn === undefined) {
			if (self._handlers[key]) {
				return self.handler(key);
			}
			self.loadPlugin(name, function() {
				self.handler(key);
			});
			return self;
		}
		return self.handler(key, fn);
	},
	updateState : function() {
		var self = this;
		_each((&#x27;justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,&#x27; +
			&#x27;subscript,superscript,bold,italic,underline,strikethrough&#x27;).split(&#x27;,&#x27;), function(i, name) {
			self.cmd.state(name) ? self.toolbar.select(name) : self.toolbar.unselect(name);
		});
		return self;
	},
	addContextmenu : function(item) {
		this._contextmenus.push(item);
		return this;
	},
	afterCreate : function(fn) {
		return this.handler(&#x27;afterCreate&#x27;, fn);
	},
	beforeRemove : function(fn) {
		return this.handler(&#x27;beforeRemove&#x27;, fn);
	},
	beforeGetHtml : function(fn) {
		return this.handler(&#x27;beforeGetHtml&#x27;, fn);
	},
	beforeSetHtml : function(fn) {
		return this.handler(&#x27;beforeSetHtml&#x27;, fn);
	},
	afterSetHtml : function(fn) {
		return this.handler(&#x27;afterSetHtml&#x27;, fn);
	},
	create : function() {
		var self = this, fullscreenMode = self.fullscreenMode;
		if (self.isCreated) {
			return self;
		}
		if (self.srcElement.data(&#x27;kindeditor&#x27;)) {
			return self;
		}
		self.srcElement.data(&#x27;kindeditor&#x27;, &#x27;true&#x27;);
		if (fullscreenMode) {
			_docElement().style.overflow = &#x27;hidden&#x27;;
		} else {
			_docElement().style.overflow = &#x27;&#x27;;
		}
		var width = fullscreenMode ? _docElement().clientWidth + &#x27;px&#x27; : self.width,
			height = fullscreenMode ? _docElement().clientHeight + &#x27;px&#x27; : self.height;
		if ((_IE &amp;&amp; _V &lt; 8) || _QUIRKS) {
			height = _addUnit(_removeUnit(height) + 2);
		}
		var container = self.container = K(self.layout);
		if (fullscreenMode) {
			K(document.body).append(container);
		} else {
			self.srcElement.before(container);
		}
		var toolbarDiv = K(&#x27;.toolbar&#x27;, container),
			editDiv = K(&#x27;.edit&#x27;, container),
			statusbar = self.statusbar = K(&#x27;.statusbar&#x27;, container);
		container.removeClass(&#x27;container&#x27;)
			.addClass(&#x27;ke-container ke-container-&#x27; + self.themeType).css(&#x27;width&#x27;, width);
		if (fullscreenMode) {
			container.css({
				position : &#x27;absolute&#x27;,
				left : 0,
				top : 0,
				&#x27;z-index&#x27; : 811211
			});
			if (!_GECKO) {
				self._scrollPos = _getScrollPos();
			}
			window.scrollTo(0, 0);
			K(document.body).css({
				&#x27;height&#x27; : &#x27;1px&#x27;,
				&#x27;overflow&#x27; : &#x27;hidden&#x27;
			});
			K(document.body.parentNode).css(&#x27;overflow&#x27;, &#x27;hidden&#x27;);
			self._fullscreenExecuted = true;
		} else {
			if (self._fullscreenExecuted) {
				K(document.body).css({
					&#x27;height&#x27; : &#x27;&#x27;,
					&#x27;overflow&#x27; : &#x27;&#x27;
				});
				K(document.body.parentNode).css(&#x27;overflow&#x27;, &#x27;&#x27;);
			}
			if (self._scrollPos) {
				window.scrollTo(self._scrollPos.x, self._scrollPos.y);
			}
		}
		var htmlList = [];
		K.each(self.items, function(i, name) {
			if (name == &#x27;|&#x27;) {
				htmlList.push(&#x27;&lt;span class=&quot;ke-inline-block ke-separator&quot;&gt;&lt;/span&gt;&#x27;);
			} else if (name == &#x27;/&#x27;) {
				htmlList.push(&#x27;&lt;div class=&quot;ke-hr&quot;&gt;&lt;/div&gt;&#x27;);
			} else {
				htmlList.push(&#x27;&lt;span class=&quot;ke-outline&quot; data-name=&quot;&#x27; + name + &#x27;&quot; title=&quot;&#x27; + self.lang(name) + &#x27;&quot; unselectable=&quot;on&quot;&gt;&#x27;);
				htmlList.push(&#x27;&lt;span class=&quot;ke-toolbar-icon ke-toolbar-icon-url ke-icon-&#x27; + name + &#x27;&quot; unselectable=&quot;on&quot;&gt;&lt;/span&gt;&lt;/span&gt;&#x27;);
			}
		});
		var toolbar = self.toolbar = _toolbar({
			src : toolbarDiv,
			html : htmlList.join(&#x27;&#x27;),
			noDisableItems : self.noDisableItems,
			click : function(e, name) {
				e.stop();
				if (self.menu) {
					var menuName = self.menu.name;
					self.hideMenu();
					if (menuName === name) {
						return;
					}
				}
				self.clickToolbar(name);
			}
		});
		var editHeight = _removeUnit(height) - toolbar.div.height();
		var edit = self.edit = _edit({
			height : editHeight &gt; 0 &amp;&amp; _removeUnit(height) &gt; self.minHeight ? editHeight : self.minHeight,
			src : editDiv,
			srcElement : self.srcElement,
			designMode : self.designMode,
			themesPath : self.themesPath,
			bodyClass : self.bodyClass,
			cssPath : self.cssPath,
			cssData : self.cssData,
			beforeGetHtml : function(html) {
				html = self.beforeGetHtml(html);
				return _formatHtml(html, self.filterMode ? self.htmlTags : null, self.urlType, self.wellFormatMode, self.indentChar);
			},
			beforeSetHtml : function(html) {
				html = _formatHtml(html, self.filterMode ? self.htmlTags : null, &#x27;&#x27;, false);
				return self.beforeSetHtml(html);
			},
			afterSetHtml : function() {
				self.edit = edit = this;
				self.afterSetHtml();
			},
			afterCreate : function() {
				self.edit = edit = this;
				self.cmd = edit.cmd;
				self._docMousedownFn = function(e) {
					if (self.menu) {
						self.hideMenu();
					}
				};
				K(edit.doc, document).mousedown(self._docMousedownFn);
				_bindContextmenuEvent.call(self);
				_bindNewlineEvent.call(self);
				_bindTabEvent.call(self);
				_bindFocusEvent.call(self);
				edit.afterChange(function(e) {
					if (!edit.designMode) {
						return;
					}
					self.updateState();
					self.addBookmark();
					if (self.options.afterChange) {
						self.options.afterChange.call(self);
					}
				});
				edit.textarea.keyup(function(e) {
					if (!e.ctrlKey &amp;&amp; !e.altKey &amp;&amp; _INPUT_KEY_MAP[e.which]) {
						if (self.options.afterChange) {
							self.options.afterChange.call(self);
						}
					}
				});
				if (self.readonlyMode) {
					self.readonly();
				}
				self.isCreated = true;
				if (self.initContent === &#x27;&#x27;) {
					self.initContent = self.html();
				}
				self.afterCreate();
				if (self.options.afterCreate) {
					self.options.afterCreate.call(self);
				}
			}
		});
		statusbar.removeClass(&#x27;statusbar&#x27;).addClass(&#x27;ke-statusbar&#x27;)
			.append(&#x27;&lt;span class=&quot;ke-inline-block ke-statusbar-center-icon&quot;&gt;&lt;/span&gt;&#x27;)
			.append(&#x27;&lt;span class=&quot;ke-inline-block ke-statusbar-right-icon&quot;&gt;&lt;/span&gt;&#x27;);
		if (self._fullscreenResizeHandler) {
			K(window).unbind(&#x27;resize&#x27;, self._fullscreenResizeHandler);
			self._fullscreenResizeHandler = null;
		}
		function initResize() {
			if (statusbar.height() === 0) {
				setTimeout(initResize, 100);
				return;
			}
			self.resize(width, height, false);
		}
		initResize();
		if (fullscreenMode) {
			self._fullscreenResizeHandler = function(e) {
				if (self.isCreated) {
					self.resize(_docElement().clientWidth, _docElement().clientHeight, false);
				}
			};
			K(window).bind(&#x27;resize&#x27;, self._fullscreenResizeHandler);
			toolbar.select(&#x27;fullscreen&#x27;);
			statusbar.first().css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
			statusbar.last().css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
		} else {
			if (_GECKO) {
				K(window).bind(&#x27;scroll&#x27;, function(e) {
					self._scrollPos = _getScrollPos();
				});
			}
			if (self.resizeType &gt; 0) {
				_drag({
					moveEl : container,
					clickEl : statusbar,
					moveFn : function(x, y, width, height, diffX, diffY) {
						height += diffY;
						self.resize(null, height);
					}
				});
			} else {
				statusbar.first().css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
			}
			if (self.resizeType === 2) {
				_drag({
					moveEl : container,
					clickEl : statusbar.last(),
					moveFn : function(x, y, width, height, diffX, diffY) {
						width += diffX;
						height += diffY;
						self.resize(width, height);
					}
				});
			} else {
				statusbar.last().css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
			}
		}
		return self;
	},
	remove : function() {
		var self = this;
		if (!self.isCreated) {
			return self;
		}
		self.beforeRemove();
		self.srcElement.data(&#x27;kindeditor&#x27;, &#x27;&#x27;);
		if (self.menu) {
			self.hideMenu();
		}
		_each(self.dialogs, function() {
			self.hideDialog();
		});
		K(document).unbind(&#x27;mousedown&#x27;, self._docMousedownFn);
		self.toolbar.remove();
		self.edit.remove();
		self.statusbar.last().unbind();
		self.statusbar.unbind();
		self.container.remove();
		self.container = self.toolbar = self.edit = self.menu = null;
		self.dialogs = [];
		self.isCreated = false;
		return self;
	},
	resize : function(width, height, updateProp) {
		var self = this;
		updateProp = _undef(updateProp, true);
		if (width) {
			if (!/%/.test(width)) {
				width = _removeUnit(width);
				width = width &lt; self.minWidth ? self.minWidth : width;
			}
			self.container.css(&#x27;width&#x27;, _addUnit(width));
			if (updateProp) {
				self.width = _addUnit(width);
			}
		}
		if (height) {
			height = _removeUnit(height);
			editHeight = _removeUnit(height) - self.toolbar.div.height() - self.statusbar.height();
			editHeight = editHeight &lt; self.minHeight ? self.minHeight : editHeight;
			self.edit.setHeight(editHeight);
			if (updateProp) {
				self.height = _addUnit(height);
			}
		}
		return self;
	},
	select : function() {
		this.isCreated &amp;&amp; this.cmd.select();
		return this;
	},
	html : function(val) {
		var self = this;
		if (val === undefined) {
			return self.isCreated ? self.edit.html() : _elementVal(self.srcElement);
		}
		self.isCreated ? self.edit.html(val) : _elementVal(self.srcElement, val);
		if (self.isCreated) {
			self.cmd.selection();
		}
		return self;
	},
	fullHtml : function() {
		return this.isCreated ? this.edit.html(undefined, true) : &#x27;&#x27;;
	},
	text : function(val) {
		var self = this;
		if (val === undefined) {
			return _trim(self.html().replace(/&lt;(?!img|embed).*?&gt;/ig, &#x27;&#x27;).replace(/&amp;nbsp;/ig, &#x27; &#x27;));
		} else {
			return self.html(_escape(val));
		}
	},
	isEmpty : function() {
		return _trim(this.text().replace(/\r\n|\n|\r/, &#x27;&#x27;)) === &#x27;&#x27;;
	},
	isDirty : function() {
		return _trim(this.initContent.replace(/\r\n|\n|\r|t/g, &#x27;&#x27;)) !== _trim(this.html().replace(/\r\n|\n|\r|t/g, &#x27;&#x27;));
	},
	selectedHtml : function() {
		return this.isCreated ? this.cmd.range.html() : &#x27;&#x27;;
	},
	count : function(mode) {
		var self = this;
		mode = (mode || &#x27;html&#x27;).toLowerCase();
		if (mode === &#x27;html&#x27;) {
			return _removeBookmarkTag(_removeTempTag(self.html())).length;
		}
		if (mode === &#x27;text&#x27;) {
			return self.text().replace(/&lt;(?:img|embed).*?&gt;/ig, &#x27;K&#x27;).replace(/\r\n|\n|\r/g, &#x27;&#x27;).length;
		}
		return 0;
	},
	exec : function(key) {
		key = key.toLowerCase();
		var self = this, cmd = self.cmd,
			changeFlag = _inArray(key, &#x27;selectall,copy,paste,print&#x27;.split(&#x27;,&#x27;)) &lt; 0;
		if (changeFlag) {
			self.addBookmark(false);
		}
		cmd[key].apply(cmd, _toArray(arguments, 1));
		if (changeFlag) {
			self.updateState();
			self.addBookmark(false);
			if (self.options.afterChange) {
				self.options.afterChange.call(self);
			}
		}
		return self;
	},
	insertHtml : function(val, quickMode) {
		if (!this.isCreated) {
			return this;
		}
		val = this.beforeSetHtml(val);
		this.exec(&#x27;inserthtml&#x27;, val, quickMode);
		return this;
	},
	appendHtml : function(val) {
		this.html(this.html() + val);
		if (this.isCreated) {
			var cmd = this.cmd;
			cmd.range.selectNodeContents(cmd.doc.body).collapse(false);
			cmd.select();
		}
		return this;
	},
	sync : function() {
		_elementVal(this.srcElement, this.html());
		return this;
	},
	focus : function() {
		this.isCreated ? this.edit.focus() : this.srcElement[0].focus();
		return this;
	},
	blur : function() {
		this.isCreated ? this.edit.blur() : this.srcElement[0].blur();
		return this;
	},
	addBookmark : function(checkSize) {
		checkSize = _undef(checkSize, true);
		var self = this, edit = self.edit,
			body = edit.doc.body,
			html = _removeTempTag(body.innerHTML), bookmark;
		if (checkSize &amp;&amp; self._undoStack.length &gt; 0) {
			var prev = self._undoStack[self._undoStack.length - 1];
			if (Math.abs(html.length - _removeBookmarkTag(prev.html).length) &lt; self.minChangeSize) {
				return self;
			}
		}
		if (edit.designMode &amp;&amp; !self._firstAddBookmark) {
			var range = self.cmd.range;
			bookmark = range.createBookmark(true);
			bookmark.html = _removeTempTag(body.innerHTML);
			range.moveToBookmark(bookmark);
		} else {
			bookmark = {
				html : html
			};
		}
		self._firstAddBookmark = false;
		_addBookmarkToStack(self._undoStack, bookmark);
		return self;
	},
	undo : function() {
		return _undoToRedo.call(this, this._undoStack, this._redoStack);
	},
	redo : function() {
		return _undoToRedo.call(this, this._redoStack, this._undoStack);
	},
	fullscreen : function(bool) {
		this.fullscreenMode = (bool === undefined ? !this.fullscreenMode : bool);
		return this.remove().create();
	},
	readonly : function(isReadonly) {
		isReadonly = _undef(isReadonly, true);
		var self = this, edit = self.edit, doc = edit.doc;
		if (self.designMode) {
			self.toolbar.disableAll(isReadonly, []);
		} else {
			_each(self.noDisableItems, function() {
				self.toolbar[isReadonly ? &#x27;disable&#x27; : &#x27;enable&#x27;](this);
			});
		}
		if (_IE) {
			doc.body.contentEditable = !isReadonly;
		} else {
			doc.designMode = isReadonly ? &#x27;off&#x27; : &#x27;on&#x27;;
		}
		edit.textarea[0].disabled = isReadonly;
	},
	createMenu : function(options) {
		var self = this,
			name = options.name,
			knode = self.toolbar.get(name),
			pos = knode.pos();
		options.x = pos.x;
		options.y = pos.y + knode.height();
		options.z = self.options.zIndex;
		options.shadowMode = _undef(options.shadowMode, self.shadowMode);
		if (options.selectedColor !== undefined) {
			options.cls = &#x27;ke-colorpicker-&#x27; + self.themeType;
			options.noColor = self.lang(&#x27;noColor&#x27;);
			self.menu = _colorpicker(options);
		} else {
			options.cls = &#x27;ke-menu-&#x27; + self.themeType;
			options.centerLineMode = false;
			self.menu = _menu(options);
		}
		return self.menu;
	},
	hideMenu : function() {
		this.menu.remove();
		this.menu = null;
		return this;
	},
	hideContextmenu : function() {
		this.contextmenu.remove();
		this.contextmenu = null;
		return this;
	},
	createDialog : function(options) {
		var self = this, name = options.name;
		options.z = self.options.zIndex;
		options.shadowMode = _undef(options.shadowMode, self.shadowMode);
		options.closeBtn = _undef(options.closeBtn, {
			name : self.lang(&#x27;close&#x27;),
			click : function(e) {
				self.hideDialog();
				if (_IE &amp;&amp; self.cmd) {
					self.cmd.select();
				}
			}
		});
		options.noBtn = _undef(options.noBtn, {
			name : self.lang(options.yesBtn ? &#x27;no&#x27; : &#x27;close&#x27;),
			click : function(e) {
				self.hideDialog();
				if (_IE &amp;&amp; self.cmd) {
					self.cmd.select();
				}
			}
		});
		if (self.dialogAlignType != &#x27;page&#x27;) {
			options.alignEl = self.container;
		}
		options.cls = &#x27;ke-dialog-&#x27; + self.themeType;
		if (self.dialogs.length &gt; 0) {
			var firstDialog = self.dialogs[0],
				parentDialog = self.dialogs[self.dialogs.length - 1];
			firstDialog.setMaskIndex(parentDialog.z + 2);
			options.z = parentDialog.z + 3;
			options.showMask = false;
		}
		var dialog = _dialog(options);
		self.dialogs.push(dialog);
		return dialog;
	},
	hideDialog : function() {
		var self = this;
		if (self.dialogs.length &gt; 0) {
			self.dialogs.pop().remove();
		}
		if (self.dialogs.length &gt; 0) {
			var firstDialog = self.dialogs[0],
				parentDialog = self.dialogs[self.dialogs.length - 1];
			firstDialog.setMaskIndex(parentDialog.z - 1);
		}
		return self;
	},
	errorDialog : function(html) {
		var self = this;
		var dialog = self.createDialog({
			width : 750,
			title : self.lang(&#x27;uploadError&#x27;),
			body : &#x27;&lt;div style=&quot;padding:10px 20px;&quot;&gt;&lt;iframe frameborder=&quot;0&quot; style=&quot;width:708px;height:400px;&quot;&gt;&lt;/iframe&gt;&lt;/div&gt;&#x27;
		});
		var iframe = K(&#x27;iframe&#x27;, dialog.div), doc = K.iframeDoc(iframe);
		doc.open();
		doc.write(html);
		doc.close();
		K(doc.body).css(&#x27;background-color&#x27;, &#x27;#FFF&#x27;);
		iframe[0].contentWindow.focus();
		return self;
	}
};
function _editor(options) {
	return new KEditor(options);
}
_instances = [];
function _create(expr, options) {
	options = options || {};
	options.basePath = _undef(options.basePath, K.basePath);
	options.themesPath = _undef(options.themesPath, options.basePath + &#x27;themes/&#x27;);
	options.langPath = _undef(options.langPath, options.basePath + &#x27;lang/&#x27;);
	options.pluginsPath = _undef(options.pluginsPath, options.basePath + &#x27;plugins/&#x27;);
	if (_undef(options.loadStyleMode, K.options.loadStyleMode)) {
		var themeType = _undef(options.themeType, K.options.themeType);
		_loadStyle(options.themesPath + &#x27;default/default.css&#x27;);
		_loadStyle(options.themesPath + themeType + &#x27;/&#x27; + themeType + &#x27;.css&#x27;);
	}
	function create(editor) {
		_each(_plugins, function(name, fn) {
			fn.call(editor, KindEditor);
		});
		return editor.create();
	}
	var knode = K(expr);
	if (!knode || knode.length === 0) {
		return;
	}
	if (knode.length &gt; 1) {
		knode.each(function() {
			_create(this, options);
		});
		return _instances[0];
	}
	options.srcElement = knode[0];
	var editor = new KEditor(options);
	_instances.push(editor);
	if (_language[editor.langType]) {
		return create(editor);
	}
	_loadScript(editor.langPath + editor.langType + &#x27;.js?ver=&#x27; + encodeURIComponent(K.DEBUG ? _TIME : _VERSION), function() {
		create(editor);
	});
	return editor;
}
function _eachEditor(expr, fn) {
	K(expr).each(function(i, el) {
		K.each(_instances, function(j, editor) {
			if (editor &amp;&amp; editor.srcElement[0] == el) {
				fn.call(editor, j, editor);
				return false;
			}
		});
	});
}
K.remove = function(expr) {
	_eachEditor(expr, function(i) {
		this.remove();
		_instances.splice(i, 1);
	});
};
K.sync = function(expr) {
	_eachEditor(expr, function() {
		this.sync();
	});
};
if (_IE &amp;&amp; _V &lt; 7) {
	_nativeCommand(document, &#x27;BackgroundImageCache&#x27;, true);
}
K.EditorClass = KEditor;
K.editor = _editor;
K.create = _create;
K.instances = _instances;
K.plugin = _plugin;
K.lang = _lang;
_plugin(&#x27;core&#x27;, function(K) {
	var self = this,
		shortcutKeys = {
			undo : &#x27;Z&#x27;, redo : &#x27;Y&#x27;, bold : &#x27;B&#x27;, italic : &#x27;I&#x27;, underline : &#x27;U&#x27;, print : &#x27;P&#x27;, selectall : &#x27;A&#x27;
		};
	self.afterSetHtml(function() {
		if (self.options.afterChange) {
			self.options.afterChange.call(self);
		}
	});
	self.afterCreate(function() {
		if (self.syncType != &#x27;form&#x27;) {
			return;
		}
		var el = K(self.srcElement), hasForm = false;
		while ((el = el.parent())) {
			if (el.name == &#x27;form&#x27;) {
				hasForm = true;
				break;
			}
		}
		if (hasForm) {
			el.bind(&#x27;submit&#x27;, function(e) {
				self.sync();
				K(window).bind(&#x27;unload&#x27;, function() {
					self.edit.textarea.remove();
				});
			});
			var resetBtn = K(&#x27;[type=&quot;reset&quot;]&#x27;, el);
			resetBtn.click(function() {
				self.html(self.initContent);
				self.cmd.selection();
			});
			self.beforeRemove(function() {
				el.unbind();
				resetBtn.unbind();
			});
		}
	});
	self.clickToolbar(&#x27;source&#x27;, function() {
		if (self.edit.designMode) {
			self.toolbar.disableAll(true);
			self.edit.design(false);
			self.toolbar.select(&#x27;source&#x27;);
		} else {
			self.toolbar.disableAll(false);
			self.edit.design(true);
			self.toolbar.unselect(&#x27;source&#x27;);
			self.cmd.selection();
		}
		self.designMode = self.edit.designMode;
	});
	self.afterCreate(function() {
		if (!self.designMode) {
			self.toolbar.disableAll(true).select(&#x27;source&#x27;);
		}
	});
	self.clickToolbar(&#x27;fullscreen&#x27;, function() {
		self.fullscreen();
	});
	if (self.fullscreenShortcut) {
		var loaded = false;
		self.afterCreate(function() {
			K(self.edit.doc, self.edit.textarea).keyup(function(e) {
				if (e.which == 27) {
					setTimeout(function() {
						self.fullscreen();
					}, 0);
				}
			});
			if (loaded) {
				if (_IE &amp;&amp; !self.designMode) {
					return;
				}
				self.focus();
			}
			if (!loaded) {
				loaded = true;
			}
		});
	}
	_each(&#x27;undo,redo&#x27;.split(&#x27;,&#x27;), function(i, name) {
		if (shortcutKeys[name]) {
			self.afterCreate(function() {
				_ctrl(this.edit.doc, shortcutKeys[name], function() {
					self.clickToolbar(name);
				});
			});
		}
		self.clickToolbar(name, function() {
			self[name]();
		});
	});
	self.clickToolbar(&#x27;formatblock&#x27;, function() {
		var blocks = self.lang(&#x27;formatblock.formatBlock&#x27;),
			heights = {
				h1 : 28,
				h2 : 24,
				h3 : 18,
				H4 : 14,
				p : 12
			},
			curVal = self.cmd.val(&#x27;formatblock&#x27;),
			menu = self.createMenu({
				name : &#x27;formatblock&#x27;,
				width : self.langType == &#x27;en&#x27; ? 200 : 150
			});
		_each(blocks, function(key, val) {
			var style = &#x27;font-size:&#x27; + heights[key] + &#x27;px;&#x27;;
			if (key.charAt(0) === &#x27;h&#x27;) {
				style += &#x27;font-weight:bold;&#x27;;
			}
			menu.addItem({
				title : &#x27;&lt;span style=&quot;&#x27; + style + &#x27;&quot; unselectable=&quot;on&quot;&gt;&#x27; + val + &#x27;&lt;/span&gt;&#x27;,
				height : heights[key] + 12,
				checked : (curVal === key || curVal === val),
				click : function() {
					self.select().exec(&#x27;formatblock&#x27;, &#x27;&lt;&#x27; + key + &#x27;&gt;&#x27;).hideMenu();
				}
			});
		});
	});
	self.clickToolbar(&#x27;fontname&#x27;, function() {
		var curVal = self.cmd.val(&#x27;fontname&#x27;),
			menu = self.createMenu({
				name : &#x27;fontname&#x27;,
				width : 150
			});
		_each(self.lang(&#x27;fontname.fontName&#x27;), function(key, val) {
			menu.addItem({
				title : &#x27;&lt;span style=&quot;font-family: &#x27; + key + &#x27;;&quot; unselectable=&quot;on&quot;&gt;&#x27; + val + &#x27;&lt;/span&gt;&#x27;,
				checked : (curVal === key.toLowerCase() || curVal === val.toLowerCase()),
				click : function() {
					self.exec(&#x27;fontname&#x27;, key).hideMenu();
				}
			});
		});
	});
	self.clickToolbar(&#x27;fontsize&#x27;, function() {
		var curVal = self.cmd.val(&#x27;fontsize&#x27;),
			menu = self.createMenu({
				name : &#x27;fontsize&#x27;,
				width : 150
			});
		_each(self.fontSizeTable, function(i, val) {
			menu.addItem({
				title : &#x27;&lt;span style=&quot;font-size:&#x27; + val + &#x27;;&quot; unselectable=&quot;on&quot;&gt;&#x27; + val + &#x27;&lt;/span&gt;&#x27;,
				height : _removeUnit(val) + 12,
				checked : curVal === val,
				click : function() {
					self.exec(&#x27;fontsize&#x27;, val).hideMenu();
				}
			});
		});
	});
	_each(&#x27;forecolor,hilitecolor&#x27;.split(&#x27;,&#x27;), function(i, name) {
		self.clickToolbar(name, function() {
			self.createMenu({
				name : name,
				selectedColor : self.cmd.val(name) || &#x27;default&#x27;,
				colors : self.colorTable,
				click : function(color) {
					self.exec(name, color).hideMenu();
				}
			});
		});
	});
	_each((&#x27;cut,copy,paste&#x27;).split(&#x27;,&#x27;), function(i, name) {
		self.clickToolbar(name, function() {
			self.focus();
			try {
				self.exec(name, null);
			} catch(e) {
				alert(self.lang(name + &#x27;Error&#x27;));
			}
		});
	});
	self.clickToolbar(&#x27;about&#x27;, function() {
		var html = &#x27;&lt;div style=&quot;margin:20px;&quot;&gt;&#x27; +
			&#x27;&lt;div&gt;KindEditor &#x27; + _VERSION + &#x27;&lt;/div&gt;&#x27; +
			&#x27;&lt;div&gt;Copyright &amp;copy; &lt;a href=&quot;http://www.kindsoft.net/&quot; target=&quot;_blank&quot;&gt;kindsoft.net&lt;/a&gt; All rights reserved.&lt;/div&gt;&#x27; +
			&#x27;&lt;/div&gt;&#x27;;
		self.createDialog({
			name : &#x27;about&#x27;,
			width : 350,
			title : self.lang(&#x27;about&#x27;),
			body : html
		});
	});
	self.plugin.getSelectedLink = function() {
		return self.cmd.commonAncestor(&#x27;a&#x27;);
	};
	self.plugin.getSelectedImage = function() {
		return _getImageFromRange(self.edit.cmd.range, function(img) {
			return !/^ke-\w+$/i.test(img[0].className);
		});
	};
	self.plugin.getSelectedFlash = function() {
		return _getImageFromRange(self.edit.cmd.range, function(img) {
			return img[0].className == &#x27;ke-flash&#x27;;
		});
	};
	self.plugin.getSelectedMedia = function() {
		return _getImageFromRange(self.edit.cmd.range, function(img) {
			return img[0].className == &#x27;ke-media&#x27; || img[0].className == &#x27;ke-rm&#x27;;
		});
	};
	self.plugin.getSelectedAnchor = function() {
		return _getImageFromRange(self.edit.cmd.range, function(img) {
			return img[0].className == &#x27;ke-anchor&#x27;;
		});
	};
	_each(&#x27;link,image,flash,media,anchor&#x27;.split(&#x27;,&#x27;), function(i, name) {
		var uName = name.charAt(0).toUpperCase() + name.substr(1);
		_each(&#x27;edit,delete&#x27;.split(&#x27;,&#x27;), function(j, val) {
			self.addContextmenu({
				title : self.lang(val + uName),
				click : function() {
					self.loadPlugin(name, function() {
						self.plugin[name][val]();
						self.hideMenu();
					});
				},
				cond : self.plugin[&#x27;getSelected&#x27; + uName],
				width : 150,
				iconClass : val == &#x27;edit&#x27; ? &#x27;ke-icon-&#x27; + name : undefined
			});
		});
		self.addContextmenu({ title : &#x27;-&#x27; });
	});
	self.plugin.getSelectedTable = function() {
		return self.cmd.commonAncestor(&#x27;table&#x27;);
	};
	self.plugin.getSelectedRow = function() {
		return self.cmd.commonAncestor(&#x27;tr&#x27;);
	};
	self.plugin.getSelectedCell = function() {
		return self.cmd.commonAncestor(&#x27;td&#x27;);
	};
	_each((&#x27;prop,cellprop,colinsertleft,colinsertright,rowinsertabove,rowinsertbelow,rowmerge,colmerge,&#x27; +
	&#x27;rowsplit,colsplit,coldelete,rowdelete,insert,delete&#x27;).split(&#x27;,&#x27;), function(i, val) {
		var cond = _inArray(val, [&#x27;prop&#x27;, &#x27;delete&#x27;]) &lt; 0 ? self.plugin.getSelectedCell : self.plugin.getSelectedTable;
		self.addContextmenu({
			title : self.lang(&#x27;table&#x27; + val),
			click : function() {
				self.loadPlugin(&#x27;table&#x27;, function() {
					self.plugin.table[val]();
					self.hideMenu();
				});
			},
			cond : cond,
			width : 170,
			iconClass : &#x27;ke-icon-table&#x27; + val
		});
	});
	self.addContextmenu({ title : &#x27;-&#x27; });
	_each((&#x27;selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,&#x27; +
		&#x27;insertunorderedlist,indent,outdent,subscript,superscript,hr,print,&#x27; +
		&#x27;bold,italic,underline,strikethrough,removeformat,unlink&#x27;).split(&#x27;,&#x27;), function(i, name) {
		if (shortcutKeys[name]) {
			self.afterCreate(function() {
				_ctrl(this.edit.doc, shortcutKeys[name], function() {
					self.cmd.selection();
					self.clickToolbar(name);
				});
			});
		}
		self.clickToolbar(name, function() {
			self.focus().exec(name, null);
		});
	});
	self.afterCreate(function() {
		var doc = self.edit.doc, cmd, bookmark, div,
			cls = &#x27;__kindeditor_paste__&#x27;, pasting = false;
		function movePastedData() {
			cmd.range.moveToBookmark(bookmark);
			cmd.select();
			if (_WEBKIT) {
				K(&#x27;div.&#x27; + cls, div).each(function() {
					K(this).after(&#x27;&lt;br /&gt;&#x27;).remove(true);
				});
				K(&#x27;span.Apple-style-span&#x27;, div).remove(true);
				K(&#x27;span.Apple-tab-span&#x27;, div).remove(true);
				K(&#x27;span[style]&#x27;, div).each(function() {
					if (K(this).css(&#x27;white-space&#x27;) == &#x27;nowrap&#x27;) {
						K(this).remove(true);
					}
				});
				K(&#x27;meta&#x27;, div).remove();
			}
			var html = div[0].innerHTML;
			div.remove();
			if (html === &#x27;&#x27;) {
				return;
			}
			if (_WEBKIT) {
				html = html.replace(/(&lt;br&gt;)\1/ig, &#x27;$1&#x27;);
			}
			if (self.pasteType === 2) {
				html = html.replace(/(&lt;(?:p|p\s[^&gt;]*)&gt;) *(&lt;\/p&gt;)/ig, &#x27;&#x27;);
				if (/schemas-microsoft-com|worddocument|mso-\w+/i.test(html)) {
					html = _clearMsWord(html, self.filterMode ? self.htmlTags : K.options.htmlTags);
				} else {
					html = _formatHtml(html, self.filterMode ? self.htmlTags : null);
					html = self.beforeSetHtml(html);
				}
			}
			if (self.pasteType === 1) {
				html = html.replace(/&amp;nbsp;/ig, &#x27; &#x27;);
				html = html.replace(/\n\s*\n/g, &#x27;\n&#x27;);
				html = html.replace(/&lt;br[^&gt;]*&gt;/ig, &#x27;\n&#x27;);
				html = html.replace(/&lt;\/p&gt;&lt;p[^&gt;]*&gt;/ig, &#x27;\n&#x27;);
				html = html.replace(/&lt;[^&gt;]+&gt;/g, &#x27;&#x27;);
				html = html.replace(/ {2}/g, &#x27; &amp;nbsp;&#x27;);
				if (self.newlineTag == &#x27;p&#x27;) {
					if (/\n/.test(html)) {
						html = html.replace(/^/, &#x27;&lt;p&gt;&#x27;).replace(/$/, &#x27;&lt;br /&gt;&lt;/p&gt;&#x27;).replace(/\n/g, &#x27;&lt;br /&gt;&lt;/p&gt;&lt;p&gt;&#x27;);
					}
				} else {
					html = html.replace(/\n/g, &#x27;&lt;br /&gt;$&amp;&#x27;);
				}
			}
			self.insertHtml(html, true);
		}
		K(doc.body).bind(&#x27;paste&#x27;, function(e){
			if (self.pasteType === 0) {
				e.stop();
				return;
			}
			if (pasting) {
				return;
			}
			pasting = true;
			K(&#x27;div.&#x27; + cls, doc).remove();
			cmd = self.cmd.selection();
			bookmark = cmd.range.createBookmark();
			div = K(&#x27;&lt;div class=&quot;&#x27; + cls + &#x27;&quot;&gt;&lt;/div&gt;&#x27;, doc).css({
				position : &#x27;absolute&#x27;,
				width : &#x27;1px&#x27;,
				height : &#x27;1px&#x27;,
				overflow : &#x27;hidden&#x27;,
				left : &#x27;-1981px&#x27;,
				top : K(bookmark.start).pos().y + &#x27;px&#x27;,
				&#x27;white-space&#x27; : &#x27;nowrap&#x27;
			});
			K(doc.body).append(div);
			if (_IE) {
				var rng = cmd.range.get(true);
				rng.moveToElementText(div[0]);
				rng.select();
				rng.execCommand(&#x27;paste&#x27;);
				e.preventDefault();
			} else {
				cmd.range.selectNodeContents(div[0]);
				cmd.select();
			}
			setTimeout(function() {
				movePastedData();
				pasting = false;
			}, 0);
		});
	});
	self.beforeGetHtml(function(html) {
		if (_IE &amp;&amp; _V &lt;= 8) {
			html = html.replace(/&lt;div\s+[^&gt;]*data-ke-input-tag=&quot;([^&quot;]*)&quot;[^&gt;]*&gt;([\s\S]*?)&lt;\/div&gt;/ig, function(full, tag) {
				return unescape(tag);
			});
			html = html.replace(/(&lt;input)((?:\s+[^&gt;]*)?&gt;)/ig, function($0, $1, $2) {
				if (!/\s+type=&quot;[^&quot;]+&quot;/i.test($0)) {
					return $1 + &#x27; type=&quot;text&quot;&#x27; + $2;
				}
				return $0;
			});
		}
		return html.replace(/(&lt;(?:noscript|noscript\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/noscript&gt;)/ig, function($0, $1, $2, $3) {
			return $1 + _unescape($2).replace(/\s+/g, &#x27; &#x27;) + $3;
		})
		.replace(/&lt;img[^&gt;]*class=&quot;?ke-(flash|rm|media)&quot;?[^&gt;]*&gt;/ig, function(full) {
			var imgAttrs = _getAttrList(full),
				styles = _getCssList(imgAttrs.style || &#x27;&#x27;),
				attrs = _mediaAttrs(imgAttrs[&#x27;data-ke-tag&#x27;]);
			attrs.width = _undef(imgAttrs.width, _removeUnit(_undef(styles.width, &#x27;&#x27;)));
			attrs.height = _undef(imgAttrs.height, _removeUnit(_undef(styles.height, &#x27;&#x27;)));
			return _mediaEmbed(attrs);
		})
		.replace(/&lt;img[^&gt;]*class=&quot;?ke-anchor&quot;?[^&gt;]*&gt;/ig, function(full) {
			var imgAttrs = _getAttrList(full);
			return &#x27;&lt;a name=&quot;&#x27; + unescape(imgAttrs[&#x27;data-ke-name&#x27;]) + &#x27;&quot;&gt;&lt;/a&gt;&#x27;;
		})
		.replace(/&lt;div\s+[^&gt;]*data-ke-script-attr=&quot;([^&quot;]*)&quot;[^&gt;]*&gt;([\s\S]*?)&lt;\/div&gt;/ig, function(full, attr, code) {
			return &#x27;&lt;script&#x27; + unescape(attr) + &#x27;&gt;&#x27; + unescape(code) + &#x27;&lt;/script&gt;&#x27;;
		})
		.replace(/&lt;div\s+[^&gt;]*data-ke-noscript-attr=&quot;([^&quot;]*)&quot;[^&gt;]*&gt;([\s\S]*?)&lt;\/div&gt;/ig, function(full, attr, code) {
			return &#x27;&lt;noscript&#x27; + unescape(attr) + &#x27;&gt;&#x27; + unescape(code) + &#x27;&lt;/noscript&gt;&#x27;;
		})
		.replace(/(&lt;[^&gt;]*)data-ke-src=&quot;([^&quot;]*)&quot;([^&gt;]*&gt;)/ig, function(full, start, src, end) {
			full = full.replace(/(\s+(?:href|src)=&quot;)[^&quot;]*(&quot;)/i, function($0, $1, $2) {
				return $1 + _unescape(src) + $2;
			});
			full = full.replace(/\s+data-ke-src=&quot;[^&quot;]*&quot;/i, &#x27;&#x27;);
			return full;
		})
		.replace(/(&lt;[^&gt;]+\s)data-ke-(on\w+=&quot;[^&quot;]*&quot;[^&gt;]*&gt;)/ig, function(full, start, end) {
			return start + end;
		});
	});
	self.beforeSetHtml(function(html) {
		if (_IE &amp;&amp; _V &lt;= 8) {
			html = html.replace(/&lt;input[^&gt;]*&gt;|&lt;(select|button)[^&gt;]*&gt;[\s\S]*?&lt;\/\1&gt;/ig, function(full) {
				var attrs = _getAttrList(full);
				var styles = _getCssList(attrs.style || &#x27;&#x27;);
				if (styles.display == &#x27;none&#x27;) {
					return &#x27;&lt;div class=&quot;ke-display-none&quot; data-ke-input-tag=&quot;&#x27; + escape(full) + &#x27;&quot;&gt;&lt;/div&gt;&#x27;;
				}
				return full;
			});
		}
		return html.replace(/&lt;embed[^&gt;]*type=&quot;([^&quot;]+)&quot;[^&gt;]*&gt;(?:&lt;\/embed&gt;)?/ig, function(full) {
			var attrs = _getAttrList(full);
			attrs.src = _undef(attrs.src, &#x27;&#x27;);
			attrs.width = _undef(attrs.width, 0);
			attrs.height = _undef(attrs.height, 0);
			return _mediaImg(self.themesPath + &#x27;common/blank.gif&#x27;, attrs);
		})
		.replace(/&lt;a[^&gt;]*name=&quot;([^&quot;]+)&quot;[^&gt;]*&gt;(?:&lt;\/a&gt;)?/ig, function(full) {
			var attrs = _getAttrList(full);
			if (attrs.href !== undefined) {
				return full;
			}
			return &#x27;&lt;img class=&quot;ke-anchor&quot; src=&quot;&#x27; + self.themesPath + &#x27;common/anchor.gif&quot; data-ke-name=&quot;&#x27; + escape(attrs.name) + &#x27;&quot; /&gt;&#x27;;
		})
		.replace(/&lt;script([^&gt;]*)&gt;([\s\S]*?)&lt;\/script&gt;/ig, function(full, attr, code) {
			return &#x27;&lt;div class=&quot;ke-script&quot; data-ke-script-attr=&quot;&#x27; + escape(attr) + &#x27;&quot;&gt;&#x27; + escape(code) + &#x27;&lt;/div&gt;&#x27;;
		})
		.replace(/&lt;noscript([^&gt;]*)&gt;([\s\S]*?)&lt;\/noscript&gt;/ig, function(full, attr, code) {
			return &#x27;&lt;div class=&quot;ke-noscript&quot; data-ke-noscript-attr=&quot;&#x27; + escape(attr) + &#x27;&quot;&gt;&#x27; + escape(code) + &#x27;&lt;/div&gt;&#x27;;
		})
		.replace(/(&lt;[^&gt;]*)(href|src)=&quot;([^&quot;]*)&quot;([^&gt;]*&gt;)/ig, function(full, start, key, src, end) {
			if (full.match(/\sdata-ke-src=&quot;[^&quot;]*&quot;/i)) {
				return full;
			}
			full = start + key + &#x27;=&quot;&#x27; + src + &#x27;&quot;&#x27; + &#x27; data-ke-src=&quot;&#x27; + _escape(src) + &#x27;&quot;&#x27; + end;
			return full;
		})
		.replace(/(&lt;[^&gt;]+\s)(on\w+=&quot;[^&quot;]*&quot;[^&gt;]*&gt;)/ig, function(full, start, end) {
			return start + &#x27;data-ke-&#x27; + end;
		})
		.replace(/&lt;table[^&gt;]*\s+border=&quot;0&quot;[^&gt;]*&gt;/ig, function(full) {
			if (full.indexOf(&#x27;ke-zeroborder&#x27;) &gt;= 0) {
				return full;
			}
			return _addClassToTag(full, &#x27;ke-zeroborder&#x27;);
		});
	});
});
})(window);

    </pre>
</div>

                </div>
            </div>
        </div>
    </div>
<a id="gotoTop" class='well well-small' href='#'>
    Top
</a>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/config.js"></script>
<script src="../assets/js/doc.js"></script>
</body>
</html>
