var system=require("system");function waitFor(testFx,onReady,timeOutMillis){var maxtimeOutMillis=timeOutMillis?timeOutMillis:10001,start=new Date().getTime(),condition=false,interval=setInterval(function(){if((new Date().getTime()-start<maxtimeOutMillis)&&!condition){condition=(typeof(testFx)==="string"?eval(testFx):testFx())}else{if(!condition){console.log("'waitFor()' timeout");phantom.exit(1)}else{typeof(onReady)==="string"?eval(onReady):onReady();clearInterval(interval)}}},100)}if(system.args.length!==2){console.log("Usage: run-qunit.js URL");phantom.exit(1)}var fs=require("fs");var page=require("webpage").create();page.onConsoleMessage=function(a){console.log(a)};page.onError=function(b,a){console.log(b);a.forEach(function(c){console.log("  ",c.file,":",c.line)})};var _openPath=phantom.args[0].replace(/^.*(\\|\/)/,"");var openPath=_openPath;var origdir="../js/";var basedir="../instrumented/";var coverageBase=fs.read("_coverage.html");if(fs.exists(basedir)){var script=/<script.*><\/script>/g,src=/src=(["'])(.*?)\1/,contents=fs.read(openPath),_contents=contents,srcs=[],s;while(script.exec(contents)){s=src.exec(RegExp.lastMatch)[2];if(s&&s.indexOf(origdir)!=-1){_contents=_contents.replace(s,s.replace(origdir,basedir))}}if(_contents!=contents){openPath+=".cov.html";fs.write(openPath,_contents)}}page.open(openPath,function(a){if(a!=="success"){console.log("Unable to access network");phantom.exit(1)}else{if(fs.exists(basedir)){for(var b=0;b<srcs.length;b++){page.includeJs(srcs[b])}}waitFor(function(){return page.evaluate(function(){var c=document.getElementById("qunit-testresult");if(c&&c.innerText.match("completed")){return true}return false})},function(){var e=JSON.parse(page.evaluate(function(){return JSON.stringify(getCoverageByLine())}));if(e.key){var j=e.lines;var i=origdir+fs.separator+e.key;var c=e.source;var h=readFileLines(i);var d="";for(var k=0;k<j.length;k++){var m=j[k+1];var l="";if(typeof m==="number"){l=" "+(m>0?"hit":"miss")}else{l=" undef"}var g=h[k];if(!c){g=g.replace("<","&lt;").replace(">","&gt;")}d+='<div class="code'+l+'">'+g+"</div>\n"}d=coverageBase.replace("COLORIZED_LINE_HTML",d);fs.write("coverage.html",d,"w");console.log("Coverage for "+e.key+" in coverage.html")}if(_openPath!=openPath){fs.remove(openPath)}var f=page.evaluate(function(){var n=document.getElementById("qunit-testresult");console.log(n.innerText);try{return n.getElementsByClassName("failed")[0].innerHTML}catch(o){}return 10000});phantom.exit((parseInt(f,10)>0)?1:0)})}});function readFileLines(c){var d=fs.open(c,"r");var b=[];var a;while(!d.atEnd()){b.push(d.readLine())}d.close();return b};