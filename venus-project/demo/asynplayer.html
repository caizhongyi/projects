<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<audio src="../media/T-Ara-CryCry.mp3" id="audio" controls></audio>
<script>

    window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext || window.msAudioContext;
    var context = new AudioContext();
    var source = null;
    var audioBuffer = null;
    function stopSound() {
        if (source) {
            source.noteOff(0); //立即停止
        }
    }
    function playSound() {
        source = context.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        source.connect(context.destination);
        source.noteOn(0); //立即播放
    }
    function initSound(arrayBuffer) {
        context.decodeAudioData(arrayBuffer, function(buffer) { //解码成功时的回调函数
            audioBuffer = buffer;
            playSound();
        }, function(e) { //解码出错时的回调函数
            console.log('Error decoding file', e);
        });
    }
    function loadAudioFile(url) {
        var xhr = new XMLHttpRequest(); //通过XHR下载音频文件
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) { //下载完成
            initSound(this.response);
        };
        xhr.send();
    }
    loadSoundFile('demo-audio.mp3');


  /*  loadSound("media/T-Ara-Cry Cry.mp3");
    //调用//定义加载音频文件的函数
    var visualize = function (audioContext, buffer) {
        var audioBufferSouceNode = audioContext.createBufferSource();
        audioBufferSouceNode.connect(audioContext.destination);
        audioBufferSouceNode.buffer = buffer;
        audioBufferSouceNode.start(0);
        *//*  analyser = audioContext.createAnalyser();
         //将source与分析器连接
         audioBufferSouceNode.connect(analyser);
         //将分析器与destination连接，这样才能形成到达扬声器的通路
         analyser.connect(audioContext.destination);
         //将上一步解码得到的buffer数据赋值给source
         audioBufferSouceNode.buffer = buffer;
         //播放
         audioBufferSouceNode.start(0);*//*
    }

    window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext || window.msAudioContext;
    //这里顺便也将requestAnimationFrame也打个补丁，后面用来写动画要用
    window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame;
    function loadSound(url) {
        var request = new XMLHttpRequest();
        //建立一个请求
        request.open('GET', url ,true);
        //配置好请求类型，文件路径等
        request.responseType = 'arraybuffer';//配置数据返回类型//一旦获取完成，对音频进行进一步操作，比如解码
        request.onload =function() {
            try {
                var audioContext = new window.AudioContext(); //从Visualizer得到最开始实例化的AudioContext用来做解码ArrayBuffer
            } catch (e) {
                return ;
                console.log('!Your browser does not support AudioContext');
            }

            var arraybuffer = request.response;
            var fileResult = e.target.result; //这是读取成功得到的结果ArrayBuffer数据
            audioContext.decodeAudioData(fileResult, function(buffer) { //解码成功则调用此函数，参数buffer为解码后得到的结果
                visualize(audioContext, buffer); //调用_visualize进行下一步处理，此方法在后面定义并实现
            }, function(e) { //这个是解码失败会调用的函数
                console.log("!哎玛，文件解码失败:(");
            });
        }
        request.send();
    }*/
</script>
</body>
</html>