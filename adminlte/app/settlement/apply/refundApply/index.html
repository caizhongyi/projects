    <!-- Content Header (Page header) -->
<section class="content-header" >
    <h1>
        {{ $state.current.page.title }}
        <small></small>
    </h1>
    <ol class="breadcrumb">
        <li ui-sref-active="active"><a href="#" ui-sref="mbs-index-home"><i class="fa fa-dashboard"></i>首页</a>
        </li>
        <li class="active">  {{ $state.current.page.title }} </li>
    </ol>
</section>
<!-- Main content -->
<section class="content slide" >
    <div class="box">
        <div class="box-header row modv2-header">
            <div class="form-group col-md-6"  ng-if="item.refund_type==1">
                <label >订单编号：</label>
                <span class="modv2-imp">{{ item.order_no }}</span>
            </div>
            <div class="form-group col-md-6"  ng-if="item.refund_type!=1">
                <label ng-if="item.order_contract.contract_no" >合同编号：</label>
                <span class="modv2-imp">{{ item.order_contract.contract_no }}</span>
            </div>
            <div class="form-group col-md-6 text-right">
                <i class="fa fa-exclamation-circle"></i>
                <span class="text-danger"><i class="icon-warning-sign"></i> 请注意 ：最终付款需经 <span class="text-danger">店长审核通过</span></span>
            </div>
        </div><!-- /.box-header -->


        <div class="box-body  no-padding" ng-switch=""  on="item.refund_type">
            <div class="box-body ng-scope modv2-titinfo"  ng-if="item.refund_type == 1">
                <div class=" form">
                    <span class="modv2-infoc">车牌号：<em>{{ item.order_contract.car_number }}</em></span>
                </div>
            </div>
            <div class="box-body ng-scope modv2-titinfo"  ng-if="item.refund_type!=1">
                <div class=" form">
                    <span class="modv2-infoc">车牌号：<em>{{ item.order_contract.car_number }}</em></span>
                    <span  ng-if="item.refund_type!=1">
                        <span class="modv2-line">|</span><span class="modv2-infoc">车辆品牌：<em>{{ item.order_contract.vehicle_brand}}</em></span>
                        <span class="modv2-line">|</span><span class="modv2-infoc">成交价：<em class="modv2-imp">{{ item.order_contract.sale_price}}</em></span>
                        <span class="modv2-line">|</span><span class="modv2-infoc">买主姓名：<em>{{ item.order_contract.buyer_name}}</em></span><span class="modv2-line">|</span>
                        <span class="modv2-infoc">代理人：<em>{{ item.order_contract.buyer_agent_name}}</em></span>
                    </span>

                </div>
            </div>


            <div class="box-body clearfix">
                <div class="pull-right ">
                    请注意：退款秉承原卡原退的财务原则，请保持收款卡号和刷卡卡号一致
                </div>
                <div class="form form-inline" ng-if="item.refund_type!=1">
                    <div class="form-group"><label><input type="radio" name="refund_type" ng-model="item.refund_type" value="2" ng-checked="true"/> 车款</label></div>
                    <div class="form-group"><label><input type="radio" name="refund_type" ng-model="item.refund_type" value="3" /> 服务费</label></div>
                </div>
            </div>

            <form name="form" ng-submit="submit(form.$valid)"  role="form" novalidate  ng-switch-default="">
                <div class="box-body no-padding" >
                    <span ng-if="item.refund_type==2">最多申请：<span class="text-danger">{{ item.max_detail.car_fee | toFixed }}</span>元（已申请支付：{{ (item.applied.anency_fee + item.applied.brokerage  + item.applied.car_fee  + item.applied.dept_payment  + item.applied.other_fee  + item.applied.refund_fee  + item.applied.transfer_fee) | toFixed }} 元，已申请车款退款：{{ (item.refund_total_fee - item.service_refund_total) | toFixed }}元）</span>
                    <table class="table table-hover modv2-table modv2-table-ex2" >
                        <tbody>
                        <tr>
                            <td width="3%" ng-if="item.refund_type!=1">选择</td>
                            <td width="9%">收款日期</td>
                            <td width="16%">卡号</td>
                            <td width="8%">收款金额(元)</td>
                            <td>收款笔数</td>
                            <td width="9%" ng-if="item.refund_type != 1">已退金额(元)</td>
                            <td width="8%">退款金额(元)</td>
                            <td width="8%">收款人</td>
                            <td>开户银行</td>
                            <td>开户支行</td>
                            <td width="5%">卡别</td>
                        </tr>
                        <tr ng-repeat="row in item.transfer_info" class="list-animation">
                            <td ng-if="item.refund_type!=1">
                                <input type="checkbox" ng-model="row.selected" ng-checked="selected()"/>
                            </td>
                            <td >
                                {{ row.trans_time2  ? ( row.trans_time2 * 1000 | date:"yyyy-MM-dd HH:mm:ss") : '' }}
                            </td>
                            <td >
                                <span ng-if="row.card_no_trans.indexOf('*') > 0">
                                    {{ row.card_no_trans.substring(0, row.card_no_trans.indexOf('*')) }}
                                    <input type="text" ng-model="row.card_no2"  style="width:7em" name="card_no2{{$index}}" ng-required="row.required || (item.refund_type==1 && row.fee)"/>
                                    {{ row.card_no_trans.substring(row.card_no_trans.lastIndexOf('*') + 1 , row.card_no_trans.length ) }}
                                    <div class="has-feedback text-danger " ng-messages="form.card_no2{{$index}}.$error"
                                         ng-show="form.card_no2{{$index}}.$error">
                                        <div ng-message="required" class="text-center"><i class="fa fa-info-circle"></i>请补全卡号！</div>
                                    </div>
                                </span>
                                <span ng-if="row.card_no_trans.indexOf('*') == -1  || !row.card_no_trans.indexOf('*')">
                                    {{ row.card_no_trans }}
                                </span>
                            </td>
                            <td >
                                <span ng-bind-html="row.payment_amount | price : 'modv2-impb'"></span>
                            </td>
                            <td>
                                {{ row.number_of_trans }}
                            </td>
                            <td  ng-if="item.refund_type != 1">
                                <span ng-bind-html="row.refund_amount | price : 'modv2-impb'"></span>
                            </td>
                            <td >
                                <span  ng-if="item.refund_type==1" ng-bind-html="row.fee | price : 'modv2-impb'"></span>
                                <input ng-if="item.refund_type!=1" type="text" name="fee_{{ $index }}" ng-model="row.fee" class="form-control" ng-required="row.required"/>
                                <div ng-if="item.refund_type!=1" class="has-feedback text-danger" ng-messages="form.fee_{{$index}}.$error"
                                     ng-show="interacted(form.fee_{{$index}})">
                                    <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入退款金额！</div>
                                </div>
                            </td>
                            <td >
                                <input ng-if="row.fee || item.refund_type!=1" type="text" ng-model="row.payee_realname"  name="payee_realname_{{ $index }}" class="form-control" ng-required="item.refund_type == 1 ? true : row.required"/>
                                <div class="has-feedback text-danger" ng-messages="form.payee_realname_{{$index}}.$error"
                                     ng-show="interacted(form.payee_realname_{{$index}})">
                                    <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入收款人！</div>
                                </div>
                            </td>
                            <td >
                                <input ng-if="row.fee || item.refund_type!=1" type="text" ng-model="row.payee_bank"   name="payee_bank_{{ $index }}" class="form-control" auto-complete="" ng-required="item.refund_type == 1 ? true : row.required"/>
                                <div class="has-feedback text-danger" ng-messages="form.payee_bank_{{$index}}.$error"
                                     ng-show="interacted(form.payee_bank_{{$index}})">
                                    <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入开户银行！</div>
                                </div>
                            </td>
                            <td >
                                <input ng-if="row.fee || item.refund_type!=1" type="text" ng-model="row.payee_bank_branch"  name="payee_bank_branch_{{ $index }}"  class="form-control" auto-complete-branch="" ng-required="item.refund_type == 1 ? true : row.required"/>
                                <div class="has-feedback text-danger" ng-messages="form.payee_bank_branch_{{$index}}.$error"
                                     ng-show="interacted(form.payee_bank_branch_{{$index}})">
                                    <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入开户支行！</div>
                                </div>
                            </td>
                            <td>
                                {{ row.card_type }}
                            </td>
                        </tr>

                        <tr class="">
                            <td></td>
                            <th class="text-center">合计</th>
                            <td ng-if="item.refund_type != 1"></td>
                            <td colspan="{{ item.refund_type ==1 ? 2: 3 }}"></td>
                            <td><span ng-bind-html="item.sum | price : 'modv2-impb'"></span></td>
                            <td colspan="{{refund_type != 1 ? 5 : 6}}"></td>
                        </tr>
                        <tr class="">
                            <th colspan="2">退款原因：</th>
                            <td colspan="{{ item.refund_type ==1 ? 6 : 7 }}">
                                <textarea name="reason" id="reason" placeholder="退款原因" class="form-control" ng-model="item.reason" required></textarea>
                                <div class="has-feedback text-danger" ng-messages="form.reason.$error"
                                     ng-show="interacted(form.reason)">
                                    <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入退款原因！</div>
                                </div>
                            </td>
                            <td colspan="{{ item.refund_type ==1 ? 1 : 2 }}"><button type="submit" class="modv2-btn modv2-btn-ex btn btn-success">提交申请</button></td>
                        </tr>
                        </tbody>



                    </table>
                </div >
            </form>


            <form name="formService" ng-submit="submitService(formService.$valid , 'submittedService')"  role="form" novalidate ng-switch-when="3">
                <!-- ------start------- -->

                <div class="box-body no-padding" >
                <span>最多申请：<span class="text-danger">{{ item.max_service_fee | toFixed}}</span>元（已申请支付：{{ (item.applied.anency_fee + item.applied.brokerage  + item.applied.car_fee  + item.applied.dept_payment  + item.applied.other_fee  + item.applied.refund_fee  + item.applied.transfer_fee) | toFixed}} 元，已申请服务费退款：{{ item.service_refund_total | toFixed}}元）</span>
                <table class="table table-hover modv2-table modv2-table-ex2" >
                    <tbody>
                    <tr>
                        <td width="3%">选择</td>
                        <td width="9%">收款日期</td>
                        <td width="16%">卡号</td>
                        <td width="8%">收款金额(元)</td>
                        <td width="6%">收款笔数</td>
                        <td width="9%">已退金额(元)</td>
                        <td width="23%">退款项目</td>
                        <td width="16%">收款信息</td>
                        <td width="5%">卡别</td>
                    </tr>
                    <tr class="list-animation" ng-repeat="t_item in item.transfer_info">
                        <td><input type="checkbox" ng-model="t_item.selected" ng-checked="serviceSelected()"/></td>
                        <td >{{ t_item.trans_time2  ? ( t_item.trans_time2 * 1000 | date:"yyyy-MM-dd HH:mm:ss") : '' }}</td>
                        <td >
                            <span ng-if="t_item.card_no_trans.indexOf('*') > 0">
                                {{ t_item.card_no_trans.substring(0, t_item.card_no_trans.indexOf('*')) }}
                                <input type="text" ng-model="t_item.card_no2"  style="width:7em" name="card_no2{{$index}}" ng-required="t_item.required"/>
                                {{ t_item.card_no_trans.substring(t_item.card_no_trans.lastIndexOf('*') + 1 , t_item.card_no_trans.length ) }}

                                <div class="has-feedback text-danger " ng-messages="formService.card_no2{{$index}}.$error"
                                     ng-show="formService.card_no2{{$index}}.$error">
                                    <div ng-message="required" class="text-center"><i class="fa fa-info-circle"></i>请补全卡号！</div>
                                </div>
                            </span>
                            <span ng-if="t_item.card_no_trans.indexOf('*') == -1 || !t_item.card_no_trans.indexOf('*')">
                                {{ t_item.card_no_trans }}
                            </span>
                        </td>
                        <td ><span ng-bind-html="t_item.payment_amount | price : 'modv2-impb'"></span></td>
                        <td>{{ t_item.number_of_trans }}</td>
                        <td><span ng-bind-html="t_item.refund_amount | price : 'modv2-impb'"></span></td>
                        <td style="text-align: left">
                            <div>
                                信息服务费:
                                <input type="text" style="width: 6em" id="brokerage{{ $index }}" name="brokerage{{ $index }}" ng-model="t_item.brokerage"  money-validator="" max-number="t_item.service_max.brokerage">
                                <span>(可申请<span class="text-danger">{{ (t_item.service_max.brokerage ? t_item.service_max.brokerage : 0) | toFixed}}</span>元)</span>
                            </div>
                            <div>
                                代办过户费:
                                <input type="text" style="width: 6em" id="anency_fee{{ $index }}" name="anency_fee{{ $index }}" ng-model="t_item.anency_fee"  money-validator="" max-number="t_item.service_max.anency_fee">
                                <span>(可申请<span class="text-danger">{{ (t_item.service_max.anency_fee ? t_item.service_max.anency_fee : 0)| toFixed }}</span>元)</span>
                            </div>
                            <div>
                                　　过户费:
                                <input type="text" style="width: 6em" id="transfer_fee{{ $index }}" name="transfer_fee{{ $index }}" ng-model="t_item.transfer_fee"  money-validator="" max-number="t_item.service_max.transfer_fee">
                                <span>(可申请<span class="text-danger">{{ (t_item.service_max.transfer_fee ? t_item.service_max.transfer_fee : 0) | toFixed}}</span>元)</span>
                            </div>
                            <div>
                                　其它费用:
                                <input type="text" style="width: 6em" id="other_fee{{ $index }}" name="other_fee{{ $index }}" ng-model="t_item.other_fee"  money-validator="" max-number="t_item.service_max.other_fee">
                                <span>(可申请<span class="text-danger">{{ (t_item.service_max.other_fee ? t_item.service_max.other_fee : 0)| toFixed}}</span>元)</span>
                            </div>
                        </td>
                        <td >
                            <div style="margin:4px 0;">　收款人：<input type="text" ng-model="t_item.payee_realname" ng-required="t_item.required"  name="payee_realname_{{ $index }}" style="width:60%;"/></div>
                            <div style="margin:4px 0;">开户银行：<input type="text" ng-model="t_item.payee_bank"   name="payee_bank_{{ $index }}" auto-complete="" ng-required="t_item.refund_type == 1 ? true : t_item.required" style="width:60%;"/></div>
                            <div style="margin:4px 0;">开户支行：<input type="text" ng-model="t_item.payee_bank_branch"  name="payee_bank_branch_{{ $index }}" auto-complete-branch="" ng-required="t_item.refund_type == 1 ? true : row.required" style="width:60%;"/></div>
                        </td>
                        <td>
                            {{ t_item.card_type }}
                        </td>
                    </tr>
                    <tr class="">
                        <td></td>
                        <th class="text-center">合计</th>
                        <td colspan="4"></td>
                        <td><span ng-bind-html="t_item.sum | price : 'modv2-impb'"></span></td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="">
                        <th colspan="2">退款原因：</th>
                        <td colspan="5">
                            <textarea name="reason" id="reason" placeholder="退款原因" class="form-control" ng-model="item.reason" required></textarea>
                            <div class="has-feedback text-danger" ng-messages="formService.reason.$error"
                                 ng-show="formService.reason.$error">
                                <div ng-message="required"><i class="fa fa-info-circle"></i> 退款原因！</div>
                            </div>
                        </td>
                        <td colspan="2"><button type="submit" class="modv2-btn modv2-btn-ex btn btn-success">提交申请</button></td>
                    </tr>
                    </tbody>



                </table>
            </div >



                <!-- --------end------- -->

            </form>
        </div>

    </div>
</section>
<!-- /.content -->



