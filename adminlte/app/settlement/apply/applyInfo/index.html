<!-- Content Header (Page header) -->
<section class="content-header" >
    <h1>
        {{ $state.current.page.title }}
        <small></small>
    </h1>
    <ol class="breadcrumb">
        <li ui-sref-active="active"><a href="#" ui-sref="mbs-index-home"><i class="fa fa-dashboard"></i>首页</a>
        </li>
        <li class="active">  {{ $state.current.page.title }} </li>
    </ol>
</section>
<!-- Main content -->
<section class="content slide" >
    <div class="box">
        <form name="form" ng-submit="submit(form.$valid)"  role="form" novalidate>
            <div class="box-body  no-padding">
                <div class=" form">
                    <div class="modv2-bheader clearfix">
                        <div class="modv2-bheader-in ">
                            <span class="modv2-c">合同编号：{{ item.orderInfo.order_contract.contract_no }}</span>|<span class="modv2-c">成交价：<span class="modv2-imp">{{ item.orderInfo.order_contract.sale_price | number : 0 }}</span>|<span class="modv2-c"><span class="modv2-imp">{{ item.orderInfo.is_jhc_name}}</span></span>
                            <span class="pull-right modv2-c">订单号：<span class="modv2-imp">{{item.orderInfo.order_no}}</span></span>
                        </div>
                    </div>
                    <div class="box-body no-padding">
                        <table class="table modv2-table table-hover">
                            <tbody>
                            <tr>
                                <td colspan="4">
                                    <span class="form-group ng-binding">
                                        <span class="modv2-c">车牌号：{{ item.orderInfo.car_number }}</span> |
                                        <span class="modv2-c">车型：{{ item.orderInfo.order_contract.vehicle_brand }} {{ item.orderInfo.order_contract.vehicle_series }} {{ item.orderInfo.order_contract.vehicle_model }}</span> |
                                        <span class="modv2-c">车架号：{{ item.orderInfo.order_contract.frame_number }}</span>
                                        <span class="modv2-c" ng-if="item.orderInfo.order_contract.vehicle_guide_price"> | 出厂报价：</label> {{ item.orderInfo.order_contract.vehicle_guide_price }} + {{item.orderInfo.order_contract.vehicle_guide_price_tax}}</span>
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 卖方姓名：</label> {{ item.orderInfo.order_contract.seller_name }}</span><span class="modv2-c" ng-show="item.orderInfo.order_contract.seller_cert_no!=''"> | {{ item.orderInfo.order_contract.seller_cert_no }}
                                    {{ item.orderInfo.order_contract.seller_cert_type == 1 ? '(身份证)' : '(其他)' }}<span class="modv2-c" ng-show="item.orderInfo.order_contract.seller_phone!=''"> |
                                    {{ item.orderInfo.order_contract.seller_phone }}<span class="text-danger" ng-if="item.orderInfo.order_contract.seller_phone_role">({{item.orderInfo.order_contract.seller_phone_role}}电话)</span></span>
                                    </span>
                                </td>
                                <td colspan="2">
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 卖方代理人：</label> {{ item.orderInfo.order_contract.seller_agent_name }}</span><span class="modv2-c" ng-show="item.orderInfo.order_contract.seller_agent_cert_no!=''"> | {{ item.orderInfo.order_contract.seller_agent_cert_no }}
                                    {{ item.orderInfo.order_contract.seller_agent_cert_type == 1 ? '(身份证)' : '(其他)' }}<span class="modv2-c" ng-show="item.orderInfo.order_contract.seller_agent_phone!=''"> |
                                    {{ item.orderInfo.order_contract.seller_agent_phone }}<span class="text-danger" ng-if="item.orderInfo.order_contract.seller_agent_phone_role">({{item.orderInfo.order_contract.seller_agent_phone_role}}电话)</span></span>
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 买方姓名：</label> {{ item.orderInfo.order_contract.buyer_name }}</span><span class="modv2-c" ng-show="item.orderInfo.order_contract.buyer_cert_no!=''"> | {{ item.orderInfo.order_contract.buyer_cert_no }}
                                    {{ item.orderInfo.order_contract.buyer_cert_type == 1 ? '(身份证)' : '(其他)' }}<span class="modv2-c" ng-show="item.orderInfo.order_contract.buyer_phone!=''"> |
                                    {{ item.orderInfo.order_contract.buyer_phone }} <span class="text-danger"  ng-if="item.orderInfo.order_contract.buyer_phone_role">({{item.orderInfo.order_contract.buyer_phone_role}}电话)</span></span>
                                    </span>
                                </td>
                                <td colspan="2">
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 买方代理人：</label> {{ item.orderInfo.order_contract.buyer_agent_name }}</span><span class="modv2-c" ng-show="item.orderInfo.order_contract.buyer_agent_cert_no!=''"> | {{ item.orderInfo.order_contract.buyer_agent_cert_no }}
                                    {{ item.orderInfo.order_contract.buyer_agent_cert_type == 1 ? '(身份证)' : '(其他)' }}<span class="modv2-c" ng-show="item.orderInfo.order_contract.buyer_agent_phone!=''"> |
                                    {{ item.orderInfo.order_contract.buyer_agent_phone }} <span class="text-danger" ng-if="item.orderInfo.order_contract.buyer_agent_phone_role">({{item.orderInfo.order_contract.buyer_agent_phone_role}}电话)</span></span>
                                    </span>
                                </td>
                            </tr>
                            <tr ng-if="item.applyInfo.fee_type == 1 || item.applyInfo.fee_type == 2 || item.applyInfo.fee_type == 4">
                                <td colspan="4">
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 收款姓名：</label> {{ item.orderInfo.order_contract.payee_realname }}</span>
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span>联系电话：</label>{{ item.orderInfo.order_contract.payee_mobile }}</span>
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 证件号码：</label> {{ item.orderInfo.order_contract.payee_idcard }}</span>
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span>收款账户：</label>{{ item.orderInfo.order_contract.payee_cardno }}</span>
                                    <span class="form-group ng-binding"><label><span class="text-danger"></span> 收款银行：</label> {{ item.orderInfo.order_contract.payee_bank }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th width="12%"><h4 class="box-title">收款信息</h4></th>
                                <td width="31%">
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 收款门店：</label>  {{ item.applyInfo.dept_name }}</div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 申请款项：</label> {{ item.applyInfo.fee_type === 2 ? '服务费' : item.applyInfo.apply_detail[0].detail_type_name }} </div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 申请金额：</label>  <span class="text-danger">{{ item.applyInfo.fee }}</span>元</div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> </label>
                                        <label style="width: 150px; text-align: left"  >
                                            <span>
                                                已收：{{item.orderInfo.received_fee | price}}  已到：{{item.transferEntryMoney | price}}
                                            </span>
                                            <br/>
                                            <span style="float:left">
                                                已付：{{item.payMoney | price}}
                                            </span>
                                        </label>
                                    </div>

                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 收款姓名：</label> {{ item.applyInfo.payee_realname }} </div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 联系电话：</label>{{ item.applyInfo.payee_mobile }} <span class="text-danger" ng-if="item.orderInfo.order_contract.payee_mobile_rol">( {{ item.orderInfo.order_contract.payee_mobile_role }}电话)</span></div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 证件号码：</label>{{ item.applyInfo.payee_idcard }}</div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 收款账户：</label> {{ item.applyInfo.payee_cardno }} </div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 收款银行：</label>
                                        {{ item.applyInfo.old_payee_bank }}
                                        <span ng-if="utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage') && (item.applyInfo.fee_type == 1 || item.applyInfo.fee_type == 4)"><input type="text" class="form-control" auto-complete ng-model="item.applyInfo.payee_bank" /> <div ng-if="item.applyInfo.payee_bank_code == 0 && !autoCompleteName"><img src="http://sta.273.com.cn/app/backend/img/1.jpg" alt=""></div></span>
                                    </div>
                                    <div class="form-group ng-binding"><label><span class="text-danger"></span> 开户支行：</label>
                                        {{ item.applyInfo.old_payee_bank_branch }}
                                        <span ng-if="utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage') &&  (item.applyInfo.fee_type == 1 || item.applyInfo.fee_type == 4)"><input type="text" class="form-control"  auto-complete-branch="" ng-model="item.applyInfo.payee_bank_branch"/> <div ng-if="item.applyInfo.payee_bank_branch_code == 0&& !autoCompleteBranchName"><img src="http://sta.273.com.cn/app/backend/img/1.jpg" alt=""></div></span>
                                    </div>
                                </td>
                                <td colspan="2">
                                    <a href="javascript:;" style="margin-right: 10px;float:left;text-align: center"  ng-repeat="row in item.pics track by $index" ><img ng-src="{{row}}" alt="" class="img-rounded" ng-click="showImage(row)" width="200" height="200"/>
                                    <br/><span style="color:#ff0000">{{alt[row]}}</span>
                                    </a>
                                </td>
                            </tr>
                            <tr ng-show="cropZoomImage">
                                <td colspan="100%">
                                    <div class="img-container text-center" crop-zoom="cropZoomImage" >
                                        <div class="image-btns">
                                            <button class="btn btn-primary modv2-btn rotate-left"  type="button">左旋转</button>
                                            <button class="btn btn-primary modv2-btn rotate-right" type="button">右旋转</button>
                                            <button class="btn btn-primary modv2-btn delete" type="button">关闭</button>
                                        </div>
                                        <div class="image-crop">
                                            <img  src="{{cropZoomImage}}" />
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr ng-if="utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage')">
                                <td> <h4 class="box-title text-center"> 店长审核意见：</h4></td>
                                <td colspan="2">{{ item.applyInfo.dept_check_note }}&nbsp&nbsp&nbsp&nbsp&nbsp{{ item.applyInfo.dept_check_time ? ( item.applyInfo.dept_check_time * 1000 | date : 'yyyy-MM-dd HH:mm:ss' ) : '未审核'}}</td>
                            </tr>
                            <tr ng-if="utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage') && $stateParams.preview && (item.applyInfo.status == 2 || item.applyInfo.status == 4)">
                                <td> <h4 class="box-title text-center"> 财务审核意见：</h4></td>
                                <td colspan="2">{{ item.applyInfo.caiwu_check_note }}</td>
                            </tr>
                            <tr ng-if="item.applyInfo.fee_type == 3">
                                <td><h4 class="box-title"><span class="text-danger">*</span> 申请理由：</h4></td>
                                <td colspan="2">{{ item.applyInfo.reason }}</td>
                            </tr>
                            <tr ng-if="item.applyInfo.fee_type == 4">
                                <td><h4 class="box-title text-center"><span class="text-danger">*</span> 退款原因：</h4></td>
                                <td colspan="2">{{ item.applyInfo.reason }}</td>
                            </tr>
                            <tr ng-if="!$stateParams.preview">
                                <th>
                                    <h4 class="box-title"> 审核意见：</h4>
                                </th>
                                <td colspan="3">
                                    <textarea name="pay_check_note" id="pay_check_note" placeholder="审核意见" class="form-control" ng-model="submitter.pay_check_note" required></textarea>
                                    <div class="has-feedback text-danger" ng-messages="form.pay_check_note.$error" ng-show="interacted(form.pay_check_note)">
                                        <div ng-message="required"><i class="fa fa-info-circle"></i> 请输入审核意见！</div>
                                    </div>
                                </td>
                            </tr>
                            </tbody></table>
                    </div>
                </div>

                <div class="box-footer" ng-if="!$stateParams.preview">
                    <button class="btn btn-primary modv2-btn" type="button" ng-click="checkContract()" ng-show="utils.hasCode('settlement|apply|applycheck') && utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage')">审核合同</button>
                    <button class="btn btn-primary modv2-btn"  type="button" ng-click="pass()" >审核通过</button>
                    <button class="btn btn-default modv2-btn"  type="button" ng-show="item.applyInfo.fee_type != 9" ng-click="rejected()">审核拒绝</button>
                    <button class="btn btn-primary modv2-btn"  type="button" ng-click="back()" ng-show="utils.hasCode('settlement|apply|applycheck') && utils.hasRoleCode('cfb.caiwu.recheck,cfb.caiwu.manage')">退出审核</button>
                </div>

                <table class="table table-hover">
                    <tbody><tr>
                        <th width="12%" rowspan="2">订单金额</th>
                        <th width="10%">车款</th>
                        <th width="8%">信息服务费</th>
                        <th width="13%">过户费</th>
                        <th>代办过户费</th>
                        <th width="15%">其它费用(元)</th>
                    </tr>
                    <tr >
                        <td class="text-center"> {{ item.orderInfo.car_fee | price }} </td>
                        <td class="text-center"> {{ item.orderInfo.brokerage | price }}  </td>
                        <td class="text-center"> {{ item.orderInfo.transfer_fee | price }}  </td>
                        <td class="text-center"> {{ item.orderInfo.anency_fee | price }}  </td>
                        <td class="text-center"> {{ item.orderInfo.other_fee | price }} </td>
                    </tr>
                    </tbody>
                </table>
                <div class="box-footer"></div>

                <table class="table table-hover">
                    <tbody>
                    <tr>
                        <th width="12%" rowspan="{{ item.transferList.length + 2 }}">收款记录</th>
                        <th width="5%">收款方式</th>
                        <th width="8%">参考信息</th>
                        <th width="10%">收款金额</th>
                        <th width="8%">手续费</th>
                        <th width="8%">卡别</th>
                        <th width="8%">卡号</th>
                        <th>收款银行</th>
                        <th width="15%">收款时间</th>
                        <th width="10%">操作</th>
                    </tr>
                    <tr ng-repeat="item in item.transferList">
                        <td class="text-center"> {{ item.pay_channel |pay_channel }} </td>
                        <td class="text-center"> {{ item.pay_channel == 4 ? item.opp_account_name : item.voucher_no }} </td>
                        <td class="text-center"> {{ item.payment_amount | price }}<span data-ng-show="item.pay_channel != 4 && utils.hasRoleCode('cfb.caiwu,cfb.caiwu.recheck,cfb.caiwu.manage,cfb.caiwu.pay,cfb.business')">( {{item.entry_time ? '已到账' : '未到账'}} )</span> </td>
                        <td ng-if="utils.hasRoleCode('cfb.caiwu,cfb.caiwu.recheck,cfb.caiwu.manage,cfb.caiwu.pay,cfb.business')" class="text-right">{{ item.handling_fee }}<span class="text-danger" ng-if="item.is_free_handling_fee">(免收)</span></td>
                        <td ng-if="!utils.hasRoleCode('cfb.caiwu,cfb.caiwu.recheck,cfb.caiwu.manage,cfb.caiwu.pay,cfb.business')" class="text-right">{{ item.dept_handling_fee }}<span class="text-danger" ng-if="item.is_free_handling_fee">(免收)</span></td>
                        <td class="text-center"> {{ item.card_type | cardType  }}</td>
                        <td> {{ item.card_no }} </td>
                        <td class="text-center"> {{ item.receiving_bank }} </td>
                        <td class="text-center"> {{ item.trans_time ? ( item.trans_time * 1000 | date : 'yyyy-MM-dd' ) : '--'}} </td>
                        <td class="text-center">
                            <a href="{{ item.sign_url }}" ng-if="item.sign_url" target="_blank">查看签购单</a>
                            <span ng-if="!item.sign_url && item.pay_channel != 4">无签购单</span>
                        </td>
                    </tr>
                    <tr class="modv2-num">
                        <td class="text-center" colspan="2"> 合计</td>
                        <td class="text-center"> {{ payment_amount_sum | price }}</td>
                        <td ng-if="utils.hasRoleCode('cfb.caiwu,cfb.caiwu.recheck,cfb.caiwu.manage,cfb.caiwu.pay,cfb.business')" class="text-right">{{ handling_fee_sum }}</td>
                        <td ng-if="!utils.hasRoleCode('cfb.caiwu,cfb.caiwu.recheck,cfb.caiwu.manage,cfb.caiwu.pay,cfb.business')" class="text-right">{{ dept_handling_fee_sum }}</td>
                        <td colspan="5"></td>
                    </tr>
                    </tbody>
                </table>
                <div class="box-footer"></div>

         <!--       <div class="box-header" >
                    <h3 class="box-title">付款记录 <small>已支付：车款 {{ item.pay_car_fee_sum | price }} 元；信息服务费 {{ item.pay_brokerage_sum | price }} 元；过户费 {{ item.pay_transfer_fee_sum }} </small></h3>
                </div>-->
                <table class="table table-hover" >
                    <tbody>
                    <tr>
                        <th width="12%" rowspan="{{ item.applyList.length + 2 }}">付款记录</th>
                        <th > 申请支付用途</th>
                        <th >申请金额</th>
                        <th >收款人名称</th>
                        <th >收款银行</th>
                        <th >付款时间</th>
                        <th >付款状态</th>
                    </tr>
                    <tr ng-repeat="item in item.applyList">
                        <td class="text-center"> {{ item.fee_type | feeType }}</td>
                        <td class="text-center"> {{ item.fee | price}} </td>
                        <td class="text-center"> {{ item.payee_realname }} </td>
                        <td class="text-center"> {{ item.payee_bank }}</td>
               
                        <td class="text-center"> {{ item.pay_time ? ( item.pay_time * 1000 | date : 'yyyy-MM-dd' ) : '--'}} </td>
                        <td class="text-center"> {{ item.pay_status_name }} </td>
                    </tr>
                    <tr class="modv2-num">
                        <td class="text-center"> 合计:</td>
                        <td class="text-center"> {{ fee_sum | price}} </td>
                        <td colspan="5"></td>
                    </tr>
                    </tbody>
                </table>
                <div class="box-footer"></div>
            </div>
        </form>
    </div>

</section>
<!-- /.content -->

<script type="text/ng-template" id="tpl-confirm.html">
    <form role="form" name="addForm">
        <div class="modal-header">
            <button aria-label="Close" data-dismiss="modal" class="close" type="button" ng-click="cancel()"><span aria-hidden="true">×</span></button>
            <h3 class="modal-title">提示</h3>
        </div>
        <div class="modal-body text-center">
            {{msg}}
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary modv2-btn" ng-click="ok()" type="button" ng-disabled="submitted">确认</button>
            <button class="btn btn-primary modv2-btn"  ng-click="cancel()" type="button" >取消</button>
        </div>
    </form>
</script>
<script type="text/ng-template" id="tpl-confirm-contract.html">
    <form role="form" name="submit">
        <div class="modal-header">
            <button aria-label="Close" data-dismiss="modal" class="close" type="button" ng-click="cancel()"><span aria-hidden="true">×</span></button>
            <h3 class="modal-title">提示</h3>
        </div>
        <div class="modal-body text-lef">
            如果驳回请填写驳回理由
        </div>
        <div class="modal-body text-center">
            <textarea name="check_note" id="check_note" placeholder="请填写驳回理由" class="form-control"  ng-model="submitter.check_note" required></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary modv2-btn" ng-click="pass()" type="button" ng-if="item.orderInfo.order_contract.status != 2">审核通过</button>
            <button class="btn btn-primary modv2-btn"  ng-click="reject()" type="button" >驳回</button>
        </div>
    </form>
</script>

