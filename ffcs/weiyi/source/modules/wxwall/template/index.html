<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>留言板</title>
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no;">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<link href="./source/modules/message/template/css/message.css" rel="stylesheet" type="text/css">
</head>
<script type="text/javascript" src="./resource/script/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="./source/modules/wxwall/template/common.js"></script>
<!-- <link type="text/css" rel="stylesheet" href="./source/modules/wxwall/template/common.css" /> -->
<!-- <script type="text/javascript" src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script> -->
<body id="message" >
<div class="qiandaobanner"><a   href="javascript:history.go(-1);"><img src="./source/modules/wxwall/template/image/top_banner.jpg" ></a> </div>
<div class="cardexplain">
	<div class="window" id="windowcenter">
		<div id="title" class="wtitle">操作提示<span class="close" id="alertclose"></span></div>
		<div class="content">
			<div id="txt"></div>
		</div>
	</div>
<div class="history">
    <div class="history-date">
    	<style>
            .btn{ border:1px solid #ddd; font-size:14px; font-weight:normal; padding:5px 10px; background:#eee}
			.time{ font-size:16px; }
	    </style>
     
      <h2 class="first first1" style="position: relative;">
		   <a href="javascript:;"  id="status"  class="btn">暂停</a>
		   <a href="javascript:window.location.reload();"  class="btn">刷新</a>
		   <span class="time">倒计时：<a href="javascript:;"  id="remaintime" style="color:red; font-weight:600;">0</a></span>
      </h2>
      <h2 class="first first1" style="position: relative;">
		 	<a href="javascript:;" onclick="wxwall.prevPage()" class="btn">上一页</a>
			<a href="javascript:;" onclick="wxwall.nextPage()" class="btn">下一条</a>
	   </h2>
		<div id="msg_list_wrap">
			<ul id="msg_list">
			</ul>
		</div>
	<!-- <ul>
       {loop $messagelist $row}
         <li class="green bounceInDown">
          <h3>{$row['nickname']}<span>{php echo date('Y-m-d H:i:s', $row['createtime']);}</span><div class="clr"></div></h3>
          <dl>
            <dt class="hfinfo" date="{$row['id']}" >{$row['content']}</dt>
          </dl>
        </li>
	  {/loop}
	  </ul>    
 
      <li class="bounceInDown">
			<div class="pagination">
              <div class="left"><a href="{$prepage}">上一页</a></div>
				<div class="allpage">
	              <div class="currentpage"> {$p} / {$totalpage}</div>
				</div>
	            <div class="right " > <a href="{$nextpage}">下一页</a></div>
				<div class="clr"></div>
			</div>
		</li> -->
     
    </div>
    
    
  </div>
</div>

<script type="text/javascript">
var messagehistory = {php echo json_encode($messagelist)};
var wxwall = {
	'options' : {
		'index' : -1,
		'pagesize' : 1,
		'delaytime' : 8000,
		'wrapHeight' : 0,
		'pause' : false
	},
	'temp' : '',
	'status' : {'prev' : false, 'next' : true},
	'timer' : {},
	'timerdown' : {},
	'lastmsgtime' : 0,
	'page' : 1,
	'txwall' : {
		'status' : 1,
		'lastmsgtime' : '{$_W['timestamp']}',
		'lastuser' : '',
	},
	'init' : function() {
		var $this = this;
		this.options.wrapHeight = $('#msg_list_wrap').height();
		this.prevPage();
		this.control('start');
		$('#remaintime').html(0);
	},
	'buildItem' : function(message) {/*构造一条微墙内容*/
		if ($('#msg_list #msg_'+message['id'])[0]){
			return '';
		}
		if (this.lastmsgtime <= 0) {
			this.lastmsgtime = message['createtime'];
		}
		var date = new Date(parseInt(message['createtime']) * 1000);
		
		var html = '<li class="green bounceInDown talkList" id="msg_'+message['id']+'" style="display:none; height:auto;">';
		html += '<h3>'+message['nickname']+'<span>'+date.getFullYear() + '-'+ (date.getMonth() + 1) + '-' + date.getDate()+ ' ' + date.getHours() + ':' + date.getMinutes()+ ':' + date.getSeconds()   +'</span><div class="clr"></div></h3>';
		html += '<dl><dt class="hfinfo" date="'+message['id']+'" >'+message['content']+'</dt></dl></li>';
		
		return html;
	},
	'appendItem' : function(message) {/*向后插入一条消息*/
		if (!message) {
			return false;
		}
		$('#msg_list').append(this.buildItem(message));
		$('#msg_list li:last-child').css('display', 'block');
	},
	'beforeItem' : function(message) {/*向前插入一条消息*/
		if (!message) {
			return false;
		}
		if ($('#msg_list li:first').size()) {
			$('#msg_list li:first').before(this.buildItem(message));
		} else {
			$('#msg_list').append(this.buildItem(message));
		}
		var target = $('#msg_list li:first');
		if (!this.options.pause) {
			target.show().css('height', $(this).height()).animate({'duration' : 200, 'specialEasing' : {'width' : target.width()}});
		}
	},
	'prevPage' : function() {/*浏览上一页数据*/
		if (this.options.index >= messagehistory.length) {
			return false;
		}
		this.control('pause');
		if (this.status.prev) {
			this.options.index += 2;
			this.status.prev = false;
		} else {
			this.options.index += 1;
		}
		if ($('#msg_list .talkList').size() < this.options.index + 1) {
			for (i = this.options.index; i < this.options.index + this.options.pagesize; i++) {
				try {
					this.appendItem(messagehistory[i]);
				} catch (e) {
				}
			}
		}
		if (this.options.index >= 2){
			var position = $('#msg_list .talkList').eq(this.options.index).position();
			var top = 0;
			if (position) {
				top = $('#msg_list .talkList').eq(this.options.index).position().top + $('#msg_list .talkList').eq(this.options.index).outerHeight();
				if (this.options.wrapHeight - top > 0) {
					top = 0;
				} else {
					top = this.options.wrapHeight - top;
				}
			}
			if (top != 0) {
			///	$('#msg_list').css({'position' : 'absolute'}).animate({'top' : top});
			}
		}
	},
	'nextPage' : function() {
		if (this.options.index <= 0) {
			return false;
		}
		this.control('pause');
		this.options.index -= 1;
		if (!this.status.prev) {
			if ($('#msg_list .talkList').eq(this.options.index - 1).outerHeight() < this.options.wrapHeight) {
				this.options.index -= 2;
			} else {
				this.options.index -= 1;
			}
			this.status.prev = true;
			this.status.next = false;
		}
		if (this.options.index < 0) {
			this.options.index = 0;
		}
		if (this.options.index > 0) {
			var position = $('#msg_list .talkList').eq(this.options.index).position();
			var top = 0;
			if (position) {
				top = 0 - $('#msg_list .talkList').eq(this.options.index).position().top;
			}
			if (top != 0) {
			//	$('#msg_list').css({'position' : 'absolute'}).animate({'top' : top});
			}
		} else if (this.options.index == 0) {
			//$('#msg_list').css({'position' : 'absolute'}).animate({'top' : 0});
		}
	},
	'newItem' : function() {
		var $this = this;
		if (this.options.pause) {
			return false;
		}
		if ($('#msg_list .talkList:hidden').size() > 0) {
			try {
				var target = $('#msg_list .talkList:hidden:last');
				if (!this.options.pause && target[0]) {
					target.show({'duration' : 200, 'specialEasing' : {'width' : target.width()}});
				}
			} catch (e) {}
			$this.timer = setTimeout(function(){
				$this.newItem();
			}, $this.options.delaytime);
			$this.countdown($this.options.delaytime);
		} else {
			$.getJSON('{php echo create_url('index/module/incoming', array('name'=>'wxwall', 'id' => $wall['rid']))}', {'lastmsgtime' : $this.lastmsgtime, 'page' : $this.page, 'r' : (new Date()).valueOf()}, function(s){
				if (s && s['message']) {
					$this.page++;
				}
				try {
					$this.beforeItem(s['message']);
				} catch (e) {
				}
				$this.timer = setTimeout(function(){
					$this.newItem();
				}, $this.options.delaytime);
				$this.countdown($this.options.delaytime);
			});
			//获取新消息时，请求第三方墙数据
			if ($this.txwall.status){
				$.getJSON('{php echo create_url('index/module/incomingtxwall', array('name' => 'wxwall', 'id' => $wall['rid']))}', {'lastmsgtime' : $this.txwall.lastmsgtime, 'lastuser' : $this.txwall.lastuser, 'r' : (new Date()).valueOf()}, function(s){
					if (s['message']['status'] == '1') {
						$this.txwall.lastmsgtime = s['message']['lastmsgtime'];
						$this.txwall.lastuser = s['message']['lastuser'];
					}
				});
			}
		}
	},
	'control' : function(operation) {
		var $this = this;
		if (operation == 'pause') {
			this.options.pause = true;
			clearTimeout($this.timer);
			$('#status').html('开始');
			$('#status')[0].onclick = function(){
				$this.control('start');
			}
		} else if(operation == 'start') {
			this.options.pause = false;
			$('#status').html('暂停');
			$('#status')[0].onclick = function(){
				$this.control('pause');
			}
			this.options.index = 0;
			//$('#msg_list').css({'position' : 'absolute'}).animate({'top' : 0});
			clearTimeout($this.timer);
			$this.newItem();
		}
	},
	'countdown' : function(time) {
		var $this = this;
		if (time) {
			clearTimeout(this.timerdown);
			$('#remaintime').html(time / 1000);
		} else {
			time = parseInt($('#remaintime').html()) - 1;
			if (time < 0){
				time = 0;
			}
			$('#remaintime').html(time);
		}
		this.timerdown = setTimeout(function(){
			$this.countdown();
		}, 1000);
	},
	'removeHTMLTag' : function(str) {
		str = str.replace(/<\/?[^>]*>/g,'');
		str = str.replace(/[ | ]*\n/g,'\n');
		str = str.replace(/\n[\s| | ]*\r/g,'\n');
		str = str.replace(/&nbsp;/ig,'');
		return str;
	},
	'strlen' : function(str) {
		var n = 0;
		str = this.removeHTMLTag(str);
		for(i=0;i<str.length;i++){
			var leg=str.charCodeAt(i);
			/*if(leg>255){
				n+=2;
			}else {
				n+=1;
			}*/
			n+=1;
		}
		return n;
	},
	'changeSize' : function(a) {
		var $this = this;
		var str_len = parseInt($this.strlen(a));
		var font_size = 36;
		for (j=18;j>str_len;j--) {
			font_size += 4;
		}
		return font_size;
	}
};
$(function(){
	wxwall.init();

	//公众号切换
	var mTimer;
	function auto_play() {
		$(".msg_tit").toggle();
	}
	mTimer = setInterval(function(){auto_play()}, 5000);
});
</script>

</body>
</html>
