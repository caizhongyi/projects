{php $_W['breadcrumb'] = array(array('title'=>'营业厅数据'),array('title'=>'资源库'))}
{template 'common/header'}
{if $do=="display"}
    <style>
        .field label{float:left;margin:0 !important; width:140px; font-size: 12px;}
    </style>
    <div class="page-header">
        <h1>
            <i class="icon-book"></i> 资源库列表
        </h1>
    </div>

    <div>
        <ul class="nav nav-tabs">
            <li {if empty($_GPC['type']) || $_GPC['type'] == 1}class="active"{/if}><a href="{php echo $this->createWebUrl('display', array('foo' => 'display', 'type' => 1))}">政策文件</a></li>
            <li {if $_GPC['type'] == 2}class="active"{/if}><a href="{php echo $this->createWebUrl('display', array('foo' => 'display', 'type' => 2))}">普通发文</a></li>
        </ul>
    </div>

        <p></p>
    <p>
        {if $sj_account==1 && $type==1}
            <a class="btn btn-sm btn-primary" href="{php echo $this->createWebUrl('display', array('foo' => 'post'))}"><i class="icon-plus"></i>
            资源文件</a>
        {elseif  $sj_account==1 && $type == 2}
        <br/>
        {elseif $tj_account == 1}
        <br/>
        {else}
        <a class="btn btn-sm btn-primary" href="{php echo $this->createWebUrl('display', array('foo' => 'post', 'type' => $type))}"><i class="icon-plus"></i>
            资源文件</a>

        <a class="btn btn-sm btn-primary" href="{php echo $this->createWebUrl('category', array('foo' => 'display', 'type' => $type))}"><i class="icon-plus"></i>
            分类管理</a>
        {/if}
    </p>

    <form action="" method="post">
        <input type="hidden" name="act" value="module" />
        <input type="hidden" name="do" value="display" />
        <table class="table table-striped table-bordered table-hover">
            <tbody>
            <tr>
                <th>创建时间</th>
                <td>
                    <button class="form-control span3" id="date-range" type="button"><span class="date-title">{php echo date('Y-m-d', $starttime)} 至 {php echo date('Y-m-d', $endtime)}</span> <i class="icon-caret-down"></i></button>
                    <input name="start" type="hidden" value="{php echo date('Y-m-d', $starttime)}" />
                    <input name="end" type="hidden" value="{php echo date('Y-m-d', $endtime)}" />
                </td>
            </tr>

            <tr>
                <th>分类</th>
                <td>
                    <select class="span3" style="margin-right:15px;" name="cate_1">
                        <option value="0">请选择分类</option>
                        {loop $selct_cat_info $key $val}
                        <option value="{$key}" {if $key == $_GPC['cate_1']} selected="selected"{/if}>{$val}
                        </option>
                        {/loop}
                    </select>
                </td>
            </tr>

            {if  $jt_account == 1}
            <tr>
                <th>状态</th>
                <td>
                    <select class="span3" style="margin-right:15px;" name="cate_2">
                        <option value="-2">状态选择</option>
                        {loop $status_info $key $val}
                        <option value="{$val}" {if $val == $_GPC['cate_2']} selected="selected"{/if}>
                        {if $val == -1}
                        已删除
                        {else}
                        正常
                        {/if}
                        </option>
                        {/loop}
                    </select>
                </td>
            </tr>
            {/if}

            <tr>
                <th>关键字</th>
                <td>
                    <input class="span6" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
                </td>
            </tr>

            <tr class="search-submit">
                <td colspan="2"><button class="btn btn-sm btn-primary"><i class="icon-search"></i> 搜索</button></td>
            </tr>
            </tbody>
        </table>
    </form>
    <div class="">
        <form action="" method="post" onsubmit="">
            <div class="sub-content">
                <table class="table table-striped table-bordered table-hover">
                    <thead class="navbar-inner">
                    <tr>
                        <th style="">文件类别<i></i></th>
                        <th style="">标题<i></i></th>
                        <th style="">关键字<i></i></th>
                        <th style="">创建时间<i></i></th>
                        <th style="">状态<i></i></th>
                        <th style="">操作<i></i></th>
                    </tr>
                    </thead>
                    <tbody>
                    {loop $list $row}
                    <tr>
                        <td>
                            {if $row['cat_id'] == 0}
                                活动发文
                            {else}
                                {$category_info[$row['cat_id']]}
                            {/if}
                        </td>
                        <td>{$row['title']}</td>
                        <td>
                            <div>
                                <span class="label  label-success">{$row['keyword']}</span>
                            </div>
                        </td>
                        <td>
                           {php echo date("Y-m-d H:s:i",$row['createtime']);}
                        </td>

                        <td class="action-buttons"  style="color: #428BCA;">
                            {if $row['lib_status']==-1}
                                已删除
                            {php /*}
                            {elseif  $row['lib_status']==1}
                               {if $libry_log[$row['id']] == 1 || $bing_info[$row['id']]==1}
                                    {if $row['lib_status']!=0}
                                    <a  href="javascript:void(0)" onclick="changeStatus({$row['id']}, {$row['lib_status']})"><i class="icon-edit"></i> 更新</a>
                                    {/if}
                                {else}
                                    更新
                                {/if}
                            {php */}
                            {else}
                                正常
                            {/if}
                        </td>
                        <td  class="action-buttons">
                            {if $group_id != $row['uid'] && $row['lib_status']!=-1}
                                <a href="{php echo $this->createWebUrl('display', array('foo' => 'post', 'id' => $row['id'], 'b_falg' => 1, 'type' => $type))}"><i class="icon-edit"></i> 编辑</a>
                            <a href="{php echo $this->createWebUrl('statistical', array( 'id' => $row['id'], 'title' => $row['title']))}"><i class="icon-check"></i> 查看</a>
                                <a onclick="return confirm('删除库文件，确认吗？');return false;" href="{php echo $this->createWebUrl('display', array('foo' => 'delete', 'id' => $row['id']))}"><i class="icon-remove-sign"></i> 删除</a>
                            {elseif $group_id == $row['uid']}

                                {if $tj_account ==1 && $type==1}
                                    {if $libry_log[$row['id']]==1}
                                    <a href="{php echo $this->createWebUrl('show', array('id' => $row['id']))}" target="_blank"><i class="icon-edit"></i> 查看</a>
                                    {/if}
                                    <label ><p style="color: #428BCA;"><input type="checkbox" name="check_btn" onclick="select_val(this)" value="{$row['id']}"  {if $libry_log[$row['id']] == 1 || $bing_info[$row['id']]==1} checked {/if}/> 查阅</p></label>
                                {elseif $tj_account ==1 && $type==2}
                                    {if !empty($rule_info[$row['id']])}
                                    <a href="{php echo create_url('rule', array('act' => 'post' , 'id' => $rule_info[$row['id']], 'type' => $type))}"><i class="icon-edit"></i> 编辑</a>
                                    {/if}
                                    <label ><p style="color: #428BCA;"><input type="checkbox" name="check_btn" onclick="showValue(this)" value="{$row['id']}"  {if $libry_log[$row['id']] == 1 || $bing_info[$row['id']]==1} checked {/if}/> 接受绑定</p></label>
                                {/if}
                            {/if}
                        </td>
                    </tr>
                    {/loop}
                    </tbody>
                </table>
            </div>
        </form>
        {$pager}
    </div>
    </div>
    <link type="text/css" rel="stylesheet" href="./resource/ace/assets/css/daterangepicker.css" />
    <script type="text/javascript" src="./resource/script/daterangepicker.js"></script>
    <script>
        $(function() {
            $('#date-range').daterangepicker({
                format: 'YYYY-MM-DD',
                startDate: $(':hidden[name=start]').val(),
                endDate: $(':hidden[name=end]').val(),
                locale: {
                    applyLabel: '确定',
                    cancelLabel: '取消',
                    fromLabel: '从',
                    toLabel: '至',
                    weekLabel: '周',
                    customRangeLabel: '日期范围',
                    daysOfWeek: moment()._lang._weekdaysMin.slice(),
                    monthNames: moment()._lang._monthsShort.slice(),
                    firstDay: 0
                }
            }, function(start, end){
                $('#date-range .date-title').html(start.format('YYYY-MM-DD') + ' 至 ' + end.format('YYYY-MM-DD'));
                $(':hidden[name=start]').val(start.format('YYYY-MM-DD'));
                $(':hidden[name=end]').val(end.format('YYYY-MM-DD'));
            });
        });
    </script>

    <script>
             function showValue(object){
                 var id = object.value;
                 var urls =  "{php echo $this->createWebUrl('addRule')}";

                 if(object.checked){
                     $.post(urls, {flag:1,item_id:id}, function( data ){
                         alert("接受库文件成功");
                         window.location.reload();
                     });
                 }else{
                     if (confirm("解除库文件的同时会禁用规则，是否要解除？")){
                         $.post(urls, {flag:0, item_id:id}, function( data ){
                             alert("解除库文件成功");
                             window.location.reload();
                         });
                     }else{
                         object.checked=true;
                     }
                 }
             }

        function select_val(object){
            var id = object.value;
            var urls =  "{php echo $this->createWebUrl('insertLog')}";

            if(object.checked){
                $.post(urls, {flag:1,item_id:id}, function( data ){
                    alert("接收政策文件成功");
                    window.location.reload();
                });
            }else{
                if (confirm("解除政策文件的同时会删除绑定记录，是否要解除？")){
                    $.post(urls, {flag:0, item_id:id}, function( data ){
                        alert("解除政策文件成功");
                        window.location.reload();
                    });
                }else{
                    object.checked=true;
                }
            }
        }

    </script>

    <script>
        function changeStatus(id, status){
            var urls =  "{php echo $this->createWebUrl('addRule')}";
            if(status==1){
                $.post(urls, {flag:1,item_id:id}, function( data ){
                    alert("更新库文件成功");
                });
            }else if(status==-1){
                if (confirm("在删除状态下更新库文件会禁用规则，是否要更新？")){
                    $.post(urls, {flag:0, item_id:id}, function( data ){
                        alert("更新库文件成功");
                    });
                }else{

                }
            }
        }

    </script>
{elseif $do=="post"}
<div class="page-header">
    <h1>
        <i class="icon-book"></i> 添加文件
    </h1>
</div>
<div class="main">
    <form class="form-horizontal form" action="" method="post" enctype="multipart/form-data" onsubmit="return formcheck(this)">
        <input type="hidden" name="id" value="{$item[id]}">
        <table class="tb">
            <tr>
                <th><label for="">发文分类</label></th>
                <td>
                    <select class="span3" style="margin-right:15px;" name="cate_1">
                        <option value="0">请选择分类</option>
                        {loop $category_info $key $val}
                        <option value="{$key}" {if $key == $item['cat_id']} selected="selected"{/if}>{$val}</option>
                        {/loop}
                    </select>
                </td>
            </tr>
            <tr>
                <th><label for="">标题</label></th>
                <td>
                    <input type="text" class="span6" placeholder="" name="title" value="{$item['title']}">
                </td>
            </tr>
            <tr>
                <th><label for="">关键字</label></th>
                <td>
                    <input type="text" class="span6" placeholder="" name="keyword" value="{$item['keyword']}">
                </td>
            </tr>
            <tr>
                <th><label for="">缩略图</label></th>
                <td>
                    <div class="fileupload {if $item['thumb']}fileupload-exists{else}fileupload-new{/if}" data-provides="fileupload">
                        <div class="fileupload-preview thumbnail" style="width: 200px; height: 150px;">{if $item['thumb']}<img src="{$_W['attachurl']}{$item['thumb']}" width="200" />{/if}</div>
                        {if $sj_account==1 || $jt_account==1}
                        <div>
                            <span class="btn btn-file btn-primary"><span class="fileupload-new">选择图片</span><span class="fileupload-exists">更改</span><input name="thumb" type="file" /></span>
                            <a href="#" class="btn fileupload-exists btn-danger" data-dismiss="fileupload">移除</a>
                            {if $item['thumb']}<button type="submit" name="fileupload-delete" value="{$item['thumb']}" class="btn fileupload-new btn-danger">删除</button>{/if}
                        </div>
                        {/if}
                    </div>
                    <span class="help-block"></span>
                </td>
            </tr>
            <tr>
                <th><label for="">简介</label></th>
                <td>
                    <!--<input type="text" class="span6" placeholder="" name="description" value="{$item['description']}">-->
                    <textarea name="description" id=""  cols="70" style="height:80px;">{$item['description']}</textarea>
                </td>
            </tr>

            <tr>
                <th>内容</th>
                <td>
                    <textarea style="height:400px; width:85%;" class="span7 richtext-clone" name="content" cols="70" id="reply-add-text">{$item['content']}</textarea>
                </td>
            </tr>
        </table>

        <table class="tb">
            <tr>
                <th></th>
                <td>
                    {if $sj_account==1 && $type==1}
                    <button type="submit" class="btn btn-primary span3" name="submit" value="提交">提交</button>
                    <input type="hidden" name="token" value="{$_W['token']}" />
                    {elseif  $sj_account==1 && $type == 2}
                    <a class="btn btn-primary span3" href="{php echo $this->createWebUrl('display', array('foo' => 'display', 'type' => 2))}">返回</a>
                    {elseif $tj_account == 1}
                    <a class="btn btn-primary span3" href="{php echo $this->createWebUrl('display', array('foo' => 'display', 'type' => 2))}">返回</a>
                    {else}
                    <button type="submit" class="btn btn-primary span3" name="submit" value="提交">提交</button>
                    <input type="hidden" name="token" value="{$_W['token']}" />

                    {/if}

                </td>
            </tr>
        </table>
    </form>
</div>
<script type="text/javascript">
    <!--
    kindeditor($('.richtext-clone'));
    //-->
</script>
{/if}
{template 'common/footer'}