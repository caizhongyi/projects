<?php
/**
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');
include model('rule');

$modules = array();
foreach ( $_W['account']['modules'] as $k => $v ) {
	if (is_array($_W['modules']) && $_W['modules'][$v['name']]['isrulefields']) {
		$modules[$k] = $_W['modules'][$v['name']];
	}
}
//是否为微活动入口
$is_activity = (isset($_GET['activity'])&&!empty($_GET['activity'])) ? true : false;
if($is_activity){
    $activity_module = cache_load('modules');
    if(!empty($_GPC['module'])&&!empty($activity_module[$_GPC['module']])){
        $activity_title = $activity_module[$_GPC['module']]['title'];
        $activity_name = $activity_module[$_GPC['module']]['name'];
        $activity_description = $activity_module[$_GPC['module']]['description'];
    }else{
        $is_activity = false;
    }
}
if (checksubmit('submit')) {
	$modulename = '';
	foreach ( $modules as $module ) {
		if ($module['name'] == $_GPC['module']) {
			$modulename = $_GPC['module'];
			break;
		}
	}
	if (empty($modulename)) {
		message('您未启用、安装该模块或是您没有权限使用！', '', 'error');
	}
	
	$rid = intval($_GPC['id']);
	if (empty($_GPC['name'])) {
		message('抱歉，规则名称为必填项，请选回修改！');
	}
	$cid = $_GPC['cate_2'] ? $_GPC['cate_2'] : $_GPC['cate_1'];
	$rule = array(
		'weid' => $_W['weid'], 
		'cid' => '', 
		'name' => $_GPC['name'], 
		'module' => $modulename, 
		'status' => intval($_GPC['status'])
	);
	
	/* 如果添加的规则类型属于活动，则type设置为1 */
	if ($is_activity) {
		$rule['type'] = 1;
	}
	
	if (! empty($_GPC['istop'])) {
		$rule['displayorder'] = 255;
	} else {
		$rule['displayorder'] = intval($_GPC['displayorder']) > 254 ? 254 : intval($_GPC['displayorder']);
	}
	//调用模块处理
	$module = module($modulename);
	if (is_error($module)) {
		message('抱歉，模块不存在请重新其它模块！');
	}
	$msg = $module->fieldsFormValidate();
	if (is_string($msg) && trim($msg) != '') {
		message($msg);
	}
	if (! empty($rid)) {
		$isexists = pdo_fetch("SELECT id, module FROM " . tablename('rule') . " WHERE id = :id", array(
			':id' => $rid
		));
		if (empty($isexists)) {
			message('抱歉，要修改的规则不存在或是已经被删除！');
		}
		$rule['module'] = $isexists['module'];
		$result = pdo_update('rule', $rule, array(
			'id' => $rid
		));
	} else {
		$result = pdo_insert('rule', $rule);
		$rid = pdo_insertid();
		
		//设置权限 -- 添加规则时就赋予
		if($_GPC['module'] == 'userapi'){
			$cond = array(
					'weid' => $_W['weid'],
					'mid' => $_W['modules'][$_GPC['module']]['mid']
			);
			$_rs = pdo_fetch("select * from ims_wechats_modules where weid = :weid and mid = :mid", $cond);
			if(!empty($_rs)){
				$cfg = unserialize($_rs['settings']);
				$cfg[$rid] = true;
				pdo_update('wechats_modules', array('settings'=>serialize($cfg)), $cond);
			}else{
				$cfg[$rid] = true;
				$_data = array(
						'weid' => $_W['weid'],
						'mid' => $_W['modules'][$_GPC['module']]['mid'],
						'displayorder' => 127,
						'enabled' => 1,
						'settings' => serialize($cfg)
				);
				pdo_insert('wechats_modules', $_data);
			}
		}
	}
	
	//添加会员验证信息
	$items = $_GPC['items'] ? trim($_GPC['items'], ',') : '';
	$itemarr = explode(',', $items);
	$now = time();
	$where = array(
		'weid' => $_W['weid'], 
		'ruleid' => $rid
	);
	pdo_delete('fans_config', $where);
	
	foreach ( $itemarr as $item ) {
		$col = explode(':', $item);
		$data = array(
			'weid' => $_W['weid'], 
			'ruleid' => $rid, 
			'colid' => $col[0], 
			'isnecessary' => $col[1], 
			'create_time' => $now
		);
		pdo_insert('fans_config', $data);
	}
	
	if (! empty($rid)) {
		//更新，添加，删除关键字
		if (! empty($_GPC['keyword-name'])) {
			foreach ( $_GPC['keyword-name'] as $id => $row ) {
				if (empty($row) && strlen($row) == 0 && intval($_GPC['keyword-type'][$id]) != 4) {
					continue;
				}
				$data = array(
					'content' => $row, 
					'type' => intval($_GPC['keyword-type'][$id]), 
					'rid' => $rid, 
					'id' => $id, 
					'weid' => $_W['weid'], 
					'module' => $rule['module'], 
					'status' => $rule['status'], 
					'displayorder' => $rule['displayorder']
				);
				rule_insert_keyword($data);
			}
		}
		if (! empty($_GPC['keyword-name-new'])) {
			foreach ( $_GPC['keyword-name-new'] as $id => $row ) {
				if (empty($row) && strlen($row) == 0 && intval($_GPC['keyword-type-new'][$id]) != 4) {
					continue;
				}
				$data = array(
					'content' => $row, 
					'type' => intval($_GPC['keyword-type-new'][$id]), 
					'rid' => $rid, 
					'weid' => $_W['weid'], 
					'module' => $rule['module'], 
					'status' => $rule['status'], 
					'displayorder' => $rule['displayorder']
				);
				rule_insert_keyword($data);
			}
		}
		
		//更新置顶关键字缓存
		cache_write("keywordtop:{$_W['weid']}", pdo_fetchall("SELECT content, type, rid, module FROM " . tablename('rule_keyword') . " WHERE status = 1 AND displayorder = '255' ORDER BY type ASC, id ASC"));
		$module->fieldsFormSubmit($rid);
		if ($_GPC['action'] == 'guide') {
			message('规则操作成功！', create_url('index/frame'));
		}
		message('规则操作成功！', 'rule.php?act=post&id=' . $rid);
	} else {
		message('规则操作失败, 请联系网站管理员！');
	}
}
$types = array(
	1 => array(
		'name' => '完全相等', 
		'description' => '用户进行交谈时，对话内容完全等于上述关键字才会执行这条规则。'
	), 
	2 => array(
		'name' => '包含关键字', 
		'description' => '用户进行交谈时，对话中包含上述关键字就执行这条规则。'
	), 
	3 => array(
		'name' => '正则表达式匹配', 
		'description' => "用户进行交谈时，对话内容符合述关键字中定义的模式才会执行这条规则。<br/><strong>注意：如果你不明白正则表达式的工作方式，请不要使用正则匹配</strong> <br/><strong>注意：正则匹配使用MySQL的匹配引擎，请使用MySQL的正则语法</strong> <br /><br /><strong>示例: </strong><br/><b>^微擎</b>匹配以“微擎”开头的语句<br /><b>微擎$</b>匹配以“微擎”结尾的语句<br /><b>^微擎$</b>匹配等同“微擎”的语句<br /><b>微擎</b>匹配包含“微擎”的语句<br /><b>[0-9\.\-]</b>匹配所有的数字，句号和减号<br /><b>^[a-zA-Z_]$</b>所有的字母和下划线<br /><b>^[[:alpha:]]{3}$</b>所有的3个字母的单词<br /><b>^a{4}$</b>aaaa<br /><b>^a{2,4}$</b>aa，aaa或aaaa<br /><b>^a{2,}$</b>匹配多于两个a的字符串"
	), 
	4 => array(
		'name' => '直接接管', 
		'description' => "如果没有比这条回复优先级更高的回复被触发，那么直接使用这条回复。<br/><strong>注意：如果你不明白这个机制的工作方式，请不要使用直接接管</strong>"
	)
);
$defaultmodule = ! empty($_GPC['module']) ? $_GPC['module'] : 'basic';
$m = $_W['modules'][$defaultmodule];
if ($m['isrulesingle']) {
	$sql = 'SELECT `id` FROM ' . tablename('rule') . ' WHERE `weid`=:weid AND `module`=:module';
	$pars = array();
	$pars[':weid'] = $_W['weid'];
	$pars[':module'] = $defaultmodule;
	$r = pdo_fetch($sql, $pars);
	if ($r) {
		message('这个模块属于单规则模块, 规则已经存在！', create_url('rule/post', array(
			'id' => $r['id']
		)), 'error');
	}
}

$typeslabel = "'" . implode("','", $types) . "'";
$rid = intval($_GPC['id']);
if (! empty($rid)) {
	$rule = rule_single($rid);
	if (empty($rule['rule'])) {
		message('抱歉，您操作的规则不在存或是已经被删除！', create_url('rule/display'), 'error');
	}
	$module = $rule['rule']['module'];
	$module = module($module);
	$rule['reply'] = $module;
}
$category = cache_load('category:' . $_W['weid']);
if (! empty($category)) {
	$children = '';
	foreach ( $category as $cid => $cate ) {
		if (! empty($cate['parentid'])) {
			$children[$cate['parentid']][] = array(
				$cate['id'], 
				$cate['name']
			);
		}
	}
}
/**
 * 会员绑定信息设置
 * */
$sql = "select COLUMN_NAME  from `information_schema`.`COLUMNS` where `TABLE_SCHEMA`='we7'  and  `TABLE_NAME`='ims_fans' ";
$result = pdo_fetchall($sql);
foreach ( $result as $rs ) {
	$cols[] = $rs['COLUMN_NAME'];
}

$_sql = "select * from ims_fans_col_config";
$_result = pdo_fetchall($_sql);
foreach ( $_result as $_rs ) {
	$colnames[$_rs['id']] = $_rs['colname'];
}

$sql1 = "select * from ims_fans_config as a, ims_fans_col_config as b where a.weid = " . $_W['weid'] . " and a.ruleid = " . $rid . " and a.colid = b.id";
$result1 = pdo_fetchall($sql1);
if (! empty($result1)) {
	foreach ( $result1 as $rs1 ) {
		$colarr[$rs1['id']] = $rs1;
	}
}

template('rule/post');
