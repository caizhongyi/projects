<?php
/**
 * 图文回复模块
 * 
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');

class NewsModule extends WeModule {
	public $tablename = 'news_reply';
	
	public function fieldsFormDisplay($rid = 0) {
		global $_W;
		$result = pdo_fetchall("SELECT * FROM ".tablename($this->tablename)." WHERE rid = :rid ORDER BY `parentid` ASC, `id` ASC", array(':rid' => $rid));	
		$result = istripslashes($result);
		$reply = array();
		if (!empty($result)) {
			foreach ($result as $index => $row) {
				if (empty($row['parentid'])) {
					$reply[$row['id']] = $row;
				} else {
					$reply[$row['parentid']]['children'][] = $row;
				}
			}
		}
		include $this->template('display');
	}
	
	public function fieldsFormValidate($rid = 0) {
		return true;	
	}
	
	public function fieldsFormSubmit($rid = 0) {
		global $_GPC, $_W;
		if (!empty($_GPC['news-title'])) {
			foreach ($_GPC['news-title'] as $groupid => $items) {
				if (empty($items)) {
					continue;
				}
				foreach ($items as $itemid => $row) {
					if (empty($row)) {
						continue;
					}
					$update = array(
						'title' => $_GPC['news-title'][$groupid][$itemid],
						'description' => $_GPC['news-description'][$groupid][$itemid],
						'thumb' => $_GPC['news-picture-old'][$groupid][$itemid],
						'content' => $_GPC['news-content'][$groupid][$itemid],
						'url' => $_GPC['news-url'][$groupid][$itemid],
                        'createtime'=>time(),
                        'islocation'=>$_GPC['news-islocation'][$groupid][$itemid],

					);
					if (!empty($_GPC['news-picture'][$groupid][$itemid])) {
						$update['thumb'] = $_GPC['news-picture'][$groupid][$itemid];
						file_delete($_GPC['news-picture-old'][$groupid][$itemid]);
					}
					pdo_update($this->tablename, $update, array('id' => $itemid));
					//处理新增子项
					if (!empty($_GPC['news-title-new'][$groupid])) {
						foreach ($_GPC['news-title-new'][$groupid] as $index => $title) {
							if (empty($title)) {
								continue;
							}
							unset($_GPC['news-title-new'][$groupid]);
							$insert = array(
								'rid' => $rid,
								'parentid' => $itemid,
								'title' => $title,
								'description' => $_GPC['news-description-new'][$groupid][$index],
								'thumb' => $_GPC['news-picture-new'][$groupid][$index],
								'content' => $_GPC['news-content-new'][$groupid][$index],
								'url' => $_GPC['news-url-new'][$groupid][$index],
                               'createtime'=>time(),
                               'islocation'=>$_GPC['news-islocation-new'][$groupid][$index],
							);
							pdo_insert($this->tablename, $insert);
						}
					}
				}
			}
		}
		//处理添加
		if (!empty($_GPC['news-title-new'])) {
			foreach ($_GPC['news-title-new'] as $itemid => $titles) {
				if (!empty($titles)) {
					$parentid = 0;
					foreach ($titles as $index => $title) {
						if (empty($title)) {
							continue;
						}
						$insert = array(
							'rid' => $rid,
							'parentid' => $parentid,
							'title' => $title,
							'description' => $_GPC['news-description-new'][$itemid][$index],
							'thumb' => $_GPC['news-picture-new'][$itemid][$index],
							'content' => $_GPC['news-content-new'][$itemid][$index],
							'url' => $_GPC['news-url-new'][$itemid][$index],
                           'createtime'=>time(),
                           'islocation'=>$_GPC['news-islocation-new'][$itemid][$index],
						);
						pdo_insert($this->tablename, $insert);
						if (empty($parentid)) {
							$parentid = pdo_insertid();
						}
					}
				}
			}
		}
		return true;	
	}
	
	public function ruleDeleted($rid = 0) {
		global $_W;
		$replies = pdo_fetchall("SELECT id, thumb FROM ".tablename($this->tablename)." WHERE rid = '$rid'");
		$deleteid = array();
		if (!empty($replies)) {
			foreach ($replies as $index => $row) {
				file_delete($row['thumb']);
				$deleteid[] = $row['id'];		
			}
		}
		pdo_delete($this->tablename, "id IN ('".implode("','", $deleteid)."')");  
		return true;
	}
	
	public function doFormDisplay() {
		global $_W, $_GPC;
		$result = array('error' => 0, 'message' => '', 'content' => '');
		$result['content']['id'] = $GLOBALS['id'] = 'add-row-news-'.$_W['timestamp'];
		$result['content']['html'] = template('modules/news/'.$_GPC['tpl'].'_form_display', TEMPLATE_FETCH);
		exit(json_encode($result));
	}

	public function doDetail() {
		global $_W, $_GPC;
		$id = intval($_GPC['id']);
        $we_name = $_GPC['we_name'];
		$sql = "SELECT * FROM " . tablename($this->tablename) . " WHERE `id`=:id";
		$row = pdo_fetch($sql, array(':id'=>$id));
        $sql = "SELECT * FROM " . tablename('rule') . " WHERE `id`=:id";
        $rule = pdo_fetch($sql, array(':id'=>$row['rid']));
        $weid = $rule['weid'];
		if (!empty($row['url'])) {
            //图文源链接bug修复by hongmingjie 13/11/06
            if(empty($row['islocation'])){
                header("Location: ".$row['url']);
            }
		}
		$row = istripslashes($row);
		$row['thumb'] = $_W['attachurl'] . trim($row['thumb'], '/');
		include $this->template('news');
	}
	
	public function doDelete() {
		global $_W,$_GPC;
		$id = intval($_GPC['id']);
		$sql = "SELECT id, parentid, rid, thumb FROM " . tablename($this->tablename) . " WHERE `id`=:id";
		$row = pdo_fetch($sql, array(':id'=>$id));
		if (empty($row)) {
			message('抱歉，回复不存在或是已经被删除！', '', 'error');
		}
		if (pdo_delete($this->tablename, array('id' => $id))) {
			file_delete($row['thumb']);
            //如果删除首条的话接下来的那条图文变头。
			if ($row['parentid'] == 0) {
				$list = pdo_fetchall("SELECT * FROM " . tablename($this->tablename) . " WHERE `parentid`=:parentid ORDER BY id asc", array(':parentid' => $row['id']));
                if(!empty($list)){
                    pdo_update($this->tablename,array('parentid'=>0),array('id' => $list['0']['id']));
                    $sql = "UPDATE ".tablename($this->tablename)." SET parentid = ". $list['0']['id'].' where parentid ='.$row['id'];
                    pdo_query($sql);
                }
			}
		}
		message('删除回复成功', '', 'success');
	}
	
	public function doDeleteImage() {
		global $_GPC;
		$id = intval($_GPC['id']);
		$sql = "SELECT id, thumb FROM " . tablename($this->tablename) . " WHERE `id`=:id";
		$row = pdo_fetch($sql, array(':id'=>$id));
		if (empty($row)) {
			message('抱歉，回复不存在或是已经被删除！', '', 'error');
		}
		if (pdo_update($this->tablename, array('thumb' => ''), array('id' => $id))) {
			file_delete($row['thumb']);
		}
		message('删除图片成功！', '', 'success');
	}
	

}
