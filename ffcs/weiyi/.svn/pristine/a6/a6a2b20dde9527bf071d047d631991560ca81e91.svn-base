{php $load_js=array('bootstrap.fileupload')}
{php $_W['breadcrumb'] = array(array('title'=>'微站功能 '),array('title'=>'相册管理'))}
{template 'common/header'}

<div class="page-header">
    <h1>
        <i class="icon-camera"></i>
        {if $action == 'album' && $do == 'display'}相册管理{/if}
        {if $action == 'album' && $do == 'create' && !$id}添加相册{/if}
        {if $action == 'album' && $do == 'photo'}添加照片{/if}
        {if $action == 'album' && $do == 'create' && $id}修改相册{/if}
    </h1>
</div>
{if $action == 'album' && $do == 'display'}
<p>
    <a class="btn btn-sm btn-primary" href="{php echo create_url('site/album/create');}"><i class="icon-pencil"></i>添加相册</a>
</p>
{/if}

<style>
.album_list{overflow:hidden; padding-top:15px;}
.album_list li{border:1px #DDD solid; width:237px; float:left; margin-right:15px; margin-bottom:10px;}
.album_list li .album_pic{display:block; width:237px; height:130px; overflow:hidden;}
.album_list li .album_pic img{width:237px;}
.album_list li .album_main{padding:10px; overflow:hidden;}
.album_list li .album_main .album_title{font-size:16px; height:20px; width:217px; overflow:hidden;}
.album_list li .album_main .pull-left{color:#999;}
.album_manage .table th{width:120px;}
.album_manage #albums_head img{margin-right:10px; max-height:70px;}
</style>
{if $do == 'create'}
<div class="main">
	<form class="form-horizontal form" action="" method="post" enctype="multipart/form-data" onsubmit="return formcheck(this)">
		<input type="hidden" name="id" value="{$albumitem[id]}">
		<!--<h4>相册管理</h4>-->
		<table class="tb">
			{if !empty($albumitem)}
			<tr>
				<th><label for="">访问地址</label></th>
				<td>
					<a href="{php echo create_url('mobile/channel', array('weid' => $_W['weid'], 'id' => $albumitem['id'], 'name' => 'photo'))}" target="_blank">{php echo create_url('mobile/channel', array('weid' => $_W['weid'], 'id' => $albumitem['id'], 'name' => 'photo'))}</a>
					<span class="help-block">您可以根据此地址，添加回复规则，设置访问。</span>
				</td>
			</tr>
			{/if}
			<tr>
				<th><label for="">排序</label></th>
				<td>
					<input type="text" id="rule-name" class="span2" placeholder="" name="displayorder" value="{$albumitem['displayorder']}">
					<span class="help-block">相册优先级，越大则越靠前</span>
				</td>
			</tr>
			<tr>
				<th><label for="">名称</label></th>
				<td>
					<input type="text" class="span6" placeholder="" name="title" value="{$albumitem['title']}">
				</td>
			</tr>
			<tr>
				<th><label for="">封面</label></th>
				<td>
					<div class="fileupload fileupload-new" data-provides="fileupload">
						<div class="fileupload-preview thumbnail" style="width: 200px; height: 150px;">{if $albumitem['thumb']}<img src="{$_W['attachurl']}{$albumitem['thumb']}" width="200" />{/if}</div>
						<div>
							<span class="btn btn-sm btn-primary btn-file"><span class="fileupload-new">选择图片</span><span class="fileupload-exists">更改</span><input name="thumb" type="file" /></span>
							<a href="#" class="btn btn-sm fileupload-exists" data-dismiss="fileupload">移除</a>
							{if $albumitem['thumb']}<button type="submit" name="fileupload-delete" value="{$albumitem['thumb']}" class="btn fileupload-new">删除</button>{/if}
						</div>
					</div>
					<span class="help-block"></span>
				</td>
			</tr>
			<tr>
				<th>简介</th>
				<td>
					<textarea style="height:200px;" class="span7 richtext-clone" name="content" cols="70" id="reply-add-text">{$albumitem['content']}</textarea>
				</td>
			</tr>
			<tr>
				<th><label for="">前台是否显示</label></th>
				<td>
					<label for="radio_1" class="radio inline"><input type="radio" name="isview" id="radio_1" value="1" {if empty($albumitem) || $albumitem['isview'] == 1} checked{/if} /> 显示</label>
					<label for="radio_0" class="radio inline"><input type="radio" name="isview" id="radio_0" value="0" {if !empty($albumitem) && $albumitem['isview'] == 0} checked{/if} /> 隐藏</label>
					<span class="help-block">设置隐藏后，此相册只可以通过关键字触发</span>
				</td>
			</tr>
			<tr>
				<th></th>
				<td>
					<button type="submit" class="btn btn-sm btn-primary" name="submit" value="提交">提交</button>
					<input type="hidden" name="token" value="{$_W['token']}" />
				</td>
			</tr>
		</table>
	</form>
</div>
{elseif $do == 'display'}
<ul class="list-unstyled album_list">
	{loop $list $item}
	<li>
		<a href="{php echo create_url('site/album/photo', array('albumid' => $item['id']))}" class="album_pic"><img src="{$_W['attachurl']}{$item[thumb]}" /></a>
		<div class="album_main">
			<p class="album_title">{$item['title']}</p>
			<p>
				<span class="pull-right"><a href="{php echo create_url('site/album/photo', array('albumid' => $item['id']))}">上传照片</a> <a href="{php echo create_url('site/album/create', array('id' => $item['id']))}">编辑</a> <a href="{php echo create_url('site/album/delete', array('id' => $item['id'], 'type' => 'album'))}" onclick="return confirm('此操作不可恢复，确定删除码？'); return false;">删除</a></span>
				<span class="pull-left">有{$item['total']}张照片</span>
			</p>
		</div>
	</li>
	{/loop}
</ul>
{elseif $do == 'photo'}
<link type="text/css" rel="stylesheet" href="./resource/script/kindeditor/themes/default/default.css" />
<script type="text/javascript" src="./resource/script/kindeditor/kindeditor-min.js"></script>
<script type="text/javascript" src="./resource/script/kindeditor/lang/zh_CN.js"></script>
<script type="text/javascript">
	$(function(){
		var editor = KindEditor.editor({
			allowFileManager : true,
			uploadJson : './index.php?act=attachment&do=upload'
		});
		var i = 0;
		$('#selectimage').click(function() {
			editor.loadPlugin('multiimage', function() {
				editor.plugin.multiImageDialog({
					clickFn : function(list) {
						if (list && list.length > 0) {
							for (i in list) {
								if (list[i]) {
									html = '<div class="alert alert-block alert-new">' +
											'<input type="hidden" name="attachment-new[]" value="'+list[i]['filename']+'" />'+
											'<span class="pull-right"><a href="javascript:;" onclick="var $this = this;if (confirm(\'删除操作不可恢复，确定码？\')){ajaxopen(\'site.php?act=album&do=delete&type=photo&attachment='+list[i]['filename']+'\', function(s) {$($this).parent().parent().remove();})}; return false;">删除</a></span>' +
											'<div class="photo_preview pull-left"><label class="radio inline"><img src="'+list[i]['url']+'"><div><a href="javascript:;" onclick="ajaxopen(\'site.php?act=album&do=cover&albumid={$album['id']}&thumb='+list[i]['filename']+'\', function(msg){ message(msg)})">设为封面</a></div></label></div>' +
											'<table class="pull-left">' +
											'<tr><th>排序</th><td><input type="text" name="displayorder-new[]" value="" class="span1"></td></tr>' +
											'<tr><th>标题</th><td><input type="text" name="title-new[]" value="" class="span5"></td></tr>' +
											'<tr><th>简介</th><td><textarea name="description-new[]" class="span5"></textarea></td></tr>' +
											'</table></div>';
									$('#listimage').append(html);
									i++;
								}
							}
							editor.hideDialog();
						} else {
							alert('请先选择要上传的图片！');
						}
					}
				});
			});
		});
	});
</script>
<style>
.photo_list{padding:15px 0;}
.photo_list .alert{width:auto; margin-top:10px; overflow:hidden;}
.photo_list .photo_preview{width:130px;}
.photo_list .photo_preview img{width:130px; margin-bottom:5px;}
.photo_list .photo_preview label{padding:0;}
.photo_list .photo_preview input[type="radio"]{margin-left:0; margin-right:10px;}
.photo_list table{margin-left:40px;}
.photo_list table th,.photo_list table td{padding-bottom:5px;}
.photo_list table th{width:60px; font-size:14px;}
.photo_list table input{margin-bottom:0;}
</style>
<div class="main">
	<div class="photo_list">
	<form method="post" class="form">
	<input name="token" type="hidden" value="{$_W['token']}" />
	<input name="albumid" type="hidden" value="{$album['id']}" />
	<span id="selectimage" class="btn btn-sm btn-primary"><i class="icon-plus"></i> 上传照片</span>
	<input type="submit" name="submit" id="selectimage" class="btn btn-sm btn-primary" value="保存" /> <span style="color:red;">上传照片后，请保存照片数据！</span>
	<div style="padding:10px 0;">相册访问地址：<a target="_blank" href="{php echo create_url('mobile/channel', array('weid' => $_W['weid'], 'id' => $album['id'], 'name' => 'photo'))}">{php echo create_url('mobile/channel', array('weid' => $_W['weid'], 'id' => $album['id'], 'name' => 'photo'))}</a></div>
	<div id="listimage"></div>
	{loop $photos $item}
	<div class="alert alert-block alert-new">
		<input type="hidden" value="{$item['attachment']}" name="attachment[{$item['id']}]">
		<span class="pull-right"><a class="delete" onclick="return confirm('删除操作不可恢复，确定码？'); return false;" href="{php echo create_url('site/album/delete', array('type' => 'photo', 'id' => $item['id']))}">删除</a></span>
		<div class="photo_preview pull-left">
			<label class="radio inline">
				<img src="{$_W['attachurl']}{$item['attachment']}">
				<div><a href="javascript:;" onclick="ajaxopen('{php echo create_url('site/album/cover', array('albumid' => $album['id'], 'thumb' => $item['attachment']))}', function(msg){ message(msg)})">设为封面</a></div>
			</label>
		</div>
		<table class="pull-left">
			<tr>
				<th>排序</th>
				<td><input type="text" class="span1" value="{$item['displayorder']}" name="displayorder[{$item['id']}]"></td>
			</tr>
			<tr>
				<th>标题</th>
				<td><input type="text" class="span5" value="{$item['title']}" name="title[{$item['id']}]"></td>
			</tr>
			<tr>
				<th>简介</th>
				<td><textarea class="span5" name="description[{$item['id']}]">{$item['description']}</textarea></td>
			</tr>
		</table>
	</div>
	{/loop}
	</form>
	</div>
</div>
{/if}
{template 'common/footer'}