<?php
/**
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');
checkaccount();
$do = !empty($_GPC['do']) ? $_GPC['do'] : 'display';

if ($do == 'display') {
	if (checksubmit('submit')) {
		if (!empty($_GPC['delete'])) {
			pdo_query("DELETE FROM ".tablename('members_group')." WHERE id IN ('".implode("','", $_GPC['delete'])."')");
		}
		message('用户组更新成功！', referer(), 'success');
	}
	$list = pdo_fetchall("SELECT * FROM ".tablename('members_group'));
	if (!empty($list)) {
		foreach ($list as &$row) {
			if (!empty($row['modules'])) {
				$modules = iunserializer($row['modules']);
				if (is_array($modules)) {
					$row['modules'] = pdo_fetchall("SELECT name, title FROM ".tablename('modules')." WHERE mid IN ('".implode("','", $modules)."')");
				}
			}
		}
	}
} elseif ($do == 'post') {
	$id = intval($_GPC['id']);
	$modules = $_W['modules'];
	if (!empty($id)) {
		$item = pdo_fetch("SELECT * FROM ".tablename('members_group') . " WHERE id = :id", array(':id' => $id));
		$item['modules'] = iunserializer($item['modules']);
	}
	if (checksubmit('submit')) {
		if (empty($_GPC['name'])) {
			message('请输入用户组名称！');
		}
		$data = array(
			'name' => $_GPC['name'],
			'modules' => iserializer($_GPC['modules']),
		);
		if (empty($id)) {
			pdo_insert('members_group', $data);
		} else {
			pdo_update('members_group', $data, array('id' => $id));
		}
		message('用户组更新成功！', create_url('member/group/display'), 'success');
	}
}elseif($do == 'priv'){
	/**
	 * 用户组权限设置
	 */
	
	if(isset($_GPC['dosubmit'])){
		$groupid = !empty($_GPC['groupid']) ? intval($_GPC['groupid']) : 0; 
		if (is_array($_GPC['menuid']) && count($_GPC['menuid']) > 0) {
			pdo_delete('menu_priv', array('groupid'=>$groupid));
			$menuinfo = pdo_fetchall('select id from ims_menu');
			foreach ($menuinfo as $_v) $menu_info[$_v[id]] = $_v;
			$now = time();
			foreach($_GPC['menuid'] as $menuid){
				$info = array();
				$info['groupid'] = $groupid;
				$info['menuid'] = $menuid;
				$info['create_time'] = $now;
				pdo_insert('menu_priv', $info);
			}
		} else {
			pdo_delete('menu_priv', array('groupid'=>$groupid));
		}
		message('', create_url('member/group/priv', array('id'=>$groupid)));

	} else {
		$groupid = intval($_GPC['id']);
		
		set_time_limit(120);
		//$menu = pc_base::load_sys_class('tree');
		require IA_ROOT .'/source/tree.inc.php';
		$menu = new tree();
		$menu->icon = array('│ ','├─ ','└─ ');
		$menu->nbsp = '&nbsp;&nbsp;&nbsp;';
		$result = pdo_fetchall('select * from ims_menu order by listorder asc');
		//$priv_data = $this->priv_db->select(); //获取权限表数据
		$priv_data = pdo_fetchall('select menuid from ims_menu_priv where groupid = '.$groupid);
		if(!empty($priv_data)){
			foreach ($priv_data as $pr){
				$privs[] = $pr['menuid'];
			}
		}
		//$modules = 'admin,announce,vote,system';
		foreach ($result as $n=>$t) {
			//$result[$n]['cname'] = L($t['name'],'',$modules);
			$result[$n]['cname'] = $t['ch_name'];
			$result[$n]['checked'] = is_checked($t['id'], $privs) ? ' checked' : '';
			$result[$n]['level'] = get_level($t['id'],$result); 	//注意，如果parentid与id相同，会导致死循环而无法显示菜单，如果菜单无法显示，请检查menu表的数据
			$result[$n]['parentid_node'] = ($t['parentid'])? ' class="child-of-node-'.$t['parentid'].'"' : '';
			//var_dump($result[$n]['parentid_node']);
		}
		$str  = "<tr id='node-\$id' \$parentid_node>
		<td style='padding-left:30px;'>\$spacer<input type='checkbox' name='menuid[]' value='\$id' level='\$level' \$checked onclick='javascript:checknode(this);'> \$cname</td>
		</tr>";
		$menu->init($result);
		$categorys = $menu->get_tree(0, $str);
		//var_dump($categorys);
		$show_header = true;
		$show_scroll = true;
		template('member/priv');
		die();
	}
	
}

/**
 *  检查指定菜单是否有权限
 * @param array $data menu表中数组
 * @param int $roleid 需要检查的角色ID
 */
function is_checked($data, $priv_data = array()) {
	if(!empty($priv_data)){
		$info = in_array($data, $priv_data);
		if($info){
			return true;
		} else {
			return false;
		}
	}
	return false;
}
/**
 * 获取菜单深度
 * @param $id
 * @param $array
 * @param $i
 */
function get_level($id,$array=array(),$i=0) {
	if(!empty($array)){
		foreach($array as $n=>$value){
			if($value['id'] == $id){
				if($value['parentid']== '0') return $i;
                else continue;
				$i++;
				return get_level($value['parentid'],$array,$i);
			}
		}
	}
}
template('member/group');