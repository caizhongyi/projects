<?php
/**
 * 砸蛋抽奖模块
 *
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');

class GroupbuyingModule extends WeModule {
    public $name = 'GroupbuyingModule';
    public $title = '微团购';
    public $ability = '';
    public $tablename = 'group_buying';

    public function fieldsFormDisplay($rid = 0) {
        global $_W;
        if (!empty($rid)) {
            $reply = pdo_fetch("SELECT * FROM ".tablename($this->tablename)." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));

        }
        include $this->template('form');
    }

    public function fieldsFormValidate($rid = 0) {
        return true;
    }

    public function fieldsFormSubmit($rid = 0) {
        global $_GPC, $_W;
        $id = intval($_GPC['reply_id']);
        $insert = array(
            'weid' => $_W['weid'],
            'name' => $_GPC['name'],
            'summary' => $_GPC['summary'],
            'starttime' => strtotime($_GPC['starttime']),
            'endtime' => strtotime($_GPC['endtime']),
            'email' => $_GPC['email'],
            'email_password' => $_GPC['email_password'],
            'smtp' => $_GPC['smtp'],
            'consume_password' => $_GPC['consume_password'],
            'description' => $_GPC['description'],
            'notice' => $_GPC['notice'],
            'end_theme' => $_GPC['end_theme'],
            'end_description' => $_GPC['end_description'],
            'phonenum' => $_GPC['phonenum'],
            'address' => $_GPC['address'],
            'pay' => $_GPC['pay'],
            'business_description' => $_GPC['business_description'],
            'businessname' => $_GPC['businessname'],
            'oldprice' => $_GPC['oldprice'],
            'per_maxnum' => $_GPC['per_maxnum'],
            'newprice' => $_GPC['newprice'],
            'totalnum' => $_GPC['totalnum'],
            'least' => $_GPC['least'],
            'virtualnum' => $_GPC['virtualnum'],
            'copyright' => $_GPC['copyright'],
            'start_img' => $_GPC['start_img'],
            'end_img' => $_GPC['end_img'],
            'rid' => $rid
        );
        if (empty($id)) {
            pdo_insert($this->tablename, $insert);
        } else {
            pdo_update($this->tablename, $insert, array('id' => $id));
        }
        return true;
    }

    public function ruleDeleted($rid = 0) {
        global $_W;
        $replies = pdo_fetchall("SELECT id FROM ".tablename($this->tablename)." WHERE rid = '$rid'");
        $deleteid = array();
        if (!empty($replies)) {
            foreach ($replies as $index => $row) {
                $deleteid[] = $row['id'];
            }
        }

        pdo_delete($this->tablename, "id IN ('".implode("','", $deleteid)."')");
        return true;
    }

    public function doFormDisplay() {
        global $_W, $_GPC;
        $result = array('error' => 0, 'message' => '', 'content' => '');
        $result['content']['id'] = $GLOBALS['id'] = 'add-row-news-'.$_W['timestamp'];
        $result['content']['html'] = $this->template('item', TEMPLATE_FETCH);
        exit(json_encode($result));
    }

    
}