{template 'header'}
<link type="text/css" rel="stylesheet" href="./source/modules/shopping/images/common.css">
<style>
.mymember{margin-bottom:10px;}
.table{margin:10px 0;}
.table td, .table th{border:0;}
.table th{font-weight:normal; color:#999;}
.table td{text-align:right; color:#333;}
.table .ordersn{font-size:20px; text-align:center; color:red;}
.paybtn{margin:10px 10px 0 0;}
</style>
<div class="navbar navbar-inverse navbar-fixed-top">
	<div class="navbar-inner" style="padding:0 5px;">
		<a class="btn btn-small btn-inverse pull-right" href="{php echo create_url('mobile/channel', array('name' => 'home', 'weid' => $_W['weid']))}"><i class="icon-user"></i> 个人中心</a>
		<button class="btn btn-small btn-inverse pull-left" onclick="history.go(-1);"><i class="icon-chevron-left"></i> 返回</button>
	</div>
</div>
<!--<form action="" method="post" style="overflow:hidden;" onsubmit="return check();">-->
<div class="order-detail">
	<div class="order-detail-list">
        <h3 class="text-center">确认下单</h3>

        <hr class="soften">

        <div class="address">
            收货人：{$profile['realname']} <br>
            <span class="muted">{$profile['address']}</span> <br>
        </div>

        <hr class="soften">
        <ul class="goods-list clearfix">
            <li>
                <img class="thumb" src="{$_W['attachurl']}{$order_goods_info['thumb']}" alt=""/>
                <div class="goods-info">
                     <h4>{$order_goods_info['title']}</h4>
                     <div class="summary">
                         <span>单价:{$order_goods_info['marketprice']}</span><span>数量:{$order_goods_info['total']}</span><span>商品类型:{if $order_goods_info['type'] == 1}实物{else if $order_goods_info['type'] == 2}虚拟物品{/if}</span>
                     </div>
                    <div class="text-right price">￥{php echo $order_goods_info['marketprice']*$order_goods_info['total']}</div>
                </div>
            </li>
        </ul>
        <div class="form">
            <div class="form-group text-right">
                {if $order['paytype'] == 1}
                    <span class="form-label">配送方式:</span>{if $order['sendtype'] == 1}快递{else if $order['sendtype'] == 2}自提{/if} <br>
                   <!-- {if $order['sendtype'] == 1}<span class="form-label">运费:</span><span class="text-danger">12</span>{/if}-->
                {/if}
                <span class="form-label">付款方式:</span>{if $order['paytype'] == 1}余额付款{else if $order['paytype'] == 2}在线支付{/if} <br>
                <span class="form-label">付款金额:</span><span class="price">￥{php echo sprintf('%.2f', $order['price']);}</span><br>
                <span class="form-label">帐户余额:</span><span class="price">￥{php echo sprintf('%.2f', $_W['fans']['credit2']);}</span>
            </div>
        </div>

        <hr class="soften">

        <h4>选择支付方式</h4>
        <ul class="paytype">
            {loop $payment_types  $payment_name $payment_type}
                {if $payment_type['switch']}
                <li>
                    {if $payment_name == "alipay"}
                    <label>
                        <input type="radio" name = "paytype" value="{$pay_conf[$payment_name]['type']}"/>
                        <!--<img class="thumb" src="" alt=""/>-->
                        <div class="paytype-info">
                            <div class="paytype-heading">支付宝支付</div>
                            <p>支持信用卡、储蓄卡快捷支付及支付宝</p>
                        </div>
                    </label>
                    <div class="mobile-li" style="padding:5px;display: none;">
                        <form action="{php echo create_url('mobile/cash/alipay', array('weid' => $_W['weid']));}" method="post">
                            <input type="hidden" name="params" value="{php echo base64_encode(json_encode($params));}" />
                            <button class="btn btn-block btn-primary btn-success" type="submit" name="alipay">支付宝支付</button>
                        </form>
                    </div>
                    {/if}
                    {if $payment_name == "bestpay"}
                    <label>
                        <input type="radio" name = "paytype" value="{$pay_conf[$payment_name]['type']}"/>
                        <!--<img class="thumb" src="" alt=""/>-->
                        <div class="paytype-info">
                            <div class="paytype-heading">翼支付支付</div>
                            <p>支持信用卡、储蓄卡快捷支付及支付宝</p>
                        </div>
                    </label>
                    <div class="mobile-li" style="padding:5px;display: none;">
                        <form action="{php echo create_url('mobile/cash/bestpay', array('weid' => $_W['weid']));}" method="post">
                            <input type="hidden" name="params" value="{php echo base64_encode(json_encode($params));}" />
                            <button class="btn btn-block btn-primary btn-success" type="submit" name="bestpay">翼支付付款</button>
                        </form>
                    </div>
                    {/if}
                    {if $payment_name == "wechat"}
                    <label>
                        <input type="radio" name = "paytype" value="{$pay_conf[$payment_name]['type']}"/>
                        <!--<img class="thumb" src="" alt=""/>-->
                        <div class="paytype-info">
                            <div class="paytype-heading">微信支付</div>
                            <p>支持信用卡、储蓄卡快捷支付</p>
                        </div>
                    </label>
                    <div class="mobile-li" style="padding:5px;display: none;">
                        <button class="btn btn-block btn-primary btn-success" id="wBtn" type="button" onclick="doWechatPay();" value="wechat">微信支付</button>
                    </div>
                    <script type="text/javascript">
                        function doWechatPay() {
                            if(!window.WeixinJSBridge) {
                                $('#wBtn').attr('disabled', 'disabled');
                                $('#wBtn').html('微信支付(必须使用微信内置浏览器)');
                                alert('微信支付必须在微信内置浏览器中使用.');
                                return;
                            }
                            WeixinJSBridge.invoke('getBrandWCPayRequest', {
                                'appId' : '{$wOpt['appId']}',
                                'timeStamp': '{$wOpt['timeStamp']}',
                                'nonceStr' : '{$wOpt['nonceStr']}',
                                'package' : '{$wOpt['package']}',
                                'signType' : '{$wOpt['signType']}',
                                'paySign' : '{$wOpt['paySign']}'
                            }, function(res) {
                                if(res.err_msg == 'get_brand_wcpay_request:ok') {
                                } else {
                                    alert('启动微信支付失败, 请检查你的支付参数. 详细错误为: ' + res.err_msg);
                                }
                            });
                        }
                    </script>
                    {/if}
                    {if $payment_name == "credit"}
                    <label>
                        <input type="radio" name = "paytype" value="{$pay_conf[$payment_name]['type']}"/>
                        <!--<img class="thumb" src="" alt=""/>-->
                        <div class="paytype-info">
                            <div class="paytype-heading">余额支付</div>
                            <p>通过余额支付</p>
                        </div>
                    </label>
                    <div class="mobile-li" style="padding:5px 5px 10px 5px;display: none;">
                        <form action="{php echo create_url('mobile/cash/credit2', array('weid' => $_W['weid']));}" method="post">
                            <input type="hidden" name="params" value="{php echo base64_encode(json_encode($params));}" />
                            {if $params['fee'] < $_W['fans']['credit2']}
                            <button class="btn btn-block btn-primary btn-success" type="submit" value="credit">余额支付 （余额支付当前 {php echo sprintf('%.2f', $_W['fans']['credit2']);}元)</button>
                            {else}
                            <button class="btn btn-block btn-primary" type="button" onclick="location.href='{php echo create_url('mobile/module/charge', array('name' => 'member', 'weid' => $_W['weid']))}'" value="credit">余额充值，（余额支付当前 {php echo sprintf('%.2f', $_W['fans']['credit2']);})</button>
                            {/if}
                        </form>
                    </div>
                    {/if}
                </li>
                {/if}
            {/loop}
        </ul>
        <h4>选择配送方式</h4>
        <ul class="paytype">
            <li>
                <label>
                    <input type="radio" name = "sendtype" value="1"/>
                 <!--   <img class="thumb" src="" alt=""/>-->
                    <div class="paytype-info">
                        <div class="paytype-heading">快递</div>
                        <p>快递由商家自选</p>
                    </div>
                </label>
                <label>
                    <input type="radio" name = "sendtype" value="2"/>
                 <!--   <img class="thumb" src="" alt=""/>-->
                    <div class="paytype-info">
                        <div class="paytype-heading">自提</div>
                        <p>持本人有效身份证件到指定商户领取</p>
                    </div>
                </label>
            </li>
        </ul>
	</div>
</div>
	<input type="hidden" name="orderid" value="{$orderid}" />
	<input type="hidden" name="token" value="{$_W['token']}" />
	<input type="submit" name="submit" id="submit" class="btn btn-success paybtn pull-right btn-block" value="立即支付" />
<!--</form>-->
<script type="text/javascript">
    $("#submit").click(function(){
        var paytype = $("input[name='paytype']:checked").val();
        var check_form = $("input[name='paytype']:checked").closest('li').find('form');
        if(!paytype){
            alert('请选择支付方式');  return false;
        }
        var sendtype = $("input[name='sendtype']:checked").val();
        if(!sendtype){
            alert('请选择配送方式');  return false;
        }
        $.post('{$pay_url}', {orderid: "{$orderid}", token:"{$_W['token']}",submit:1,sendtype:sendtype,paytype:paytype}, function (rs) {
            if (rs.errno == 200) {
                check_form.submit();
            }else if(rs.errno == -1){
                alert(rs.error);
            }
        }, 'json');
    })

</script>
{template 'footer'}