{php $_W['breadcrumb'] = array(array('title'=>'微商城'),array('title'=>$cur_module['title']),array('title'=>'添加'.$cur_module['title']))}
{php $load_js=array('bootstrap.fileupload')}
{template 'common/header'}

{if $operation == 'post' }
<div class="page-header">
    <h1>
        <i class="icon-book"></i> 添加商品
    </h1>
</div>
<script>
   function changgetab(id){
       var li=document.getElementById('li'+id);
       var li2=document.getElementById('li'+(3-id));
       var div=document.getElementById('tabdiv'+id);
       var div2=document.getElementById('tabdiv'+(3-id));
       li.className="active";
       li2.className="null";
       div.style.display= 'block';
       div2.style.display= 'none';
       if(id==2){
           changgetype(document.getElementById('ptype'));
       }
   }
</script>
<ul class="nav nav-tabs">
    <li id="li1" class="active"><a href="javascript:changgetab(1);">通用属性设置</a></li>
    <li id="li2" ><a href="javascript:changgetab(2);">独立属性设置</a></li>
</ul>
<br/><input type="hidden" name="id" id="id" value="{$item['id']}" /><br/>

<div class="main">

	<form action="" method="post" class="form-horizontal form" enctype="multipart/form-data">
        <div id="tabdiv1" >
		<table class="tb">

			<tr>
				<th><label for="">排序</label></th>
				<td>
					<input type="text" name="displayorder" class="span6" value="{$item['displayorder']}" />
				</td>
			</tr>
			<tr>
				<th>分类</th>
				<td>
					<select class="span3" style="margin-right:15px;" name="pcate" onchange="fetchChildCategory(this.options[this.selectedIndex].value)"  autocomplete="off">
						<option value="0">请选择一级分类</option>
						{loop $category $row}
						{if $row['parentid'] == 0}
						<option value="{$row['id']}" {if $row['id'] == $item['pcate']} selected="selected"{/if}>{$row['name']}</option>
						{/if}
						{/loop}
					</select>
					<select class="span3" id="cate_2" name="ccate" autocomplete="off">
						<option value="0">请选择二级分类</option>
						{if !empty($item['ccate']) && !empty($children[$item['pcate']])}
						{loop $children[$item['pcate']] $row}
						<option value="{$row[0]}" {if $row[0] == $item['ccate']} selected="selected"{/if}>{$row[1]}</option>
						{/loop}
						{/if}
					</select>
				</td>
			</tr>
			<tr>
				<th><label for="">商品名称</label></th>
				<td>
					<input type="text" name="goodsname" class="span6" value="{$item['title']}" />
				</td>
			</tr>
			<tr>
				<th><label for="">商品单位</label></th>
				<td>
					<input type="text" name="unit" class="span3" value="{$item['unit']}" />
				</td>
			</tr>
			<tr>
				<th><label for="">商品类型</label></th>
				<td>
					<label for="isshow3" class="radio inline"><input type="radio" name="type" value="1" id="isshow3" {if empty($item) || $item['type'] == 1}checked="true"{/if} onclick="$('#product').show()" /> 实体商品</label>&nbsp;&nbsp;&nbsp;<label for="isshow4" class="radio inline"><input type="radio" name="type" value="2" id="isshow4"  {if $item['type'] == 2}checked="true"{/if}  onclick="$('#product').hide()" /> 虚拟商品</label>
					<span class="help-block">虚拟商品，例如：优惠券，打折卡等，需要用户去店里消费使用的。实体商品，需要进行用户自提或是邮递的商品。</span>
				</td>
			</tr>
			<tr>
				<th><label for="">是否上架</label></th>
				<td>
					<label for="isshow1" class="radio inline"><input type="radio" name="status" value="1" id="isshow1" {if empty($item) || $item['status'] == 1}checked="true"{/if} /> 是</label>
					&nbsp;&nbsp;&nbsp;
					<label for="isshow2" class="radio inline"><input type="radio" name="status" value="0" id="isshow2"  {if !empty($item) && $item['status'] == 0}checked="true"{/if} /> 否</label>
					<span class="help-block"></span>
				</td>
			</tr>
			<tr>
				<th><label for="">缩略图</label></th>
				<td>
					<div class="fileupload fileupload-new" data-provides="fileupload">
						<div class="fileupload-preview thumbnail" style="width: 200px; height: 150px;">{if $item['thumb']}<img src="{$_W['attachurl']}{$item['thumb']}" width="200" />{/if}</div>
						<div>
							<span class="btn btn-sm btn-primary btn-file"><span class="fileupload-new">选择图片</span><span class="fileupload-exists">更改</span><input name="thumb" type="file" /></span>
							<a href="#" class="btn fileupload-exists" data-dismiss="fileupload">移除</a>
							{if $item['thumb']}<button type="submit" name="fileupload-delete" value="{$item['thumb']}" class="btn fileupload-new">删除</button>{/if}
						</div>
					</div>
					<span class="help-block"></span>
				</td>
			</tr>
			<tr>
				<th><label for="">商品编号</label></th>
				<td>
					<input type="text" name="goodssn" class="span6" value="{$item['goodssn']}" />
				</td>
			</tr>
			<tr>
				<th><label for="">商品条码</label></th>
				<td>
					<input type="text" name="productsn" class="span6" value="{$item['productsn']}" />
				</td>
			</tr>
			<tr>
				<th><label for="">销售价</label></th>
				<td>
					<input type="text" name="marketprice" class="span3" value="{$item['marketprice']}" /> 元
				</td>
			</tr>
			<tr>
				<th><label for="">成本价</label></th>
				<td>
					<input type="text" name="productprice" class="span3" value="{$item['productprice']}" /> 元
				</td>
			</tr>
			<tr>
				<th><label for="">库存</label></th>
				<td>
					<input type="text" name="total" class="span3" value="{$item['total']}" />
					<span class="help-block">当前商品的库存数量，设置-1则表示不限制。</span>
				</td>
			</tr>
			<tr>
				<th>简介</th>
				<td>
					<textarea style="height:150px;" class="span7" name="description" cols="70">{$item['description']}</textarea>
				</td>
			</tr>
			<tr>
				<th>内容</th>
				<td>
					<textarea style="height:400px; width:100%;" class="span7 richtext-clone" name="content" cols="70">{$item['content']}</textarea>
				</td>
			</tr>


		</table>
        </div>
        <div id="tabdiv2" style="display: none;">
            <div><table class="tb">
                <th><label for="">商品属性类别</label></th>
                <td>
                    <script>
                        var attrtable;
                        var colornum=1;
                        var colo=1;
                        var colorvalues;
                        function addcol(){
                            $("#colornum").val(++colornum);
                            var newnode ="<div id='coattrdiv"+colornum+"' ><a onclick='delcol("+colornum+")' >[－]</a>";
                            newnode +="<select  class='span3' style='margin-right:15px;' name='coattr"+colornum+"'><option value='0'>请选择一种颜色</option>";
                            for(var j=0;j<colorvalues.length;j++){
                                newnode +="<option value="+colorvalues[j]+">"+colorvalues[j]+"</option>";
                            }
                            //newnode +="</select><input name='attrthum"+colornum+"' type='file' style='float:right;margin-right: 470px;' /></span></div>";
                            newnode +="</select><div>"+addpicture('pattrname'+colornum)+"</div></div>";
                           $("#coattrdiv1").parent().append(newnode);
                        }
                        function addpicture(pattrname){
                            var phtml="<div class='fileupload fileupload-new' style='margin-bottom: 20px;margin-left: 20px;float:left;' data-provides='fileupload'>"+
                                    "<div class='fileupload-preview thumbnail' style='width: 200px; height: 150px;'>" +
                                    "{if $item['thumb']}<img src=\"{$_W['attachurl']}{$item['thumb']}\" width='200' />{/if}</div><div>" +
                                    "<span class='btn btn-sm btn-primary btn-file'><span class='fileupload-new'>选择图片</span><span class='fileupload-exists'>更改</span>"+
                                    "<input name='"+pattrname+"' type='file' /></span><a href='#' class='btn fileupload-exists' data-dismiss='fileupload'>移除</a>" +
                                    " {if $item['thumb']}<button type='submit' name='fileupload-delete' value='{$item['thumb']}' class='btn fileupload-new'>删除</button>{/if}" +
                                    "<span class='btn btn-sm btn-primary btn-file'><a onclick='addpicbynode(this);'>添加图片</a></span></div></div>";
                            return phtml;
                        }
                        function addpicbynode(node){
                            $($($(node).parent()).parent()).parent().after(addpicture('pattrname'+colo++));
                        }
                        function delcol(id){
                            $("#coattrdiv"+id).remove();
                        }
                        function changgetype(selc){
                            if(selc.value==-1) return ;
                            //列举属性，判断属性类别，填充值。
                            $.get("site.php?act=module&op=getattrs&name=businesshall&do=goods&type_id="+selc.value, function(data){//后台获取type列表
                                var objss = eval(data);
                                var objs = objss[0];
                                var tbody = $("#attrtbody");
                                var text;
                                $("#numofattrs").val(objs.length);
                                for(var i=0;i<objs.length;i++){//生成html展示信息
                                    text += "<tr><th><label>"+objs[i]['attr_name']+"</label></th><td >" ;
                                    if(objs[i]['attr_input_type']==0){//input or textarea
                                        if(objs[i]['attr_type']==2){//textarea
                                            //$goodsattrs  属性填充
                                            text += "<textarea  name='attr"+objs[i]['attr_id']+"' style='height:150px;' class='span7'  cols='70' ></textarea>";
                                        }else{//input
                                            text += "<input type='text' name='attr"+objs[i]['attr_id']+"'  class='span3'></input>";
                                        }
                                    }else if(objs[i]['attr_input_type']==1){//单选
                                        text +="<select  class='span3' style='margin-right:15px;' name='attr"+objs[i]['attr_id']+"' >";
                                        var values=objs[i]['attr_values'].split("\n");
                                        for(var j=0;j<values.length;j++){
                                            text +="<option value="+values[j]+">"+values[j]+"</option>";
                                        }
                                        text +="</select>";
                                    }else if(objs[i]['attr_input_type']==2){//复选
                                        var values=objs[i]['attr_values'].split("\n");
                                        for(var j=0;j<values.length;j++){
                                            text +="</label class='span2'>"+values[j]+"</label><input type='checkbox' style='margin-right: 30px;margin-left: 5px;'  name='attr"+objs[i]['attr_id']+"unit"+j+"' value="+values[j]+" />";
                                        }
                                    }else { //等于3的时候：  获取attr_type: 1]合约列表 2]号码列表 3]颜色列表
                                        switch (objs[i]['attr_type']){
                                            case '1':// 1]合约列表
                                                var hyobjs = objss[1];
                                                for(var hi=0;hi<hyobjs.length;hi++)
                                                text+="</label class='span2'>"+hyobjs[hi]['contract_name']+"</label><input type='checkbox' style='margin-right: 30px;margin-left: 5px;'  name='hyattr"+hyobjs[hi]['contract_id']+"'  value='"+hyobjs[hi]['contract_id']+"'/>";
                                                break;
                                            case '2':// 2]电话套餐列表
                                                var phobjs = objss[2];
                                                for(var hi=0;hi<phobjs.length;hi++)
                                                    text+="</label class='span2'>"+phobjs[hi]['phonenum_name']+"</label><input type='checkbox' style='margin-right: 30px;margin-left: 5px;'  name='phattr"+phobjs[hi]['phone_package_id']+"'  value='"+phobjs[hi]['phone_package_id']+"'/>";
                                                break;
                                            case '3':// 3]颜色列表
                                                text +="<div id='coattrdiv1' ><a  onclick='addcol()'>[＋]</a><input type='hidden' id='colornum' value='1'/>" +
                                                        "<select  class='span3' style='margin-right:15px;' name='coattr1'><option value='0'>请选择一种颜色</option>";
                                                colorvalues=objs[i]['attr_values'].split("\n");
                                                for(var j=0;j<colorvalues.length;j++){
                                                    text +="<option value="+colorvalues[j]+">"+colorvalues[j]+"</option>";
                                                }
                                                text +="</select><div>"+addpicture('pattrname1')+"</div></div>";
                                                break;
                                        }
                                    }
                                    text +="</td></tr>";
                                }
                                tbody.html(text);
                                //获取具体商品属性
                                var id = document.getElementById('id');
                                $.get("site.php?act=module&op=getgoodsattrs&name=businesshall&do=goods&id="+id.value, function(data){//获取商品属性列表
                                    var objss = eval(data);
                                    var objs = objss[0];
                                    for(var i=0;i<objs.length;i++){
                                        // alert(objs[i]['attr_id']+"=="+objs[i]['attr_value']+"==attr_input_type:"+objs[i]['attr_input_type']+"==attr_type:"+objs[i]['attr_type']);
                                        var tmpobj = document.getElementsByName('attr'+objs[i]['attr_id']);
                                        if(objs[i]['attr_input_type'] < 2) {
                                            tmpobj[0].value=objs[i]['attr_value'];
                                        }else if(objs[i]['attr_input_type'] == 2) { //普通复选框
                                            var values=objs[i]['attr_value'].split("\n");
                                            for(var j=0;j<values.length-1;j++){//最后一个是空值
                                                var checkbs = document.getElementsByName('attr'+objs[i]['attr_id']+"unit"+j);
                                                for(var k=0;k<values.length-1;k++){//最后一个是空值
                                                    if($(checkbs).val()==values[k])
                                                        $(checkbs).prop('checked',true);
                                                }
                                            }
                                        }else { //获取attr_type: 1]合约列表 2]号码列表 3]颜色列表
                                            if(objs[i]['attr_type'] ==1){// 1]合约列表
                                                var values=objs[i]['attr_value'].split("\n");//物品选择的合约列表
                                                var objs1 = objss[1];//全部合约列表
                                                for(var j=0;j<objs1.length;j++){
                                                    var checkbs = document.getElementsByName('hyattr'+objs1[j]['contract_id']);//获取checkbox对象
                                                    for(var k=0;k<values.length-1;k++){//最后一个是空值
                                                        if($(checkbs).val()==values[k])//勾选
                                                            $(checkbs).prop('checked',true);
                                                    }
                                                }
                                            }else if(objs[i]['attr_type'] ==2){//  2]号码列表
                                                var values=objs[i]['attr_value'].split("\n");//物品选择的号码套餐列表
                                                var objs2 = objss[2];//全部套餐列表
                                                for(var j=0;j<objs2.length;j++){
                                                    var checkbs = document.getElementsByName('phattr'+objs2[j]['phone_package_id']);//获取checkbox对象
                                                    for(var k=0;k<values.length-1;k++){//最后一个是空值
                                                        if($(checkbs).val()==values[k])//勾选
                                                            $(checkbs).prop('checked',true);
                                                    }
                                                }
                                            }else{// 3]颜色列表
                                            }
                                        }
                                        // else alert(objs[i]['attr_name']+"=="+objs[i]['attr_value']);
                                    }
                                });
                            });
                        }
                    </script>
                    <input type="hidden" id="numofattrs" name="numofattrs" value="0"/>
                    <select  class="span3" style="margin-right:15px;" name="ptype"  id="ptype" onchange="javascript:changgetype(this)" >
                        <option  value="-1">请选择属性类别</option></option>
                        {loop $typelist $row}
                        <option value="{$row['type_id']}" {if $row['type_id'] == $item['type_id']} selected="selected" {/if} >{$row['type_name']}</option>
                        {/loop}
                    </select>

                </td></table>
            </div>
            <table class="tb" id="attrtable">
                <tbody id="attrtbody"></tbody>
            </table>
        </div>
         <div style="margin-left: 250px;">
             <input name="submit" type="submit" value="提交" class="btn btn-sm btn-primary">
               <input type="hidden" name="token" value="{$_W['token']}" />
             <div>
	</form>
</div>



<script type="text/javascript">
<!--
	var category = {php echo json_encode($children)};
	kindeditor($('.richtext-clone'));
//-->
</script>
{elseif $operation == 'display'}
<div class="page-header">
    <h1>
        <i class="icon-book"></i> 商品管理
    </h1>
</div>
<div class="main">
<p>
        <a href="{php echo $this->createWebUrl('goods', array('name' => 'businesshall', 'op' => 'post'))}" class="btn btn-sm btn-primary"><i class="icon-pencil"></i>添加商品</a>
	</p>
	<div>
		<form action="site.php" method="get">
		<input type="hidden" name="act" value="module" />
		<input type="hidden" name="do" value="goods" />
		<input type="hidden" name="op" value="display" />
		<input type="hidden" name="name" value="businesshall" />
		<table class="table table-striped table-bordered table-hover">
			<tbody>
				<tr>
					<th>关键字</th>
					<td>
						<input class="span6" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
					</td>
				</tr>
				<tr>
					<th>状态</th>
					<td>
						<select name="status">
							<option value="1" {if !empty($_GPC['status'])} selected{/if}>上架</option>
							<option value="0" {if empty($_GPC['status'])} selected{/if}>下架</option>
						</select>
					</td>
				</tr>
				<tr>
					<th>分类</th>
					<td>
						<select class="span3" style="margin-right:15px;" name="cate_1" onchange="fetchChildCategory(this.options[this.selectedIndex].value)">
							<option value="0">请选择一级分类</option>
							{loop $category $row}
							{if $row['parentid'] == 0}
							<option value="{$row['id']}" {if $row['id'] == $_GPC['cate_1']} selected="selected"{/if}>{$row['name']}</option>
							{/if}
							{/loop}
						</select>
						<select class="span3" id="cate_2" name="cate_2">
							<option value="0">请选择二级分类</option>
							{if !empty($_GPC['cate_1']) && !empty($children[$_GPC['cate_1']])}
							{loop $children[$_GPC['cate_1']] $row}
							<option value="{$row[0]}" {if $row[0] == $_GPC['cate_2']} selected="selected"{/if}>{$row[1]}</option>
							{/loop}
							{/if}
						</select>
					</td>
				</tr>
				 <tr class="search-submit">
					<td colspan="2"><button class="btn  btn-primary "><i class="icon-search icon-large"></i> 搜索</button></td>
				 </tr>
			</tbody>
		</table>
		</form>
	</div>
	<div style="padding:15px;">
		<table class="table table-hover">
			<thead class="navbar-inner">
				<tr>
					<th style="width:30px;">ID</th>
					<th style="min-width:150px;">商品标题</th>
					<th style="width:100px;">商品编号</th>
					<th style="width:100px;">商品条码</th>
					<th style="width:100px;">销售价/成本价</th>
					<th style="width:100px;">属性</th>
					<th style="text-align:right; min-width:60px;">操作</th>
				</tr>
			</thead>
			<tbody>
				{loop $list $item}
				<tr>
					<td>{$item['id']}</td>
					<td>{if !empty($category[$item['pcate']])}<span class="text-error">[{$category[$item['pcate']]['name']}] </span>{/if}{if !empty($children[$item['pcate']])}<span class="text-info">[{$children[$item['pcate']][$item['ccate']][1]}] </span>{/if}{$item['title']}</td>
					<td>{$item['goodssn']}</td>
					<td>{$item['productsn']}</td>
					<td style="background:#f2dede;">{$item['marketprice']}元 / {$item['productprice']}元</td>
					<td>{if $item['status']}<span class="label label-success">上架</span>{else}<span class="label label-error">下架</span>{/if}&nbsp;<span class="label label-info">{if $item['type'] == 1}实体商品{else}虚拟商品{/if}</span></td>
					<td style="text-align:right;">
						<a href="{php echo $this->createWebUrl('goods', array('id' => $item['id'], 'op' => 'post'))}">编辑</a>&nbsp;&nbsp;<a href="{php echo $this->createWebUrl('goods', array('id' => $item['id'], 'op' => 'delete'))}" onclick="return confirm('此操作不可恢复，确认删除？');return false;">删除</a>
					</td>
				</tr>
				{/loop}
			</tbody>
			<tr>
				<td></td>
				<td colspan="3">
					<input name="token" type="hidden" value="{$_W['token']}" />
					<input type="submit" class="btn btn-primary" name="submit" value="提交" />
				</td>
			</tr>
		</table>
		{$pager}
	</div>
</div>
<script type="text/javascript">
<!--
	var category = {php echo json_encode($children)};
//-->
</script>
{/if}
{template 'common/footer'}