<?php
/**
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');
$current['designer'] = ' class="current"';
if ($_W['account']['type']==2) {
    $platform = 'yixin';
    $host_url = "https://api.yixin.im";
    $menusetcookie = 'yixin-menuset-' . $_W['weid'];
} else {
    $platform ='weixin';
    $host_url= "https://api.weixin.qq.com";
    $menusetcookie = 'weixin-menuset-' . $_W['weid'];
}
$params = array('platform'=>$platform);
checkaccount();
if($_W['ispost']) {
	if($_GPC['do'] == 'remove') {
		$token = client_token($platform);
        $url = $host_url."/cgi-bin/menu/delete?access_token={$token}";
		$content = ihttp_get($url);
		if(empty($content)) {
			message('接口调用失败，请重试！');
		}
		$dat = $content['content'];
		$result = @json_decode($dat, true);
		if($result['errcode'] == '0') {
			isetcookie($menusetcookie, '', -500);
			message('已经成功删除菜单，请重新创建。', create_url('menu',$params));
		} else {
			message('公众平台返回接口错误，错误内容为：' . $menus['errmsg']);
		}
	}
	if($_GPC['do'] == 'refresh') {
		isetcookie($menusetcookie, '', -500);
		message('已清空缓存，将重新从公众平台接口获取菜单信息。', create_url('menu',$params));
	}
	require model('rule');
	$mDat = $_GPC['do'];
	$menus = json_decode($mDat, true);
	if(!is_array($menus)) {
		message('操作非法.');
	}
    foreach($menus as &$m) {
        $m['name'] = urlencode($m['name']);
        if(is_array($m['sub_button'])) {
            foreach($m['sub_button'] as &$s) {
                $s['name'] = urlencode($s['name']);
            }
        }
    }
	$ms = array();
	$ms['button'] = $menus;
	$dat = json_encode($ms);
	$dat = urldecode($dat);
	$token = client_token($platform);
	$url = $host_url."/cgi-bin/menu/create?access_token={$token}";
	sleep(1); //修复view第一次提交会失败
	$content = ihttp_post($url, $dat);
	$dat = $content['content'];
	$result = @json_decode($dat, true);
	if($result['errcode'] == '0') {
		isetcookie($menusetcookie, '', -500);
		message('已经成功创建菜单. ', create_url('menu',$params));
	} else {
		message('公众平台返回接口错误，错误内容为：' . $result['errmsg']);
	}
}
$dat = $_GPC[$menusetcookie];
if(empty($dat)) {
	$token = client_token($platform);
	$url = $host_url."/cgi-bin/menu/get?access_token={$token}";
	$content = ihttp_get($url);

	if(empty($content)) {
		message('获取菜单数据失败，请重试！');
	}
	$dat = $content['content'];
}

$menus = @json_decode($dat, true);

if(empty($menus) || !is_array($menus)) {
	message('获取菜单数据失败，请重试！');
}

if($menus['errcode'] && !in_array($menus['errcode'], array(46003))) {
	message('公众平台返回接口错误，错误内容为：' . $menus['errmsg']);
}
isetcookie($menusetcookie, $dat, 86400);
//自定义菜单显示bug
if(!is_array($menus['menu']['button'])){
    $button = json_decode($menus['menu'],1);
    $menus['menu'] = $button;
}
if(is_array($menus['menu']['button'])) {
    foreach($menus['menu']['button'] as &$m) {
        if($m['key']) {
            $pieces = explode(':', $m['key'], 2);
            $m['module'] = $pieces[0];
            $m['rid'] = $pieces[1];
        }
        if(is_array($m['sub_button'])) {
            foreach($m['sub_button'] as &$s) {
                $pieces = explode(':', $s['key'], 2);
                $s['module'] = $pieces[0];
                $s['rid'] = $pieces[1];
            }
        }
    }
}

template('menu/designer');

function client_token($platform ="") {
    global $_W;
    if ($platform=="yixin") {
        if (empty($_W['account']['key']) || empty($_W['account']['secret'])) {
            message('请填写易信公众号的appid及appsecret！', create_url('account/post', array('id' => $_W['weid'])), 'error');
        }
        $url = "https://api.yixin.im/cgi-bin/token?grant_type=client_credential&appid={$_W['account']['key']}&secret={$_W['account']['secret']}";
    } else {
        if (empty($_W['account']['key']) || empty($_W['account']['secret'])) {
            message('请填写微信公众号的appid及appsecret！', create_url('account/post', array('id' => $_W['weid'])), 'error');
        }
        $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$_W['account']['key']}&secret={$_W['account']['secret']}";
    }
	$content = ihttp_get($url);
	if(empty($content)) {
		message('获取菜单数据失败，请重试！');
	}
	$token = @json_decode($content['content'], true);
	if(empty($token) || !is_array($token)) {
		message('获取菜单数据失败，请重试！');
	}
	$token = $token['access_token'];
	if(empty($token)) {
		message('获取菜单数据失败，请重试！');
	}
	return $token;
}
