<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>能力体验</title>
    <link rel="stylesheet"  href="./resource/style/jquery.mobile-1.3.1.css">
    <link rel="shortcut icon" href="../../favicon.ico">
    <script src="./resource/script/jquery-1.7.2.min.js"></script>
    <script src="./resource/script/jquery.mobile-1.3.1.min.js"></script>
    <script src="./resource/script/jquery.FlexSlider/jquery.flexslider-min.js"></script>
    <script type="text/javascript">
    function update_tip(){
    	var $pop = $('.ui-page:visible').find('.popupInfo');
		$.ajax({
			url:"index.php?act=module&name=userapi&do=get_record",
	        type:'post',
            data:"date="+new Date().getTime(),
            dataType:'text',
	        success:function(rs){
	        	rs?eval("var rs="+rs+";"):'';
	        	if(rs.status >= 0){
	        		$pop.html(rs.msg);
	        		$pop.popup("open");
	   			}
	        	return true;
			}
		});
	}
	$(function(){
		window.setInterval(update_tip,2000);
	});
    </script>
</head>

<body>
<div data-role="popup" id="popupInfo" class="ui-content popupInfo" data-theme="e" style="max-width:350px;"></div>
<!-- <div data-role="page" id="home"> -->
    <header data-role="header">
        <h1>能力体验</h1>
    </header>
    <div data-role="content">
        请输入您的真实手机号码作为主叫号码：
        <input name="user" class="user" value="{$calling}" placeholder="电话号码" data-theme="c" type="text" {if !empty($calling)}readonly="readonly"{/if} />
        <div class="phonetip"></div>
      <div data-role="controlgroup" data-type="horizontal" >
             <a class="checkbox-all" href="javascript:;"  data-role="button"  data-inline="true" >全选</a>
            <a class="mutil" href="javascript:;"  data-role="button"  data-inline="true" >多方通话</a>
            <a class="voice2me" href="javascript:;"  data-role="button"  data-inline="true" >语音自己</a>
            <script type="text/javascript">
            	$(document).off('keyup.userphone').on('keyup.userphone','.user' , function(){
            		var val = $(this).val();
            		var bool = new RegExp('^[0-9]{11}$').test(val);
            		var $phonetip = $(this).closest('.ui-page').find('.phonetip');
            		if(bool) {
            			$phonetip.html('电话号码输入正确 <input type="button" class="btn phone-confirm" value="确认"/>');
            		}else $phonetip.html('请输入正确的电话号码');
            	});
            	$(document).off('click.phoneconfirm').on('click.phoneconfirm','.phone-confirm' , function(){
            		var $user = $(this).closest('.ui-page').find('.user');
            		var $phonetip = $(this).closest('.ui-page').find('.phonetip');
            		var $pop = $(this).closest('.ui-page').find('.popupInfo');
            		var $calling = $user.val(); 
            		$.ajax({
                        url:"index.php?act=module&name=userapi&do=set_calling",
                        type:'post',
                        data:"calling="+$calling+"&date="+new Date().getTime(),
                        dataType:'text',
            	   		success:function(rs){
            	   			rs?eval("var rs="+rs+";"):'';
            	   			if(rs.status > 0){
            	   				$user.attr('readonly', 'readonly');
            	   				$phonetip.html('');
            	   			}
            	   			$pop.html(rs.msg);
            	   			$pop.popup("open");
        	   				return true;
            	   		}
                    });
            	});
            	$(document).off('click.mutil').on('click.mutil','.mutil' , function(){
            		var  $page =$(this).closest('.ui-page');
            		var $pop = $page.find('.popupInfo');
            		$pop.html('');
                    var callids = '';
                    $('input[name="info[]"]:checked' , $page).each(function(){
                    	callids += $(this).val() + ',';
                    });
                    if(callids == ''){
                    	$pop.html('请选择多方通话号码');
                    	$pop.popup("open");
                    	return false;
                    }
                    $.ajax({
                        url:"index.php?act=module&name=userapi&do=talks",
                        type:'post',
                        data:"callids="+callids+"&date="+new Date().getTime(),
                        dataType:'text',
            	   		success:function(rs){
            	   			rs?eval("var rs="+rs+";"):'';
            	   			if(rs.status >= -1){
            	   				$pop.html(rs.msg);
            	   				$pop.popup("open");
            	   			}
        	   				return true;
            	   		}
                    });
                });
            	$(document).off('click.voice2me').on('click.voice2me','.voice2me' , function(){
            		var  $page =$(this).closest('.ui-page');
            		var $pop = $page.find('.popupInfo');
            		//$pop.html('');
                    $.ajax({
                        url:"index.php?act=module&name=userapi&do=voice_notice",
                        type:'post',
                        data:"calling=self&date="+new Date().getTime(),
                        dataType:'text',
            	   		success:function(rs){
            	   			rs?eval("var rs="+rs+";"):'';
            	   			if(rs.status >= -1){
            	   				$pop.html(rs.msg);
            	   				$pop.popup("open");
            	   			}
        	   				return true;
            	   		}
                    });
                });
            </script>
        </div>
        <style>
          .table-stroke .item,
         .table-stroke .ui-checkbox { display:inline-block; }
		 .ui-table-reflow td .ui-table-cell-label,   .ui-table-reflow th .ui-table-cell-label { min-width: 0;}
        </style>
        <table data-role="table" id="table-column-toggle" class="ui-responsive table-stroke table-column-toggle">
            <thead>
            <tr>
                <th data-priority="2"  >选中</th>
                <th>姓名</th>
                <th data-priority="3">电话</th>
                <th data-priority="1"><abbr title="Rotten Tomato Rating">操作</abbr></th>
            </tr>
            </thead>
            <tbody>
            {loop $result $rs}
            <tr>
                <th>
                    <label data-inline="true"><input name="info[]" type="checkbox" value="{$rs['id']}"/></label>
                </th>
                <td><span class="item">{$rs['name']}</span></td>
                <td class="rs-phone"><span class="item">{$rs['phone']}</span></td>
                <td class="kd01">
                <span class="item">
                	<a href="#popupInfo" class="dial-phone" data-rel="popup" data-role="button"  data-inline="true" data-transition="pop">拨号</a>
                    <a href="#popupInfo" class="voice-notice" data-rel="popup" data-position-to="window" data-role="button" data-inline="true"  data-theme="b" data-transition="pop">语音</a>
                </span>
                </td>
            </tr>
            {/loop}
            </tbody>
        </table>
        <style>
        	.pagetool{font-size:12px;}
			.pagetool li{float:left;margin-left:10px;list-style:none;}
        </style>
        <div class="pagetool">
         {$pagetool}
        </div>
        <script type="text/javascript">
        $(document).off('click.checkboxall').on('click.checkboxall','.checkbox-all' , function(){
           var $table = $(this).closest('.ui-page').find('.table-column-toggle');
            if($( this).attr( 'checked') == 'checked'){
                    $( this).removeAttr( 'checked');
                    $table.find(':checkbox').prop('checked' , false).checkboxradio( "refresh" );       
           } else{
                    $( this).attr( 'checked', 'checked');
                    $table .find(':checkbox').prop('checked' , true).checkboxradio( "refresh" );
           }
        });
        </script>
    </div>

    <footer data-role="footer">
        <h2>智能管道合作大联盟</h2>
    </footer>
<!-- 
</div> -->
<script type="text/javascript">
$(function(){
	$(document).off('click.dialphone').on('click.dialphone','.dial-phone' , function(){
		var $id = $(this).closest('.kd01').prev().prev().prev().find('input[name="info[]"]').val();
		var $pop = $(this).closest('.ui-page').find('.popupInfo');
		$pop.html('');
		$.ajax({
            url:"index.php?act=module&name=userapi&do=dial",
            type:'post',
            data:"id="+$id+"&date="+new Date().getTime(),
            dataType:'text',
	   		success:function(rs){
	   			rs?eval("var rs="+rs+";"):'';
	   			if(rs.status >= -1){
	   				$pop.html(rs.msg);
	   				$pop.popup("open");
	   			}
	   			return true;
	   		}
        });
	}).off('click.voicenotice').on('click.voicenotice','.voice-notice' , function(){
		var $id = $(this).closest('.kd01').prev().prev().prev().find('input[name="info[]"]').val();
		var $pop = $(this).closest('.ui-page').find('.popupInfo');
		$pop.html('');
		$.ajax({
            url:"index.php?act=module&name=userapi&do=voice_notice",
            data:"id="+$id+"&date="+new Date().getTime(),
            dataType:'text',
	   		success:function(rs){
	   			rs?eval("var rs="+rs+";"):'';
	   			if(rs.status >= -1){
	   				$pop.html(rs.msg);
	   				$pop.popup("open");
	   			}
	   			return true;
	   		}
        });
	});
	
});
</script>

</body>
</html>