{php $_W['breadcrumb'] = array(array('title'=>'微会员'),array('title'=>'优惠劵管理'),array('title'=>'优惠券消费管理'))}
{template 'common/header'}
<div class="page-header">
    <h1>
        <i class="icon-book"></i> 优惠券消费管理
    </h1>
</div>
<div id="main">
    <div class="alert alert-info">
    	<span>优惠券 SN码派发：1张</span>已消费：0张
    </div>
    <div>
        <form action="" method="post">
            <input type="hidden" name="act" value="coupon"/>
            <input type="hidden" name="actType" value="detail">
            <input type="hidden" name="couponId" value="{$r_couponId}">
            <table class="table table-striped table-bordered table-hover">
                <tbody>
			 		<tr>
                         <th>关键字</th>
                         <td>
	                         <input type="text" id="keyword-input" name="keyword-input" value="{$r_keyWord}" 
	                         		class="span6" placeholder="输入关键字" data-rule-required="true" />
                         </td>
	                </tr>
				 	<tr>
                        <th>状态</th>
                        <td>
					        <select name="query_type" class="form-control" style="width:110px; ">
                                <option value="all" {if empty($r_queryType) || $r_queryType == 'all'}selected="selected"{/if}>全部</option>
                                <option value="membername" {if $r_queryType == 'membername'}selected="selected" {/if} >用户名</option>
                                <option value="phone" {if $r_queryType == 'phone'} selected="selected" {/if}>电话</option>
                                <option value="SN" {if $r_queryType == 'SN'} selected="selected" {/if}>SN码</option>
                            </select>
                        </td>
                    </tr>
                    <tr class="search-submit">
                        <td colspan="2"><button class="btn btn-sm btn-primary"><i class="icon-search"></i> 搜索</button></td>
                    </tr>
			 	</tbody>
            </table>
        </form>
    </div>
	<p>
	     <a class="btn btn-sm btn-primary" href="javascript:location.reload()" id="refresh"><i class="icon-refresh"></i>刷新</a>
	     <button class="btn btn-sm btn-success" title="批量启用" id="enabled"><i class="icon-check-sign"></i>批量启用</button>
	     <button class="btn btn-sm btn-danger" title="批量停用" id="forbidden"><i class="icon-ban-circle"></i>批量停用</button>
    </p>
	<div class="rule">
	    <table class="table table-striped table-bordered table-hover">
		    <thead>
		        <tr>
		            <th class='with-checkbox'>
		                <input type="checkbox" class="check_all" /></th>
		            <th>名称</th>
		            <th>用户名</th>
		            <th>电话</th>
		            <th>SN码</th>
		            <th>SN码派发时间</th>
		            <th>使用时间</th>
		            <th>消费门店</th>
		            <th>消费金额/(元)</th>
		            <th>状态</th>
		            <th>操作</th>
		        </tr>
	        </thead>
	        <tbody>
	        	 {loop $r_detailList $row}
                 <tr>
                     <td class="with-checkbox">
                         <input type="checkbox" name="check" value="{$row['id']}"/>
                     </td>
                     <td>{$row['title']}</td>
                     <td>{$row['username']}</td>
                     <td>{$row['phone_no']}</td>
                     <td>{$row['sn']}</td>
                     <td>{$row['get_date']}</td>
                     <td>{$row['use_date']}</td>
                     <td>{if empty($row['shop_id'])}未知{else}{$shoplist[$row['shop_id']]}{/if}</td>
                     <td>0.00</td>
                     <td>
                         {if 0==$row['use_status']}
                         <span class="btn btn-info">未使用</span>
                         {/if}
                         {if 1==$row['use_status']}
                         <span class="btn btn-success">已使用</span>
                         {/if}
                     </td>
                     <td>
                         {if 0==$row['use_status']}
                         <a class="btn btn-danger use" data-codeid='19613' href='javascript:void(0)' title="立即使用" data-toggle="modal" data-target="#myModal2"><i class="icon-check"></i>立即使用</a>
                         {/if}
                     </td>
                 </tr>
                 {/loop}
	        </tbody>
	    </table>
	    <div>{$pager}</div>
	</div>
</div>

<div  class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    <form id="Form1" action="{php echo create_url('micromember/coupon', array('actType'=>'useoff','couponId'=>$r_couponId))}" method="post" class="form-horizontal ">
	    <input type="hidden" name="id" value="1425"/>
	    <input type="hidden" name="aid" value="33636"/>
	    <input type="hidden" name="usetype" value="2"/>
	      <div class="modal-header">
		      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	          <h4 class="modal-title"><i class="icon-check"></i>立即使用</h4>
	      </div>
	      <div class="modal-body">
	      	<div class="control-group" style="width:100%;margin:0 auto;text-align:center;">
	     	   消费金额：<input type="text" placeholder="金额" name="price" id="price" class="input-small" /> <span class="add-on"><i class="icon-cny"></i></span>
	          &nbsp;&nbsp;&nbsp;
	             消费类型： <select name="payment" class="input-small" style="width:110px;">
	                      <option value="0" >现金消费</option>
	                      <option value="1" >会员卡余额消费</option>
	                  </select>&nbsp;&nbsp;&nbsp;
	             消费门店：<select class="input-medium" name="shop_id">
	                      <option value="0">请选择消费门店</option>
	                      {if !empty($shops)}
	                      {loop $shops $shop}
	                      <option value="{$shop['id']}">{$shop['name']}</option>
	                      {/loop}
	                      {/if}
	                  </select>
	           </div>
	          <input type="hidden" id="codeid" name="codeid" />
	      </div>
	      <div class="modal-footer">
		      <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
	          <button type="submit" class="btn btn-sm btn-primary">提交</button>
	      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
    $(function () {
        $("tr").delegate(".use", "click", function () {
            $("#price").val("");
            $("#codeid").val($(this).attr("data-codeid"));
            $("#myModal2").modal("show");
        });
        $('#enabled').click(function(){
        	operation('enabled');
        });
		$('#forbidden').click(function(){
			operation('forbidden');
        });
    });
	function operation(op){
		var ids = '';
    	$('input[name="check"]:checked').each(function(){
    		ids += $(this).val() + ',';
    	});
    	if(ids == ''){
    		if(op == 'enabled') {alert('请选择要启用的记录');}
    		else if(op == 'forbidden') {alert('请选择要停用的记录');}
    		return false;
    	}
    	 $.ajax({
         	url:"{php echo create_url('micromember/coupon', array('actType'=>'public_ajax_switch','couponId'=>$r_couponId));}",
            type:'post',
            data:"ids="+ids+"&op="+op+"&date="+new Date().getTime(),
            dataType:'text',
	        success:function(data){
	        	data = $.trim(data);
            	if(data == 1) alert('启用成功！');
            	else if(data == 2) alert('禁用成功');
            	else alert('操作失败');
            	window.location = "{php echo create_url('micromember/coupon', array('actType'=>'detail','couponId'=>$r_couponId,'page'=>$pindex));}";
            	return true;
	        }
	  	});
	}
</script>
{template 'common/footer'}
